# Kotonoha Bot 環境変数設定ファイル
# このファイルをコピーして .env を作成し、実際の値を設定してください

# ============================================
# 必須設定
# ============================================

# Discord Bot Token
DISCORD_TOKEN=your_discord_bot_token_here

# Anthropic API キー
ANTHROPIC_API_KEY=your_anthropic_api_key_here

# LLM モデル（LiteLLM）
LLM_MODEL=anthropic/claude-opus-4-5
# LLM_MODEL=anthropic/claude-haiku-4-5          # 最速モデル
# LLM_MODEL=anthropic/claude-3-haiku-20240307   # 最安モデル
# LLM_MODEL=anthropic/claude-opus-4-5           # 最高品質モデル
# LLM_MODEL=anthropic/claude-sonnet-4-5         # バランス型モデル

# ============================================
# LLM 設定
# ============================================

# 温度パラメータ（0.0-1.0、高いほど創造的）
LLM_TEMPERATURE=0.7

# 最大トークン数
LLM_MAX_TOKENS=2048

# フォールバックモデル（メインモデルが失敗した場合）
# LLM_FALLBACK_MODEL=anthropic/claude-haiku-4-5

# リトライ設定（一時的なエラーに対するリトライ）
# LLM_MAX_RETRIES=3              # 最大リトライ回数（デフォルト: 3）
# LLM_RETRY_DELAY_BASE=1.0       # 指数バックオフのベース遅延（秒、デフォルト: 1.0）

# ============================================
# Bot 設定
# ============================================

# コマンドプレフィックス
BOT_PREFIX=!

# メッセージ最大長（未実装、将来の機能用）
# MESSAGE_MAX_LENGTH=2000

# ============================================
# セッション管理設定
# ============================================

# セッションのタイムアウト（時間）
# この時間以上アクティブでないセッションはメモリから削除されます
SESSION_TIMEOUT_HOURS=72

# メモリ内の最大セッション数
MAX_SESSIONS=100

# アクティブセッションタイムアウト（秒、将来の機能用）
# SESSION_TIMEOUT_ACTIVE=300

# アイドルセッションタイムアウト（秒、将来の機能用）
# SESSION_TIMEOUT_IDLE=1800

# 会話履歴の最大件数（将来の機能用）
# SESSION_HISTORY_LIMIT=50

# ============================================
# データベース設定（PostgreSQL）
# ============================================

# ⚠️ 重要: Phase 8以降ではPostgreSQLのみを使用します
# SQLiteはPhase 7までで使用されていましたが、Phase 8でPostgreSQLに完全移行しました
# 既存のSQLiteデータは破棄され、PostgreSQLが新規にセットアップされます
# 詳細: docs/implementation/phases/phase08.md

# PostgreSQL 接続設定
# 開発環境: DATABASE_URL を使用（パスワードを含む形式）
DATABASE_URL=postgresql://kotonoha:password@localhost:5432/kotonoha

# 本番環境推奨: パスワードを分離（シークレット管理）
# POSTGRES_HOST=postgres
# POSTGRES_PORT=5432
# POSTGRES_DB=kotonoha
# POSTGRES_USER=kotonoha
# POSTGRES_PASSWORD=<secret>

# 接続プール設定
DB_POOL_MIN_SIZE=5
DB_POOL_MAX_SIZE=20
DB_COMMAND_TIMEOUT=60

# ============================================
# 知識ベース設定（PostgreSQL + pgvector）
# ============================================

# halfvec使用フラグ（メモリ使用量50%削減、精度への影響は最小限）
KB_USE_HALFVEC=false

# HNSWインデックスパラメータ
KB_HNSW_M=16
KB_HNSW_EF_CONSTRUCTION=64

# 検索設定
KB_SIMILARITY_THRESHOLD=0.7
KB_DEFAULT_TOP_K=10

# Embedding処理設定
KB_EMBEDDING_MAX_RETRY=3
KB_EMBEDDING_BATCH_SIZE=100
KB_EMBEDDING_MAX_CONCURRENT=5
KB_EMBEDDING_INTERVAL_MINUTES=1

# チャンク登録・更新のバッチサイズ制御
# executemany のバッチサイズを制限することで、巨大なセッション（数百チャンク）でもメモリ使用量を制御できる
KB_CHUNK_INSERT_BATCH_SIZE=100
KB_CHUNK_UPDATE_BATCH_SIZE=100

# セッションアーカイブ設定
KB_ARCHIVE_THRESHOLD_HOURS=1
KB_ARCHIVE_BATCH_SIZE=10
KB_MIN_SESSION_LENGTH=30
# アーカイブ時ののりしろメッセージ数（会話の分断を防ぐため、最後のN件を短期記憶に残す）
# デフォルト: 5件
# 例: 50件のメッセージがある場合、45件を長期記憶にアーカイブし、最後の5件を短期記憶に残す
KB_ARCHIVE_OVERLAP_MESSAGES=5

# チャンク分割設定
# max_tokens=4000: OpenAI text-embedding-3-small の推奨入力長（8191トークン）の約半分
# これにより、API呼び出しの効率と検索精度のバランスを取る
KB_CHUNK_MAX_TOKENS=4000
# overlap_ratio=0.2: チャンク間の文脈を保持するための適切なオーバーラップ比率（20%）
# これにより、チャンク境界での情報の欠落を防ぐ
KB_CHUNK_OVERLAP_RATIO=0.2

# ============================================
# スレッド型機能設定
# ============================================

# スレッドの自動アーカイブ期間（分）
# 未設定の場合はサーバーのデフォルト値を使用
# 有効な値: 60 (1時間), 1440 (1日), 4320 (3日), 10080 (7日), 43200 (30日)
THREAD_AUTO_ARCHIVE_DURATION=1440

# ============================================
# 聞き耳型機能設定（オプション）
# ============================================

# 聞き耳型を有効にするチャンネルID（カンマ区切り）
# 例: EAVESDROP_ENABLED_CHANNELS=123456789012345678,987654321098765432
EAVESDROP_ENABLED_CHANNELS=

# 判定用モデル（軽量モデルを推奨）
# デフォルト: anthropic/claude-haiku-4-5
EAVESDROP_JUDGE_MODEL=anthropic/claude-sonnet-4-5

# 会話ログバッファサイズ（直近のメッセージ数）
EAVESDROP_BUFFER_SIZE=50

# 判定・応答生成に必要な最低メッセージ数（会話の流れを理解するため）
EAVESDROP_MIN_MESSAGES=3

# 介入の最小間隔（分）
# 前回の介入からこの時間が経過していない場合は再度介入しない
EAVESDROP_MIN_INTERVENTION_INTERVAL_MINUTES=10

# ============================================
# レート制限設定（Phase 6）
# ============================================

# レート制限の上限値（デフォルト: 50、1分間に50リクエストまで）
# RATE_LIMIT_CAPACITY=50

# 補充レート（リクエスト/秒、デフォルト: 0.8）
# 0.8リクエスト/秒 = 1分間に約48リクエスト
# RATE_LIMIT_REFILL=0.8

# 監視ウィンドウ（秒、デフォルト: 60）
# RATE_LIMIT_WINDOW=60

# 警告閾値（0.0-1.0、デフォルト: 0.9）
# レート制限の90%に達すると警告ログを出力します
# RATE_LIMIT_THRESHOLD=0.9

# ============================================
# ログ設定
# ============================================

# ログレベル（DEBUG, INFO, WARNING, ERROR, CRITICAL）
LOG_LEVEL=INFO

# ログファイルパス
LOG_FILE=./logs/run.log

# ログファイル最大サイズ（MB）
LOG_MAX_SIZE=10

# ログファイルバックアップ数
LOG_BACKUP_COUNT=5

# ============================================
# ヘルスチェック設定
# ============================================

# ヘルスチェック機能の有効化
HEALTH_CHECK_ENABLED=true

# ============================================
# デプロイ設定
# ============================================

# バックアップ保持日数
# BACKUP_RETENTION_DAYS=7

# ============================================
# CI/CD 設定
# ============================================

# GitHub リポジトリ名（owner/repo 形式）
GITHUB_REPOSITORY=your-username/repository-name

# GitHub Personal Access Token（GHCR 認証用）
GITHUB_USERNAME=your-github-username
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# ============================================
# Watchtower 設定
# ============================================

# Watchtower 自動更新の有効化
# 開発環境では false に設定して自動更新を無効化
# 本番環境では true（デフォルト）のまま
WATCHTOWER_ENABLED=true

# Docker API バージョン
# 設定しない場合は自動ネゴシエーション
# Docker 24.x 環境では 1.43 を指定
# DOCKER_API_VERSION=

# 古いイメージの自動削除
WATCHTOWER_CLEANUP=true

# イメージ更新チェック間隔（秒）
WATCHTOWER_POLL_INTERVAL=300

# ラベルで対象コンテナを制限
WATCHTOWER_LABEL_ENABLE=true

# 通知方法（shoutrrr は通知ライブラリの名前）
# Discord、Slack、Email、Telegram など様々な通知方法をサポート
WATCHTOWER_NOTIFICATIONS=shoutrrr

# Watchtower 通知 URL
#
# 通知方法の例:
# - Discord: discord://WEBHOOK_TOKEN@WEBHOOK_ID
# - Slack: slack://TOKEN@WORKSPACE/CHANNEL
# - Email: smtp://USERNAME:PASSWORD@SMTP_HOST:587/?from=FROM_EMAIL&to=TO_EMAIL
# - Telegram: telegram://BOT_TOKEN@telegram?chats=CHAT_ID
#
# ローカル開発環境ではコメントアウト（通知が送信されません）:
# WATCHTOWER_NOTIFICATION_URL=

# Watchtower スケジュール
# cron 形式で更新チェックのスケジュールを指定
# 例: 毎日午前3時 = "0 3 * * *"
# 指定しない場合は WATCHTOWER_POLL_INTERVAL が使用される
WATCHTOWER_SCHEDULE=

# Watchtower ローリング再起動
# true に設定すると、一度に 1 コンテナずつ更新（複数コンテナがある場合）
WATCHTOWER_ROLLING_RESTART=false
