# ============================================================================
# Kotonoha Bot 環境変数設定ファイル
# ============================================================================
# このファイルをコピーして .env を作成し、実際の値を設定してください
# cp .env.example .env
# ============================================================================

# ============================================================================
# 必須設定（起動に必要）
# ============================================================================

# Discord Bot Token（必須）
# Discord Developer Portal で取得: https://discord.com/developers/applications
DISCORD_TOKEN=your_discord_bot_token_here

# Anthropic API キー（必須）
# Claude API を使用するために必要
ANTHROPIC_API_KEY=your_anthropic_api_key_here

# OpenAI API キー（必須）
# Embedding処理に使用（text-embedding-3-small）
OPENAI_API_KEY=your_openai_api_key_here

# ============================================================================
# LLM 設定
# ============================================================================

# LLM モデル（Anthropic Claude）
# 推奨モデル:
#   - claude-opus-4-5      : 最高品質（本番環境推奨）
#   - claude-sonnet-4-5    : バランス型（開発・本番）
#   - claude-haiku-4-5     : 最速・低コスト（開発環境）
LLM_MODEL=claude-opus-4-5

# 温度パラメータ（0.0-1.0）
# 高いほど創造的、低いほど一貫性が高い（デフォルト: 0.7）
LLM_TEMPERATURE=0.7

# 最大トークン数（デフォルト: 2048）
LLM_MAX_TOKENS=2048

# フォールバックモデル（オプション）
# メインモデルが失敗した場合に使用
# LLM_FALLBACK_MODEL=claude-haiku-4-5

# リトライ設定（オプション、デフォルト値で動作）
# LLM_MAX_RETRIES=3                    # 最大リトライ回数（デフォルト: 3）
# LLM_RETRY_DELAY_BASE=1.0             # 指数バックオフのベース遅延（秒、デフォルト: 1.0）

# ============================================================================
# Bot 基本設定
# ============================================================================

# コマンドプレフィックス（デフォルト: !）
BOT_PREFIX=!

# ============================================================================
# セッション管理設定
# ============================================================================

# セッションタイムアウト（時間）
# この時間以上アクティブでないセッションはメモリから削除される（デフォルト: 72時間）
SESSION_TIMEOUT_HOURS=72

# メモリ内の最大セッション数（デフォルト: 100）
MAX_SESSIONS=100

# ============================================================================
# データベース設定（PostgreSQL）
# ============================================================================

# ⚠️ 重要: Phase 8以降ではPostgreSQLのみを使用
# SQLiteはPhase 7までで使用されていましたが、Phase 8でPostgreSQLに完全移行しました
# 詳細: docs/00_planning/phases/phase08.md

# 開発環境: 接続文字列を使用（パスワードを含む形式）
DATABASE_URL=postgresql://kotonoha:password@postgres:5432/kotonoha

# 本番環境推奨: パスワードを分離（シークレット管理）
# POSTGRES_HOST=postgres
# POSTGRES_PORT=5432
# POSTGRES_DB=kotonoha
# POSTGRES_USER=kotonoha
# POSTGRES_PASSWORD=<secret>

# 接続プール設定
DB_POOL_MIN_SIZE=5                     # 最小接続数（デフォルト: 5）
DB_POOL_MAX_SIZE=20                    # 最大接続数（デフォルト: 20）
DB_COMMAND_TIMEOUT=60                  # コマンドタイムアウト（秒、デフォルト: 60）

# ============================================================================
# 知識ベース設定（PostgreSQL + pgvector）
# ============================================================================

# HNSWインデックスパラメータ
KB_HNSW_M=16                           # HNSW m パラメータ（デフォルト: 16）
KB_HNSW_EF_CONSTRUCTION=64             # HNSW ef_construction パラメータ（デフォルト: 64）

# 検索設定
KB_SIMILARITY_THRESHOLD=0.7            # 類似度検索の閾値（デフォルト: 0.7）
KB_DEFAULT_TOP_K=10                    # デフォルトの検索結果数（デフォルト: 10）

# Embedding処理設定
KB_EMBEDDING_MAX_RETRY=3               # 最大リトライ回数（デフォルト: 3）
KB_EMBEDDING_BATCH_SIZE=100            # バッチサイズ（デフォルト: 100）
KB_EMBEDDING_MAX_CONCURRENT=5          # 最大同時処理数（デフォルト: 5）
KB_EMBEDDING_INTERVAL_MINUTES=1        # 処理間隔（分、デフォルト: 1）

# チャンク登録・更新のバッチサイズ
# 巨大なセッション（数百チャンク）でもメモリ使用量を制御
KB_CHUNK_INSERT_BATCH_SIZE=100         # チャンク登録バッチサイズ（デフォルト: 100）
KB_CHUNK_UPDATE_BATCH_SIZE=100         # チャンク更新バッチサイズ（デフォルト: 100）

# セッションアーカイブ設定
KB_ARCHIVE_THRESHOLD_HOURS=1           # アーカイブ対象となるセッションの最小経過時間（時間、デフォルト: 1）
KB_ARCHIVE_BATCH_SIZE=10               # アーカイブ処理のバッチサイズ（デフォルト: 10）
KB_ARCHIVE_INTERVAL_HOURS=1            # アーカイブ処理の実行間隔（時間、デフォルト: 1）
KB_MIN_SESSION_LENGTH=30               # アーカイブ対象となる最小セッション長（メッセージ数、デフォルト: 30）
KB_ARCHIVE_OVERLAP_MESSAGES=5          # アーカイブ時ののりしろメッセージ数（デフォルト: 5）
                                       # 例: 50件のメッセージがある場合、45件を長期記憶にアーカイブし、最後の5件を短期記憶に残す

# チャンク分割設定
KB_CHUNK_MAX_TOKENS=4000               # チャンクの最大トークン数（デフォルト: 4000）
                                       # OpenAI text-embedding-3-small の推奨入力長（8191トークン）の約半分
KB_CHUNK_OVERLAP_RATIO=0.2             # チャンク間のオーバーラップ比率（デフォルト: 0.2 = 20%）
                                       # チャンク境界での情報の欠落を防ぐ

# チャンク化戦略設定（会話履歴のチャンク化方法）
KB_CHAT_CHUNK_STRATEGY=message_based   # チャンク化戦略（デフォルト: message_based）
                                       # - message_based: メッセージ数ベース（推奨、会話の文脈を保持しやすい）
                                       # - token_based: トークン数ベース（将来の機能）
KB_CHAT_CHUNK_SIZE_MESSAGES=5          # メッセージ数ベースの場合のチャンクサイズ（デフォルト: 5）
KB_CHAT_CHUNK_OVERLAP_MESSAGES=2       # メッセージ数ベースの場合のオーバーラップ（デフォルト: 2）

# ============================================================================
# 機能別設定
# ============================================================================

# スレッド型機能設定
# スレッドの自動アーカイブ期間（分）
# 未設定の場合はサーバーのデフォルト値を使用
# 有効な値: 60 (1時間), 1440 (1日), 4320 (3日), 10080 (7日), 43200 (30日)
THREAD_AUTO_ARCHIVE_DURATION=1440

# 聞き耳型機能設定（オプション）
# 聞き耳型を有効にするチャンネルID（カンマ区切り）
# 例: EAVESDROP_ENABLED_CHANNELS=123456789012345678,987654321098765432
EAVESDROP_ENABLED_CHANNELS=

# 判定用モデル（軽量モデルを推奨、デフォルト: claude-haiku-4-5）
EAVESDROP_JUDGE_MODEL=claude-sonnet-4-5

# 会話ログバッファサイズ（直近のメッセージ数、デフォルト: 50）
EAVESDROP_BUFFER_SIZE=50

# 判定・応答生成に必要な最低メッセージ数（デフォルト: 3）
EAVESDROP_MIN_MESSAGES=3

# 介入の最小間隔（分、デフォルト: 10）
# 前回の介入からこの時間が経過していない場合は再度介入しない
EAVESDROP_MIN_INTERVENTION_INTERVAL_MINUTES=10

# レート制限設定（オプション、デフォルト値で動作）
# RATE_LIMIT_CAPACITY=50               # レート制限の上限値（デフォルト: 50、1分間に50リクエストまで）
# RATE_LIMIT_REFILL=0.8                # 補充レート（リクエスト/秒、デフォルト: 0.8 = 1分間に約48リクエスト）
# RATE_LIMIT_WINDOW=60                 # 監視ウィンドウ（秒、デフォルト: 60）
# RATE_LIMIT_THRESHOLD=0.9             # 警告閾値（0.0-1.0、デフォルト: 0.9）
                                       # レート制限の90%に達すると警告ログを出力

# ============================================================================
# 運用設定
# ============================================================================

# ログ設定
LOG_LEVEL=INFO                         # ログレベル（DEBUG, INFO, WARNING, ERROR, CRITICAL、デフォルト: INFO）
LOG_FILE=./logs/run.log                # ログファイルパス（デフォルト: ./logs/run.log）
LOG_MAX_SIZE=10                        # ログファイル最大サイズ（MB、デフォルト: 10）
LOG_BACKUP_COUNT=5                     # ログファイルバックアップ数（デフォルト: 5）

# ヘルスチェック設定
HEALTH_CHECK_ENABLED=true              # ヘルスチェック機能の有効化（デフォルト: true）
HEALTH_CHECK_PORT=8080                 # ヘルスチェックポート（docker-compose.yml と一致させる必要がある、デフォルト: 8080）

# ============================================================================
# デプロイ設定
# ============================================================================

# バックアップ保持日数（オプション）
# BACKUP_RETENTION_DAYS=7

# CI/CD 設定（GitHub Actions / GHCR 認証用）
GITHUB_REPOSITORY=your-username/repository-name
GITHUB_USERNAME=your-github-username
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# ============================================================================
# Watchtower 設定（Docker コンテナ自動更新）
# ============================================================================

# Watchtower 自動更新の有効化
# 開発環境では false に設定して自動更新を無効化
# 本番環境では true（デフォルト）のまま
WATCHTOWER_ENABLED=true

# Docker API バージョン（オプション）
# 設定しない場合は自動ネゴシエーション
# Docker 24.x 環境では 1.43 を指定
# DOCKER_API_VERSION=

# 古いイメージの自動削除（デフォルト: true）
WATCHTOWER_CLEANUP=true

# イメージ更新チェック間隔（秒、デフォルト: 300 = 5分）
WATCHTOWER_POLL_INTERVAL=300

# ラベルで対象コンテナを制限（デフォルト: true）
WATCHTOWER_LABEL_ENABLE=true

# 通知方法（shoutrrr は通知ライブラリの名前）
# Discord、Slack、Email、Telegram など様々な通知方法をサポート
WATCHTOWER_NOTIFICATIONS=shoutrrr

# Watchtower 通知 URL（オプション）
# ローカル開発環境ではコメントアウト（通知が送信されません）
# 通知方法の例:
#   - Discord: discord://WEBHOOK_TOKEN@WEBHOOK_ID
#   - Slack: slack://TOKEN@WORKSPACE/CHANNEL
#   - Email: smtp://USERNAME:PASSWORD@SMTP_HOST:587/?from=FROM_EMAIL&to=TO_EMAIL
#   - Telegram: telegram://BOT_TOKEN@telegram?chats=CHAT_ID
# WATCHTOWER_NOTIFICATION_URL=

# Watchtower スケジュール（オプション）
# cron 形式で更新チェックのスケジュールを指定
# 例: 毎日午前3時 = "0 3 * * *"
# 指定しない場合は WATCHTOWER_POLL_INTERVAL が使用される
# WATCHTOWER_SCHEDULE=

# Watchtower ローリング再起動（デフォルト: false）
# true に設定すると、一度に 1 コンテナずつ更新（複数コンテナがある場合）
WATCHTOWER_ROLLING_RESTART=false

# ============================================================================
# pgAdmin 設定（開発環境のみ、オプション）
# ============================================================================

# ⚠️ 重要: 本番環境では設定しないこと
# 開発環境でのみ使用する場合、以下の環境変数のコメントを外して設定してください
# 強力なパスワードを設定すること（推奨: 20文字以上、英数字+記号）

# pgAdminログイン用メールアドレス
# 注意: .localドメインも使用可能ですが、有効なメールアドレス形式（例: admin@example.com）を推奨
# PGADMIN_EMAIL=admin@example.com

# pgAdminログイン用パスワード（強力なパスワードを設定すること）
# PGADMIN_PASSWORD=your_strong_password_here

# pgAdminポートバインディング設定（オプション）
# デフォルト: 127.0.0.1（ローカルホストのみ、セキュア）
# 同一LAN内からアクセスする場合: 0.0.0.0
# ⚠️ セキュリティ警告: 0.0.0.0 に設定する場合は強力なパスワードを必須とすること
# 本番環境では使用しないこと
# PGADMIN_BIND_ADDRESS=127.0.0.1
