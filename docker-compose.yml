# Kotonoha Discord Bot - Docker Compose (with Watchtower)

services:
  postgres:
    build:
      context: .
      dockerfile: Dockerfile.postgres
    image: kotonoha-postgres:pg18-pgvector0.8.1-pgbigm1.2
    container_name: kotonoha-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-kotonoha}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-kotonoha}
    volumes:
      - postgres_data:/var/lib/postgresql
    networks:
      - kotonoha-network
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-kotonoha}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  kotonoha:
    build:
      context: .
      dockerfile: Dockerfile.kotonoha
    image: ghcr.io/${GITHUB_REPOSITORY:-your-username/kotonoha-bot}:latest
    container_name: kotonoha-bot
    restart: unless-stopped
    user: root
    stop_grace_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env
    volumes:
      - ./logs:/app/logs
      - ./backups:/app/backups
    networks:
      - kotonoha-network
    ports:
      - "127.0.0.1:8081:8080"
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health', timeout=5).read()" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    labels:
      - "com.centurylinklabs.watchtower.enable=${WATCHTOWER_ENABLED:-true}"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - .env
    environment:
      - DOCKER_API_VERSION=${DOCKER_API_VERSION:-}
      - WATCHTOWER_CLEANUP=${WATCHTOWER_CLEANUP:-true}
      - WATCHTOWER_POLL_INTERVAL=${WATCHTOWER_POLL_INTERVAL:-300}
      - WATCHTOWER_LABEL_ENABLE=${WATCHTOWER_LABEL_ENABLE:-true}
      - WATCHTOWER_NOTIFICATIONS=${WATCHTOWER_NOTIFICATIONS:-shoutrrr}
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
    networks:
      - kotonoha-network

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: kotonoha-pgadmin
    restart: unless-stopped
    profiles:
      - pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:?pgAdmin email is required}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:?pgAdmin password is required}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
      PGADMIN_CONFIG_CHECK_EMAIL_DELIVERABILITY: 'False'
    user: root
    volumes:
      - ./pgadmin:/var/lib/pgadmin
    entrypoint: >
      sh -c " mkdir -p /var/lib/pgadmin/sessions /var/lib/pgadmin/storage /var/lib/pgadmin/azurecredentialcache || true && chmod -R 777 /var/lib/pgadmin || true && /entrypoint.sh "
    networks:
      - kotonoha-network
    ports:
      - "${PGADMIN_BIND_ADDRESS:-127.0.0.1}:5050:80"
    depends_on:
      postgres:
        condition: service_healthy

  # テスト用PostgreSQLサービス
  # 使用方法: docker-compose --profile test up postgres-test
  postgres-test:
    build:
      context: .
      dockerfile: Dockerfile.postgres
    image: kotonoha-postgres:pg18-pgvector0.8.1-pgbigm1.2
    container_name: kotonoha-postgres-test
    restart: unless-stopped
    profiles:
      - test
    environment:
      POSTGRES_USER: ${TEST_POSTGRES_USER:-test}
      POSTGRES_PASSWORD: ${TEST_POSTGRES_PASSWORD:-test}
      POSTGRES_DB: ${TEST_POSTGRES_DB:-test_kotonoha}
    volumes:
      - postgres_test_data:/var/lib/postgresql
    networks:
      - kotonoha-network
    ports:
      - "127.0.0.1:${TEST_POSTGRES_PORT:-5433}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${TEST_POSTGRES_USER:-test} -d ${TEST_POSTGRES_DB:-test_kotonoha}" ]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  kotonoha-network:
    driver: bridge

volumes:
  postgres_data:
  postgres_test_data:
