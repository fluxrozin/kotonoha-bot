# Kotonoha Discord Bot - Docker Compose
# NAS (Synology) デプロイ用設定

services:
  kotonoha-bot:
    # ローカルビルドの場合
    build:
      context: .
      dockerfile: Dockerfile
    # GHCR からプルする場合（CI/CD 設定後に有効化）
    # image: ghcr.io/${GITHUB_REPOSITORY:-your-username/kotonoha-bot}:latest

    container_name: kotonoha-bot
    restart: unless-stopped

    # rootで起動してパーミッション修正後にユーザーを切り替える
    # entrypoint.shが自動的にパーミッションを修正し、botuserに切り替えます
    user: root

    # 環境変数ファイル
    env_file:
      - .env

    # ボリュームマウント（データの永続化）
    # 注意: 初回起動前に、ホスト側でディレクトリを作成してください
    # docker compose up する前に以下を実行:
    #   mkdir -p data logs backups
    #
    # パーミッションについて:
    # コンテナはrootで起動され、entrypoint.shが自動的にパーミッションを修正します。
    # 通常は手動でのパーミッション設定は不要ですが、自動修正が失敗する場合は
    # 以下のいずれかを実行してください:
    #   方法1: chmod 775 data logs backups
    #   方法2: sudo chown -R 1000:1000 data logs backups
    volumes:
      # データベース（必須）
      - ./data:/app/data
      # ログ（オプション - LOG_FILE が設定されている場合のみ必要）
      - ./logs:/app/logs
      # バックアップ（オプション）
      - ./backups:/app/backups

    # ネットワーク設定
    networks:
      - kotonoha-network

    # ヘルスチェック用ポート（オプション）
    # ports:
    #   - "8080:8080"

    # リソース制限
    # 注意: CPU CFS未サポートのNAS環境では、deployセクション全体をコメントアウトしてください
    # リソース制限が必要な場合は、Container ManagerのGUIから設定してください
    # deploy:
    #   resources:
    #     limits:
    #       cpus: "1.0"
    #       memory: 512M
    #     reservations:
    #       cpus: "0.25"
    #       memory: 128M

    # ヘルスチェック
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    # ログ設定
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Watchtower（自動更新）- オプション
  # CI/CD 設定後に有効化
  # watchtower:
  #   image: containrrr/watchtower
  #   container_name: watchtower
  #   restart: unless-stopped
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     # GHCR 認証用（プライベートリポジトリの場合）
  #     # - ~/.docker/config.json:/config.json:ro
  #   environment:
  #     - WATCHTOWER_CLEANUP=true
  #     - WATCHTOWER_POLL_INTERVAL=300
  #     - WATCHTOWER_INCLUDE_STOPPED=false
  #     - WATCHTOWER_LABEL_ENABLE=true
  #   networks:
  #     - kotonoha-network
  #   labels:
  #     - "com.centurylinklabs.watchtower.enable=false"

networks:
  kotonoha-network:
    driver: bridge
