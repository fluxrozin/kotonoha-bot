# WBS（作業分解構造）

Kotonoha（コトノハ）Discord ボット開発プロジェクト

## 1. プロジェクト管理

### 1.1 プロジェクト計画

- 要件定義書作成
- 実装検討事項整理
- WBS 作成
- スケジュール策定

### 1.2 環境構築

- 開発環境セットアップ（WSL2 Ubuntu）
- Git リポジトリ初期化
- プロジェクト構造作成

## 2. Phase 1: 基盤実装

### 2.1 Discord ボット基盤

#### 2.1.1 基本セットアップ

- discord.py のインストール
- Bot トークンの取得と設定
- 基本的な Bot クラスの作成
- `on_ready` イベントの実装
- `on_message` イベントの実装

#### 2.1.2 メッセージルーティング基盤

- Message Router モジュールの作成
- メンション検知機能
- スレッド判定機能
- DM 判定機能
- 聞き耳型判定機能（基本）

### 2.2 AI サービス基盤

#### 2.2.1 抽象化インターフェース

- AI プロバイダー抽象クラスの設計
- 共通インターフェースの定義
- エラーハンドリング基盤

#### 2.2.2 Gemini API 実装

- Google AI SDK のインストール
- Gemini 1.5 Flash の実装
- Gemini 1.5 Pro の実装
- API キーの管理
- 基本的なリクエスト/レスポンス処理

#### 2.2.3 API 使い分けロジック

- タスク複雑度判定ロジック
- Flash/Pro 自動選択機能
- フォールバック機能（基本）

### 2.3 会話機能（基本）

#### 2.3.1 メンション応答型の実装

- メンション検知時の応答処理
- 基本的な会話ループ
- プロンプト生成（基本）

#### 2.3.2 システムプロンプト設計

- 場面緘黙支援向けプロンプト作成
- プロンプトテンプレートの実装
- 動的プロンプト生成機能

### 2.4 データベース基盤

#### 2.4.1 SQLite セットアップ

- データベースファイルの作成
- スキーマ設計
- テーブル作成（sessions、messages）
- インデックス作成

#### 2.4.2 データベース操作モジュール

- 接続管理
- CRUD 操作の実装
- トランザクション処理
- エラーハンドリング

### 2.5 セッション管理（基本）

#### 2.5.1 ChatSession クラス設計

- セッションクラスの定義
- 会話履歴の管理
- セッションキーの生成

#### 2.5.2 セッション管理モジュール

- メモリ内セッション管理
- セッションの作成・取得・更新
- 基本的なライフサイクル管理

### 2.6 コンテナ化

#### 2.6.1 Dockerfile 作成

- Python 3.14 ベースイメージ
- 依存関係のインストール
- 非 root ユーザー設定
- ヘルスチェック設定

#### 2.6.2 Docker 設定

- ボリュームマウント設定
- 環境変数の設定
- リソース制限設定

### 2.7 エラーハンドリング（基本）

#### 2.7.1 エラークラス定義

- カスタムエラークラス
- エラーメッセージテンプレート

#### 2.7.2 基本的なエラー処理

- API エラーの捕捉
- ユーザー向けエラーメッセージ
- ログ出力（基本）

## 3. Phase 2: 機能拡張

### 3.1 会話履歴管理（ハイブリッド）

#### 3.1.1 ChatSession と SQLite の同期

- 同期インターフェースの実装
- リアルタイム同期機能
- バッチ同期機能
- 同期エラーハンドリング

#### 3.1.2 セッション復元機能

- ボット再起動時のセッション復元
- SQLite からの履歴読み込み
- メモリへの復元処理

#### 3.1.3 セッションライフサイクル管理

- タイムアウト処理
- 自動保存機能
- 自動削除機能
- 定期的なクリーンアップタスク

### 3.2 会話の契機の完全実装

#### 3.2.1 スレッド型の実装

- メンション検知時の自動スレッド作成
- スレッド名の生成
- スレッド内での会話継続（メンション不要）
- スレッドアーカイブ検知
- アーカイブ時のセッション保存

#### 3.2.2 DM 型の実装

- DM チャンネル判定
- DM 専用セッション管理
- DM での会話継続

#### 3.2.3 聞き耳型の実装

##### 3.2.3.1 アプローチ 1: LLM 判断機能

- 会話ログの一時保存機能
- 判定フェーズ（裁判官）の実装
  - Gemini Flash による判定
  - Yes/No 判定ロジック
- 発言生成フェーズ（演者）の実装
  - YES 判定時の応答生成
  - メインチャンネルへの投稿
- 判定用プロンプトの最適化
  - プロンプトテンプレート作成
  - テストと調整

##### 3.2.3.2 アプローチ 2: ルールベース判断機能

- キーワード検知機能
- 盛り上がり検知機能
- ランダム判定機能
- 確率設定の実装

##### 3.2.3.3 聞き耳型共通機能

- 会話ログの一時保存（直近 10〜20 件）
- チャンネルごとの有効/無効設定
- メインチャンネルへの直接投稿機能

#### 3.2.4 統一インターフェース

- 4 つの方式を統一的に扱うインターフェース
- セッションキーの統一管理
- 共通処理の実装

### 3.3 エラーハンドリングの強化

#### 3.3.1 API エラー処理

- Gemini API エラーの詳細処理
  - 429 エラー（レート制限）
  - 400 エラー（無効なリクエスト）
  - 500 エラー（サーバーエラー）
  - 503 エラー（サービス利用不可）
- Discord API エラー処理
  - 403 エラー（権限不足）
  - 404 エラー（リソース未找到）
  - 429 エラー（レート制限）

#### 3.3.2 リトライロジック

- 指数バックオフ実装
- 最大リトライ回数の設定
- フォールバック処理

#### 3.3.3 エラーメッセージの改善

- 場面緘黙支援向けエラーメッセージ
- エラーメッセージテンプレート
- ユーザーフレンドリーな表現

### 3.4 レート制限対応

#### 3.4.1 レート制限モニタリング

- Gemini API レート制限の監視
- Discord API レート制限の監視
- 使用率の計算と警告

#### 3.4.2 レート制限実装

- トークンバケットアルゴリズム
- リクエストキューイング
- 優先度管理

#### 3.4.3 レート制限対策

- リクエスト数の制御
- 待機処理の実装
- エラーハンドリング

### 3.5 コマンド機能

#### 3.5.1 スラッシュコマンド実装

- `/chat start` コマンド
  - スレッド型開始
  - スレッド作成処理
- `/chat reset` コマンド
  - 会話履歴リセット
  - セッションクリア

#### 3.5.2 コマンド処理基盤

- コマンド登録
- コマンドパーサー
- コマンドエラーハンドリング

### 3.6 CI/CD パイプライン

#### 3.6.1 GitHub Actions ワークフロー

- ワークフローファイル作成
- Docker イメージビルド
- テスト実行（将来の拡張）
- GHCR へのプッシュ

#### 3.6.2 Docker イメージ管理

- イメージタグ付け
- マルチステージビルド（最適化）
- イメージサイズの最適化

#### 3.6.3 自動デプロイ設定

- Watchtower の設定
- Synology NAS での動作確認
- 自動更新のテスト

## 4. Phase 3: 最適化・運用

### 4.1 複数 API 対応

#### 4.1.1 フォールバック機能

- 複数 API プロバイダーの実装
- フォールバックロジック
- API 切り替え機能

#### 4.1.2 API プロバイダー追加

- Groq API 実装（オプション）
- Hugging Face API 実装（オプション）

### 4.2 パフォーマンス最適化

#### 4.2.1 メモリ最適化

- LRU キャッシュの実装
- セッション数の制限
- メモリ使用量の監視

#### 4.2.2 非同期処理の最適化

- 並行処理の実装
- タスク管理の最適化
- ボトルネックの特定と改善

#### 4.2.3 データベース最適化

- クエリ最適化
- インデックスの見直し
- バッチ処理の最適化

### 4.3 ログ機能

#### 4.3.1 ログシステム実装

- ログレベルの設定
- ログフォーマットの定義
- ログ出力先の設定

#### 4.3.2 ログ管理

- ログファイルのローテーション
- ログの保存期間設定
- ログ分析機能（基本）

### 4.4 設定機能

#### 4.4.1 設定管理システム

- 設定の階層化
- 環境変数との統合
- データベース設定（将来の拡張）

#### 4.4.2 設定 UI（将来の拡張）

- コマンドによる設定変更
- チャンネルごとの設定

### 4.5 モニタリング機能

#### 4.5.1 メトリクス収集

- パフォーマンス指標
- エラー指標
- 使用量指標

#### 4.5.2 アラート設定

- アラート条件の定義
- アラート通知機能
- Discord チャンネルへの通知

### 4.6 データベースバックアップ

#### 4.6.1 バックアップスクリプト

- 自動バックアップ機能
- バックアップスケジュール
- バックアップファイル管理

#### 4.6.2 バックアップ検証

- バックアップの整合性チェック
- リストアテスト

### 4.7 ヘルスチェック

#### 4.7.1 ヘルスチェックエンドポイント

- Liveness プローブ
- Readiness プローブ
- ヘルスチェックロジック

#### 4.7.2 監視統合

- Docker ヘルスチェック統合
- 外部監視ツールとの連携（将来の拡張）

## 5. テスト

### 5.1 単体テスト

#### 5.1.1 セッション管理テスト

- セッション作成・更新・削除
- セッションキーの生成
- ライフサイクル管理

#### 5.1.2 メッセージルーティングテスト

- 4 つの会話の契機の判定
- ルーティングロジック

#### 5.1.3 AI サービステスト

- プロンプト生成
- API 呼び出し（モック）
- エラーハンドリング

#### 5.1.4 データベーステスト

- CRUD 操作
- トランザクション
- エラー処理

### 5.2 統合テスト

#### 5.2.1 Discord API 統合テスト

- メッセージ送受信
- スレッド作成
- DM 処理

#### 5.2.2 Gemini API 統合テスト

- API 呼び出し
- レスポンス処理
- エラー処理

#### 5.2.3 セッション管理統合テスト

- メモリと SQLite の同期
- セッション復元

### 5.3 エンドツーエンドテスト

#### 5.3.1 会話フローテスト

- メンション応答型の完全フロー
- スレッド型の完全フロー
- DM 型の完全フロー
- 聞き耳型の完全フロー

#### 5.3.2 エラーシナリオテスト

- API エラー時の動作
- レート制限時の動作
- データベースエラー時の動作

## 6. ドキュメント

### 6.1 技術ドキュメント

- アーキテクチャドキュメント
- API ドキュメント
- データベーススキーマドキュメント

### 6.2 運用ドキュメント

- デプロイメント手順
- トラブルシューティングガイド
- バックアップ・リストア手順

### 6.3 ユーザードキュメント

- Bot の使い方
- コマンド一覧
- FAQ

## 7. デプロイメント

### 7.1 本番環境準備

- Synology NAS の設定確認
- Docker 環境の確認
- ネットワーク設定

### 7.2 初回デプロイ

- Docker イメージのプッシュ
- コンテナの起動
- 動作確認

### 7.3 運用開始

- モニタリング開始
- ログ確認
- パフォーマンス確認

---

**作成日**: 2024 年
**バージョン**: 1.0
**作成者**: kotonoha-bot 開発チーム
