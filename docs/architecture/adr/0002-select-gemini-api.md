# ADR-0002: Gemini API の選定

**ステータス**: Accepted

**日付**: 2026-01-14

**決定者**: kotonoha-bot 開発チーム

## コンテキスト

場面緘黙自助グループ運営支援のための Discord Bot に、無料で利用可能なチャット AI 機能を統合する必要がある。プロジェクトの制約として、**無料で利用可能な API**のみを使用することが必須要件となっている。

## 決定

**Google Gemini API**（Gemini 1.5 Flash と Gemini 1.5 Pro）を採用する。

- **Gemini 1.5 Flash**: 高速応答用（通常の会話、聞き耳型の判定）
- **Gemini 1.5 Pro**: 高度なタスク用（複雑な質問、深い推論が必要な場合）

## 理由

### 1. 無料枠が実用的

- **Flash**: 1 分あたり 15 リクエスト、1 日あたり 1,500 リクエスト
- **Pro**: 1 分あたり 2 リクエスト、1 日あたり 50 リクエスト
- 無料枠内で実用的な運用が可能

### 2. 2 つのモデルの使い分けが可能

- 高速応答が必要な場面では Flash
- 高品質な応答が必要な場面では Pro
- コストと品質のバランスを取れる

### 3. 日本語対応が良好

- 場面緘黙支援は日本語での自然な会話が重要
- Gemini は日本語の品質が高い

### 4. 長いコンテキストウィンドウ

- 最大 1M トークンのコンテキストウィンドウ
- 長い会話履歴を保持できる
- 場面緘黙支援では段階的な会話が重要

### 5. Google の安定したインフラ

- 高可用性
- 低レイテンシ
- 信頼性が高い

## 代替案

### 代替案 A: OpenAI API (GPT-3.5-turbo)

**メリット**:

- 最も高品質な応答
- 豊富なドキュメントとコミュニティサポート
- 安定した API

**デメリット**:

- 無料枠は期間限定（新規アカウントで$5、期限あり）
- 無料期間終了後は有料
- レート制限が厳しい

**採用しなかった理由**:

- **必須要件である「無料で利用可能」を満たさない**
- 無料期間終了後に運用できなくなるリスク

---

### 代替案 B: Groq API

**メリット**:

- 非常に高速（GPU 加速）
- 無料枠が比較的広い（1 日 14,400 リクエスト）
- オープンソースモデル（Llama、Mixtral）

**デメリット**:

- 応答品質はモデル依存
- 比較的新しいサービス（安定性が不明）
- 日本語対応の品質が不明

**採用しなかった理由**:

- 日本語での応答品質が未検証
- 場面緘黙支援には高品質な日本語応答が必須
- サービスの安定性が未知数

---

### 代替案 C: Hugging Face Inference API

**メリット**:

- 完全無料（月 30,000 リクエスト）
- 多様なモデルから選択可能
- オープンソース

**デメリット**:

- モデルによって品質にばらつき
- レート制限がやや厳しい
- セルフホスティングの複雑さ

**採用しなかった理由**:

- 品質の一貫性が保証されない
- レート制限が厳しく、実用性に疑問
- セットアップの複雑さ

---

### 代替案 D: Ollama（ローカル実行）

**メリット**:

- 完全無料（コストゼロ）
- プライバシー保護（データが外部に送信されない）
- レート制限なし
- オフライン動作可能

**デメリット**:

- サーバーリソースが必要（GPU または高性能 CPU）
- Synology NAS のリソースでは不十分
- セットアップが複雑
- 応答速度がハードウェア依存

**採用しなかった理由**:

- **Synology DS1823xs+のリソースでは不十分**
- AMD Ryzen V1780B は AVX 対応だが、GPU なし
- リアルタイム応答に必要な性能が得られない可能性
- 将来的な選択肢として保留

---

## 結果

### メリット

1. **実用的な無料枠**: 小〜中規模のコミュニティで十分に運用可能
2. **柔軟な使い分け**: Flash/Pro の使い分けでコストと品質を最適化
3. **高品質な日本語**: 場面緘黙支援に必要な自然で優しい応答が可能
4. **長期的な安定性**: Google のインフラで信頼性が高い
5. **開発の容易さ**: 公式 SDK が充実、ドキュメントが豊富

### デメリット

1. **レート制限**: Flash 15 回/分（1,500 回/日）、Pro 2 回/分（50 回/日）の制限
2. **無料枠の制限**: 将来的に制限が変更される可能性
3. **ベンダーロックイン**: Google のサービスに依存

### トレードオフ

- **コスト vs 品質**: 無料枠内で高品質な応答を実現（Flash の活用）
- **速度 vs 品質**: Flash で速度、Pro で品質を確保
- **依存 vs 柔軟性**: Gemini に依存するが、抽象化レイヤーで将来の切り替えを可能に

### 実装への影響

1. **抽象化インターフェースの実装**: 将来的に他の API に切り替え可能にする
2. **レート制限対策**: トークンバケットアルゴリズムで制限を管理
3. **Flash/Pro 使い分けロジック**: タスクの複雑度に応じて自動選択
4. **フォールバック機能**: 将来的に複数 API プロバイダーに対応

## 参考資料

- [Gemini API Documentation](https://ai.google.dev/docs)
- [Gemini API Pricing](https://ai.google.dev/pricing)
- [middleware-selection.md](../../implementation/middleware-selection.md)
- [requirements overview](../../requirements/overview.md)

---

**作成日**: 2026年1月14日 1 月 15 日
**最終更新日**: 2026年1月14日 1 月 15 日
