# ADR-0002: LiteLLM によるマルチ LLM プロバイダー戦略

**ステータス**: Accepted

**日付**: 2026-01-14

**決定者**: kotonoha-bot 開発チーム

## コンテキスト

場面緘黙自助グループ運営支援のための Discord Bot に、チャット AI 機能を統合する必要がある。開発から本番までの各フェーズで異なる要件があり、コスト効率と品質のバランスを取る必要がある。

## 決定

**LiteLLM** を使用して、開発フェーズに応じた複数の LLM プロバイダーを切り替える戦略を採用する。

### フェーズ別モデル構成

| フェーズ     | プロバイダー | モデル                     | 用途                       |
| ------------ | ------------ | -------------------------- | -------------------------- |
| **開発**     | Anthropic    | Claude 3 Haiku（レガシー） | 超低コストでの開発・テスト |
| **最終調整** | Anthropic    | Claude Sonnet 4.5          | 品質調整・プロンプト最適化 |
| **本番**     | Anthropic    | Claude Opus 4.5            | 最高品質の本番運用         |

### LiteLLM の採用

- **統一インターフェース**: 異なるプロバイダーを同一の API で利用可能
- **簡単な切り替え**: 環境変数の変更のみでプロバイダー切り替え
- **フォールバック**: プロバイダー障害時の自動切り替え
- **コスト管理**: 使用量の追跡とコスト最適化

## 理由

### 1. 開発コストの最適化

- **開発フェーズ**: Claude 3 Haiku（レガシー）を活用
  - **料金**: 入力 $1/100 万トークン、出力 $5/100 万トークン
  - **コスト**: 1 回あたり約 0.3 セント（入力 500 トークン、出力 500 トークンの場合）
  - **月間コスト例**: 1,000 回で約$3（約 450 円）、5,000 回で約$15（約 2,250 円）
  - **メリット**: 無料枠の制限がなく、開発から本番まで同じプロバイダーで統一可能
- **本番フェーズ**: Claude Opus 4.5 で最高品質を提供
- **段階的な品質向上**: 開発（Haiku）→ 調整（Sonnet）→ 本番（Opus）で品質を段階的に向上

### 2. LiteLLM による柔軟性

- プロバイダー固有の SDK 依存を排除
- 将来的なプロバイダー追加が容易
- 統一されたエラーハンドリング
- ストリーミング対応

### 3. 各モデルの特性

#### Claude 3 Haiku（レガシー・開発用）

- 低コスト・高速
  - 入力: $1/100 万トークン、出力: $5/100 万トークン
  - 1 回あたり約 0.3 セント（入力 500 トークン、出力 500 トークンの場合）
  - 月 1,000 回で約$3（約 450 円）と非常に低コスト
- Sonnet 4 と近いコーディング性能
- 日本語対応が優秀
- 開発から本番まで同じプロバイダーで統一可能
- 無料枠の制限がない

#### Claude Sonnet 4.5（調整用）

- 高品質な日本語応答
- 開発と本番の中間コスト
- プロンプト最適化に最適

#### Claude Opus 4.5（本番用）

- 最高品質の応答
- 場面緘黙支援に必要な繊細な表現
- 長いコンテキストウィンドウ

### 4. 日本語対応

- **Claude モデル**: 日本語の品質が非常に高い
- **場面緘黙支援**: 繊細で優しい日本語表現が必須
- **Claude Haiku**: 開発段階でも高品質、日本語対応が優秀

## 代替案

### 代替案 A: Gemini API のみ

**メリット**:

- 無料枠で運用可能
- シンプルな構成

**デメリット**:

- 品質の上限がある
- 場面緘黙支援に必要な繊細さが不足

**採用しなかった理由**:

- 本番環境では最高品質が必要
- Claude の方が日本語の繊細な表現に優れている

---

### 代替案 B: Claude API のみ

**メリット**:

- 最高品質の一貫した応答
- シンプルな構成

**デメリット**:

- 開発段階でもコストが発生
- 開発効率が低下

**採用しなかった理由**:

- 開発段階での無料枠活用ができない
- コスト効率が悪い

---

### 代替案 C: プロバイダー固有 SDK の直接使用

**メリット**:

- 各プロバイダーの全機能にアクセス可能
- 依存関係が少ない

**デメリット**:

- プロバイダー切り替えにコード変更が必要
- 複数の SDK の学習・保守が必要

**採用しなかった理由**:

- LiteLLM による統一インターフェースの方が保守性が高い
- フェーズ別切り替えが煩雑になる

---

## 結果

### メリット

1. **コスト最適化**: 開発は無料、本番のみ有料
2. **品質の段階的向上**: 開発 → 調整 → 本番で品質向上
3. **柔軟な切り替え**: 環境変数のみでプロバイダー変更
4. **フォールバック**: 障害時の自動切り替え
5. **統一インターフェース**: コードの保守性向上

### デメリット

1. **本番コスト**: Claude Opus 4.5 は有料
2. **依存関係**: LiteLLM への依存
3. **設定の複雑さ**: 複数プロバイダーの設定管理

### トレードオフ

- **コスト vs 品質**: 開発は無料、本番は品質優先で有料
- **シンプルさ vs 柔軟性**: LiteLLM 導入で複雑さ増加、柔軟性向上
- **統一 vs 最適化**: 統一インターフェースで一部機能が制限される可能性

### 実装への影響

1. **LiteLLM の導入**: `litellm` パッケージの追加
2. **環境変数設計**: フェーズ別の設定切り替え
3. **抽象化レイヤー**: LiteLLM をラップした AI サービスクラス
4. **フォールバック設定**: プロバイダー障害時の対応

## 設定例

```bash
# 開発環境
LLM_MODEL=anthropic/claude-3-haiku-20240307
ANTHROPIC_API_KEY=your_anthropic_api_key

# 調整環境
LLM_PROVIDER=anthropic
LLM_MODEL=anthropic/claude-sonnet-4-5
ANTHROPIC_API_KEY=your_anthropic_api_key

# 本番環境
LLM_PROVIDER=anthropic
LLM_MODEL=anthropic/claude-opus-4-5
ANTHROPIC_API_KEY=your_anthropic_api_key
```

## 参考資料

- [LiteLLM Documentation](https://docs.litellm.ai/)
- [Claude API Documentation](https://docs.anthropic.com/)
- [Gemini API Documentation](https://ai.google.dev/docs)
- [middleware-selection.md](../../implementation/middleware-selection.md)
- [requirements overview](../../requirements/overview.md)

---

**作成日**: 2026 年 1 月 14 日
**最終更新日**: 2026 年 1 月 14 日

**更新履歴**:

- 2026 年 1 月: 開発用モデルを Claude 3 Haiku（レガシー）に変更
  - 旧: Claude Haiku 4.5（低コスト）
  - 新: `claude-3-haiku-20240307` (レガシー、超低コスト、制限なし、開発から本番まで統一)
  - 理由: Claude 3 Haiku（レガシー）が Haiku 4.5 の約 1/4 のコストで、大量テスト時にもコストを抑えられる
