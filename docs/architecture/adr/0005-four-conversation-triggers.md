# ADR-0005: 4 つの会話の契機

**ステータス**: Accepted

**日付**: 2026-01-14

**決定者**: kotonoha-bot 開発チーム

## コンテキスト

場面緘黙自助グループ運営支援のための Discord Bot では、ユーザーの使い方に応じて複数の会話方式をサポートする必要がある。以下の要件を満たす必要がある:

1. **多様な利用シーンに対応**: ユーザーによって好みの会話方式が異なる
2. **場面緘黙支援に適している**: プライベートな会話空間を提供
3. **自然な会話参加**: 積極的に話しかけなくても会話に参加できる
4. **会話履歴の管理**: 各方式で適切に会話履歴を管理
5. **実装の柔軟性**: 将来的に新しい方式を追加できる

## 決定

**4 つの会話の契機**を採用する:

1. **メンション応答型**: Bot にメンションした時だけ反応
2. **スレッド型**: メンションすると自動でスレッドを作成し、その中で会話
3. **DM 型**: Bot と 1 対 1 でダイレクトメッセージで会話
4. **聞き耳型**: 会話を監視し、適切なタイミングで自然に会話に参加

## 理由

### 1. 多様な利用シーンに対応

- **メンション応答型**: 必要な時だけ呼び出したいユーザー
- **スレッド型**: プライベートな会話空間を提供（推奨）
- **DM 型**: 完全にプライベートな相談
- **聞き耳型**: 積極的に話しかけなくても会話に参加できる（場面緘黙支援に最適）

### 2. 場面緘黙支援に最適

- **スレッド型**: プライベートな会話空間を提供
- **DM 型**: 完全にプライベートな環境
- **聞き耳型**: 自然な会話の流れを作る

### 3. 技術的な利点

- **スレッド型**: 会話履歴の取得が簡単、コンテキストの分離
- **DM 型**: 履歴管理が最もシンプル（`user_id` のみ）
- **聞き耳型**: 人間らしい自然な会話参加が可能

### 4. 実装の柔軟性

- 各方式を独立して実装可能
- 将来的に新しい方式を追加可能
- ユーザーが方式を選択可能

## 代替案

### 代替案 A: メンション応答型のみ

**メリット**:

- 実装が最もシンプル
- 他の会話の邪魔にならない
- 明確な会話の開始

**デメリット**:

- 毎回メンションが必要で面倒
- 会話が長引くとタイムラインが埋め尽くされる
- 場面緘黙支援には不十分

**採用しなかった理由**:

- **多様な利用シーンに対応できない**
- 場面緘黙支援には不十分
- ユーザー体験が限定的

---

### 代替案 B: スレッド型のみ

**メリット**:

- メインチャンネルを汚さない
- 会話履歴の管理が簡単
- コンテキストの分離

**デメリット**:

- 全ての会話がスレッドになる
- 自然な会話参加ができない
- ユーザーの選択肢が少ない

**採用しなかった理由**:

- **多様な利用シーンに対応できない**
- 聞き耳型の自然な会話参加ができない
- ユーザーの選択肢が限定的

---

### 代替案 C: 聞き耳型のみ

**メリット**:

- 自然な会話参加が可能
- 場面緘黙支援に最適
- 人間らしい挙動

**デメリット**:

- 全てのメッセージに対して判断処理が必要
- API リクエストが増える
- 空気を読めないタイミングで発言するリスク

**採用しなかった理由**:

- **多様な利用シーンに対応できない**
- プライベートな会話空間を提供できない
- ユーザーの選択肢が限定的

---

## 結果

### メリット

1. **多様な利用シーンに対応**: 4 つの方式で様々なユーザーニーズに対応
2. **場面緘黙支援に最適**: プライベートな会話空間と自然な会話参加を提供
3. **技術的な利点**: 各方式の技術的な利点を活用
4. **実装の柔軟性**: 将来的に新しい方式を追加可能
5. **ユーザー選択**: ユーザーが好みの方式を選択可能

### デメリット

1. **実装の複雑性**: 4 つの方式を実装する必要がある
2. **会話履歴の管理**: 各方式で異なるセッションキーを使用
3. **テストの複雑性**: 各方式のテストが必要

### トレードオフ

- **機能 vs 複雑性**: 多様な機能を提供するため、実装の複雑性を許容
- **柔軟性 vs シンプルさ**: 柔軟性を優先し、シンプルさを犠牲にする

### 実装への影響

1. **メッセージルーター**: 4 つの方式を判定するルーターが必要
2. **セッション管理**: 各方式で異なるセッションキーを使用
   - メンション応答型: `channel_id` または `channel_id:user_id`
   - スレッド型: `thread_id`
   - DM 型: `dm:user_id`
   - 聞き耳型: `eavesdrop:channel_id`
3. **会話履歴の取得**: 各方式で異なる方法で会話履歴を取得
4. **判定ロジック**: 聞き耳型では「今、発言すべきか？」の判定が必要

### 各方式の詳細

#### 1. メンション応答型

- **セッションキー**: `channel_id` または `channel_id:user_id`
- **会話履歴**: `message.reference` を辿るか、チャンネル ID で管理
- **実装**: `on_message` イベントでメンション判定

#### 2. スレッド型（推奨）

- **セッションキー**: `thread_id`
- **会話履歴**: スレッド内のメッセージを取得
- **実装**: メンション検知時に自動でスレッドを作成
- **利点**: コンテキストの分離、会話履歴の取得が簡単

#### 3. DM 型

- **セッションキー**: `dm:user_id`
- **会話履歴**: ユーザー ID で管理
- **実装**: DM チャンネル判定
- **利点**: 最もシンプルな管理方式、完全にプライベート

#### 4. 聞き耳型（場面緘黙支援に最適）

- **セッションキー**: `eavesdrop:channel_id`
- **会話履歴**: チャンネルの直近 10〜20 件を一時保存
- **実装**: 2 つのアプローチ
  - **アプローチ 1（推奨）**: LLM に「空気」を読ませる（高精度）
  - **アプローチ 2**: ルールベースと確率（省エネ・高速）
- **利点**: 自然な会話参加、場面緘黙支援に最適

## 参考資料

- [conversation-triggers.md](../../requirements/conversation-triggers.md)
- [use-cases.md](../../requirements/use-cases.md)
- [user-stories.md](../../requirements/user-stories.md)
- [ADR-0004: ハイブリッドセッション管理](./0004-hybrid-session-management.md)

---

**作成日**: 2026年1月14日
**最終更新日**: 2026年1月14日
