# ADR-0008: LangGraph の適用可能性検討

**ステータス**: Accepted

**日付**: 2026-01-19

**決定者**: kotonoha-bot 開発チーム

## コンテキスト

Kotonoha Bot の聞き耳型機能は、複数のステップを持つワークフローを実装している:

1. **会話状態の分析**: 会話が終了中か、誤解があるか、対立があるかを判定
2. **介入履歴のチェック**: 最小間隔、同じ会話判定、会話状況変化判定
3. **LLM判定**: 発言すべきかどうかを判定
4. **応答生成**: 判定がYESの場合、応答を生成

このような複雑なワークフローに対して、LangGraph（LangChain のグラフベースのオーケストレーションフレームワーク）の適用可能性を検討する必要がある。

## 決定

**LangGraph は採用しない**。現在の実装（非同期関数ベースのワークフロー）を継続する。

## 理由

### 1. 現在の実装で十分に機能している

- 聞き耳型機能は既に実装済みで、正常に動作している
- 各ステップは比較的シンプルで、線形に近い処理フロー
- 状態管理（介入履歴、会話バッファ）は手動で実装されており、十分に機能している

### 2. プロジェクトの設計方針との整合性

- **1人開発に適したシンプルな構造を維持**: Phase 9 のリファクタリング方針に合致
- **過度な抽象化を避ける**: 現在の実装は理解しやすく、メンテナンスしやすい
- **ディレクトリ深度は最大2階層**: LangGraph を導入すると、追加の抽象化レイヤーが必要になる

### 3. LangGraph のオーバーヘッド

- **学習コスト**: グラフ設計、状態管理、条件分岐の理解が必要
- **ボイラープレート**: シンプルなタスクに対して過剰な設定が必要
- **パフォーマンス**: 状態の永続化やチェックポイント処理によるI/Oオーバーヘッド

### 4. 現在のワークフローの特性

現在の聞き耳型機能のワークフローは以下の特性を持つ:

- **短時間実行**: 各メッセージ受信時に数秒以内に完了
- **ステートレス**: 各処理は独立しており、永続的な状態管理は不要
- **線形処理**: 条件分岐はあるが、複雑なループや再帰はない
- **単一セッション**: 各メッセージ処理は独立したセッション

これらの特性は、LangGraph が得意とする「長時間実行」「永続的な状態管理」「複雑なループ」とは異なる。

## 代替案

### 代替案 A: LangGraph を採用する

**メリット**:

- **ワークフローの可視化**: グラフ構造により、処理フローが視覚的に理解しやすい
- **状態管理の標準化**: LangGraph の状態管理機能を活用できる
- **デバッグと観察可能性**: LangSmith などのツールとの統合により、デバッグが容易
- **将来の拡張性**: 複雑なワークフローを追加する際に、基盤が整っている

**デメリット**:

- **学習コスト**: チームメンバーが LangGraph を理解する必要がある
- **実装の複雑性**: 現在のシンプルな実装から、グラフ構造への移行が必要
- **オーバーヘッド**: シンプルなタスクに対して過剰な抽象化
- **依存関係の追加**: 新しいライブラリの依存関係が増える
- **プロジェクト方針との不一致**: 1人開発に適したシンプルな構造を維持する方針と矛盾

**採用しなかった理由**:

- **現在の実装で十分に機能している**
- **プロジェクトの設計方針（シンプルさを優先）と矛盾する**
- **オーバーヘッドがメリットを上回る**

### 代替案 B: 現在の実装を継続（採用）

**メリット**:

- **シンプルさ**: 理解しやすく、メンテナンスしやすい
- **既存の実装**: 既に動作しており、追加の開発コストが不要
- **プロジェクト方針との整合性**: 1人開発に適したシンプルな構造を維持
- **パフォーマンス**: オーバーヘッドが少ない

**デメリット**:

- **可視化の欠如**: ワークフローがコードに埋もれており、視覚的な理解が難しい
- **状態管理の手動実装**: 状態管理を手動で実装する必要がある
- **将来の拡張性**: 複雑なワークフローを追加する際に、リファクタリングが必要になる可能性

**採用した理由**:

- **現在の実装で十分に機能している**
- **プロジェクトの設計方針に合致している**
- **オーバーヘッドが少ない**

## 結果

### メリット

1. **シンプルさの維持**: プロジェクトの設計方針に合致し、理解しやすいコードを維持
2. **既存の実装の活用**: 既に動作している実装を継続使用できる
3. **パフォーマンス**: オーバーヘッドが少なく、高速な処理が可能
4. **メンテナンス性**: シンプルな実装により、メンテナンスが容易

### デメリット

1. **可視化の欠如**: ワークフローがコードに埋もれており、視覚的な理解が難しい
2. **将来の拡張性**: 複雑なワークフローを追加する際に、リファクタリングが必要になる可能性

### トレードオフ

- **シンプルさ vs 可視化**: シンプルさを優先し、可視化の利点を犠牲にする
- **現在の実装 vs 将来の拡張性**: 現在の実装を優先し、将来の拡張性は必要に応じて対応する

### 実装への影響

1. **現在の実装を継続**: `src/kotonoha_bot/eavesdrop/llm_judge.py` の実装を継続使用
2. **状態管理**: 手動で実装された状態管理（介入履歴、会話バッファ）を継続使用
3. **ドキュメント**: ワークフローの可視化は、Mermaid 図などのドキュメントで補完

### 将来の検討事項

以下の条件が満たされた場合、LangGraph の再検討を検討する:

1. **複雑なワークフローの追加**: 長時間実行されるワークフローや、複雑なループが必要になった場合
2. **マルチエージェントシステム**: 複数のエージェントが協調して動作する必要がある場合
3. **人間の介入が必要**: ワークフロー中に人間の承認や判断が必要になった場合
4. **観察可能性の重要性**: デバッグや監視の重要性が高まり、LangSmith などのツールが必要になった場合

## 参考資料

- [LangGraph Documentation](https://docs.langchain.com/langgraph)
- [LangGraph GitHub Repository](https://github.com/langchain-ai/langgraph)
- [聞き耳型機能仕様書](../../30_design_basic/eavesdrop-specification.md)
- [聞き耳型実装ガイド](../../50_implementation/51_guides/conversation-state-llm-judgment.md)
- [ADR-0005: 3 つの会話の契機](./0005-four-conversation-triggers.md)

---

**作成日**: 2026 年 1 月 19 日
**最終更新日**: 2026 年 1 月 19 日
