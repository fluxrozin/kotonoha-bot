# ADR-0010: aisuite vs LiteLLM の選択

**ステータス**: Accepted

**日付**: 2026-01-19

**決定者**: kotonoha-bot 開発チーム

## コンテキスト

Kotonoha Bot では、LLM API へのアクセスを統一するために LiteLLM を使用している。aisuite（Andrew Ng のチームが開発したオープンソースライブラリ）も複数 LLM プロバイダーへの統一インターフェースを提供しており、LiteLLM の代替として検討する必要がある。

現在のプロジェクトの要件:

1. **本番環境での運用**: 安定性と信頼性が重要
2. **コスト管理**: 開発フェーズでのコスト最適化が重要
3. **レート制限**: API レート制限の管理が必要
4. **フォールバック**: プロバイダー障害時の自動切り替え
5. **観察可能性**: 使用量の追跡とログ管理

## 決定

**LiteLLM を継続使用する**。aisuite への移行は行わない。

## 理由

### 1. プロジェクトの要件との整合性

現在のプロジェクトは以下の特性を持つ:

- **本番環境での運用**: 安定性と信頼性が最重要
- **コスト管理**: 開発フェーズでのコスト最適化が重要
- **レート制限**: API レート制限の管理が必要
- **フォールバック**: プロバイダー障害時の自動切り替え
- **観察可能性**: 使用量の追跡とログ管理

これらの要件に対して、LiteLLM は成熟した機能を提供しているが、aisuite は一部の機能が開発中または未成熟である。

### 2. aisuite の強みと弱み

**aisuite の強み**:

- **軽量**: シンプルでオーバーヘッドが少ない
- **統一インターフェース**: OpenAI スタイルの API で複数プロバイダーに対応
- **ツール呼び出し機能**: Python 関数をツールとして渡せる
- **MCP 統合**: Model Context Protocol による外部ツールとの統合
- **実験・プロトタイプ向け**: モデルの比較や A/B テストに適している

**aisuite の弱み**:

- **機能の未成熟**: ストリーミング、使用量監視、レート制限などの高度な機能は開発中
- **本番環境向け機能の不足**: コスト管理、フォールバック、観察可能性が限定的
- **プロバイダーサポート**: LiteLLM より少ない（100+ vs 10+）
- **早期段階**: 2024年後半にリリースされたばかりで、一部の統合は完成度が低い
- **チャット補完以外の機能**: 埋め込み、画像生成などは未成熟

### 3. LiteLLM の強みと弱み

**LiteLLM の強み**:

- **成熟度**: 本番環境で広く使用されている
- **豊富な機能**: コスト管理、レート制限、フォールバック、観察可能性
- **広範なプロバイダーサポート**: 100+ モデル/プロバイダーに対応
- **本番環境向け**: 負荷分散、フェイルオーバー、認証、観察可能性
- **安定性**: 実績のあるライブラリ

**LiteLLM の弱み**:

- **複雑性**: aisuite より複雑で、設定が多岐にわたる
- **オーバーヘッド**: 機能が豊富な分、オーバーヘッドが大きい可能性
- **ツール呼び出し機能**: aisuite ほど統合されていない（手動実装が必要）

### 4. 現在の実装との整合性

現在の実装は以下の通り:

- **コスト管理**: 独自の `RateLimitMonitor` と `TokenBucket` で実装済み
- **レート制限**: 独自の実装で管理
- **フォールバック**: LiteLLM の `fallbacks` パラメータを使用
- **観察可能性**: ログと使用量追跡を実装済み

これらの実装は LiteLLM の設計思想と一致しており、aisuite に移行するメリットは少ない。

## 代替案

### 代替案 A: aisuite を採用する

**メリット**:

- **軽量**: シンプルでオーバーヘッドが少ない
- **ツール呼び出し機能**: Python 関数をツールとして渡せる
- **MCP 統合**: Model Context Protocol による外部ツールとの統合
- **実験・プロトタイプ向け**: モデルの比較や A/B テストに適している

**デメリット**:

- **機能の未成熟**: ストリーミング、使用量監視、レート制限などの高度な機能は開発中
- **本番環境向け機能の不足**: コスト管理、フォールバック、観察可能性が限定的
- **プロバイダーサポート**: LiteLLM より少ない（100+ vs 10+）
- **早期段階**: 2024年後半にリリースされたばかりで、一部の統合は完成度が低い
- **既存実装の書き換え**: 現在の実装を大幅に変更する必要がある
- **プロジェクト要件との不一致**: 本番環境での運用に必要な機能が不足

**採用しなかった理由**:

- **本番環境での運用に不適切**: 必要な機能が開発中または未成熟
- **プロジェクト要件との不一致**: コスト管理、レート制限、フォールバックが重要
- **既存実装の書き換えコスト**: 現在の実装を大幅に変更する必要がある
- **プロバイダーサポートの不足**: 100+ モデル/プロバイダーに対応する必要がある

### 代替案 B: LiteLLM を継続使用（採用）

**メリット**:

- **成熟度**: 本番環境で広く使用されている
- **豊富な機能**: コスト管理、レート制限、フォールバック、観察可能性
- **広範なプロバイダーサポート**: 100+ モデル/プロバイダーに対応
- **本番環境向け**: 負荷分散、フェイルオーバー、認証、観察可能性
- **既存実装との整合性**: 現在の実装と完全に整合

**デメリット**:

- **複雑性**: aisuite より複雑で、設定が多岐にわたる
- **オーバーヘッド**: 機能が豊富な分、オーバーヘッドが大きい可能性
- **ツール呼び出し機能**: aisuite ほど統合されていない（手動実装が必要）

**採用した理由**:

- **本番環境での運用に適切**: 必要な機能がすべて揃っている
- **プロジェクト要件との整合性**: コスト管理、レート制限、フォールバックが重要
- **既存実装の活用**: 現在の実装を継続使用できる
- **プロバイダーサポート**: 100+ モデル/プロバイダーに対応

### 代替案 C: aisuite と LiteLLM の併用

**メリット**:

- **両方の利点を活用**: aisuite のツール呼び出し機能と LiteLLM の本番環境向け機能
- **段階的な移行**: 必要な部分だけ aisuite を導入

**デメリット**:

- **複雑性の増加**: 2つのライブラリを理解する必要がある
- **依存関係の増加**: 両方のライブラリが必要
- **オーバーヘッド**: 両方のライブラリによるオーバーヘッド

**採用しなかった理由**:

- **現在の要件に過剰**: 単純な API 呼び出しには併用は不要
- **複雑性の増加**: 2つのライブラリを理解する必要がある
- **プロジェクト方針との不一致**: シンプルさを優先する方針と矛盾

## 結果

### メリット

1. **本番環境での運用**: 成熟した機能により、安定性と信頼性を確保
2. **コスト管理**: 使用量追跡、予算管理、レート制限
3. **フォールバック**: プロバイダー障害時の自動切り替え
4. **観察可能性**: ログと使用量追跡
5. **既存実装の活用**: 現在の実装を継続使用できる

### デメリット

1. **複雑性**: aisuite より複雑で、設定が多岐にわたる
2. **オーバーヘッド**: 機能が豊富な分、オーバーヘッドが大きい可能性
3. **ツール呼び出し機能**: aisuite ほど統合されていない（現在は不要）

### トレードオフ

- **成熟度 vs 軽量性**: 成熟度を優先し、軽量性を犠牲にする
- **本番環境向け機能 vs 実験向け機能**: 本番環境向け機能を優先し、実験向け機能は必要に応じて対応

### 実装への影響

1. **現在の実装を継続**: `src/kotonoha_bot/ai/litellm_provider.py` の実装を継続使用
2. **コスト管理**: 独自の `RateLimitMonitor` と `TokenBucket` を継続使用
3. **フォールバック**: LiteLLM の `fallbacks` パラメータを継続使用

### 将来の検討事項

以下の条件が満たされた場合、aisuite の再検討を検討する:

1. **ツール呼び出し機能の必要性**: Python 関数をツールとして渡す機能が必要になった場合
2. **MCP 統合の必要性**: Model Context Protocol による外部ツールとの統合が必要になった場合
3. **aisuite の成熟度向上**: 本番環境向け機能が充実した場合
4. **実験・プロトタイプ用途**: モデルの比較や A/B テストが主要な用途になった場合

ただし、これらの機能が必要になった場合でも、aisuite と LiteLLM の併用を検討する（aisuite を特定の用途に限定して使用）。

## 比較表

| 要件 | aisuite | LiteLLM |
|------|---------|---------|
| 本番環境での運用 | 開発中 | 成熟 |
| コスト管理 | 限定的 | 強み |
| レート制限 | 開発中 | 強み |
| フォールバック | 限定的 | 強み |
| 観察可能性 | 開発中 | 強み |
| プロバイダーサポート | 10+ | 100+ |
| ツール呼び出し機能 | 強み | 限定的 |
| MCP 統合 | 強み | 限定的 |
| 軽量性 | 強み | 限定的 |
| 成熟度 | 早期段階 | 成熟 |

## 参考資料

- [ADR-0002: LiteLLM マルチプロバイダー戦略](./0002-litellm-multi-provider-strategy.md)
- [ADR-0009: LangChain vs LiteLLM の選択](./0009-langchain-vs-litellm.md)
- [aisuite GitHub Repository](https://github.com/andrewyng/aisuite)
- [LiteLLM Documentation](https://docs.litellm.ai/)
- [aisuite Documentation](https://deepwiki.com/andrewyng/aisuite/1-overview)

---

**作成日**: 2026 年 1 月 19 日
**最終更新日**: 2026 年 1 月 19 日
