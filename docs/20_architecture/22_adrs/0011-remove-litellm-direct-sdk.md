# ADR-0011: LiteLLM の削除とプロバイダー SDK の直接使用

**ステータス**: Accepted

**日付**: 2026-01-19

**決定者**: kotonoha-bot 開発チーム

## コンテキスト

Kotonoha Bot では、LLM API へのアクセスを統一するために LiteLLM を使用している。しかし、実際の使用状況を確認すると：

1. **チャット/会話判定**: Claude のみ（すべて同じプロバイダー Anthropic）
   - 開発: `claude-haiku-4-5`
   - 本番: `claude-opus-4-5`

2. **ベクトル化**: OpenAI のみ（直接 OpenAI SDK を使用）
   - `text-embedding-3-small`

つまり、実際にはプロバイダーを切り替える必要がなく、各機能でプロバイダーが固定されている。LiteLLM の主な価値は「複数プロバイダーの統一インターフェース」だが、プロバイダーを切り替えないなら不要かもしれない。

また、LiteLLM には以下のデメリットがある：

- **パフォーマンス劣化**: 長時間稼働時のレイテンシ増加
- **メモリ使用量**: 高メモリ消費（24GB RAM @ 9 req/sec の報告）
- **セキュリティ脆弱性**: 複数の CVE（CVE-2025-0628, CVE-2024-5710, CVE-2024-4888, CVE-2025-0330, CVE-2024-9606）
- **オーバーヘッド**: 抽象化レイヤーによる追加のレイテンシ
- **複雑性**: 設定が多岐にわたる
- **接続プール問題**: 長時間稼働時の接続枯渇（現在の実装で対処している）

## 決定

**LiteLLM を削除し、Anthropic SDK を直接使用する**。

### 移行計画

1. **Anthropic SDK の導入**: `anthropic` パッケージを追加
2. **LiteLLMProvider の置き換え**: `AnthropicProvider` に置き換え
3. **既存の抽象化レイヤーの維持**: `AIProvider` インターフェースは維持
4. **フォールバック機能の削除**: プロバイダー固定のため不要
5. **依存関係の整理**: `litellm` を削除

## 理由

### 1. 実際の使用状況との不一致

現在の実装では：

- **チャット/会話判定**: Claude のみ（すべて同じプロバイダー Anthropic）
- **ベクトル化**: OpenAI のみ（直接 OpenAI SDK を使用）

プロバイダーを切り替える必要がないため、LiteLLM の主な価値（統一インターフェース）が不要である。

### 2. LiteLLM のデメリット

**パフォーマンス問題**:

- 長時間稼働時のレイテンシ増加
- 高メモリ消費（24GB RAM @ 9 req/sec の報告）
- レイテンシのオーバーヘッド（数十ミリ秒）

**セキュリティ問題**:

- 複数の CVE（権限昇格、ファイル削除、API キー漏洩など）
- 定期的なセキュリティパッチが必要

**運用上の問題**:

- 接続プール問題（現在の実装で対処している）
- 複雑な設定
- デバッグの困難さ

### 3. Anthropic SDK の直接使用のメリット

**シンプルさ**:

- 依存関係が少ない
- 設定がシンプル
- コードが理解しやすい

**パフォーマンス**:

- オーバーヘッドが少ない
- 直接的な API 呼び出し
- メモリ使用量が少ない

**セキュリティ**:

- セキュリティリスクが少ない
- プロバイダー固有の機能を直接利用できる

**保守性**:

- コードがシンプルで理解しやすい
- デバッグが容易
- プロバイダー固有の機能を直接利用できる

### 4. 既存の抽象化レイヤーの維持

`AIProvider` インターフェースは維持し、実装のみを変更する。これにより：

- 既存のコードへの影響を最小化
- 将来の拡張性を維持
- テストの互換性を維持

## 代替案

### 代替案 A: LiteLLM を継続使用

**メリット**:

- 既存の実装を変更する必要がない
- フォールバック機能が利用可能（現在は使用していない）
- 将来のプロバイダー追加が容易（現在は不要）

**デメリット**:

- パフォーマンス劣化
- セキュリティリスク
- オーバーヘッド
- 複雑性
- 実際の使用状況との不一致

**採用しなかった理由**:

- **実際の使用状況との不一致**: プロバイダーを切り替える必要がない
- **デメリットが大きい**: パフォーマンス、セキュリティ、オーバーヘッドの問題
- **シンプルさの優先**: プロジェクトの方針に合致

### 代替案 B: Anthropic SDK を直接使用（採用）

**メリット**:

- シンプルさ: 依存関係が少ない、設定がシンプル
- パフォーマンス: オーバーヘッドが少ない、メモリ使用量が少ない
- セキュリティ: セキュリティリスクが少ない
- 保守性: コードが理解しやすい、デバッグが容易
- 実際の使用状況との整合性: プロバイダー固定のため適切

**デメリット**:

- 既存の実装を変更する必要がある
- フォールバック機能が利用できない（現在は使用していない）
- 将来のプロバイダー追加が困難（現在は不要）

**採用した理由**:

- **実際の使用状況との整合性**: プロバイダー固定のため適切
- **シンプルさの優先**: プロジェクトの方針に合致
- **デメリットの削減**: パフォーマンス、セキュリティ、オーバーヘッドの問題を解決

## 結果

### メリット

1. **シンプルさ**: 依存関係が少ない、設定がシンプル、コードが理解しやすい
2. **パフォーマンス**: オーバーヘッドが少ない、メモリ使用量が少ない
3. **セキュリティ**: セキュリティリスクが少ない
4. **保守性**: コードが理解しやすい、デバッグが容易
5. **実際の使用状況との整合性**: プロバイダー固定のため適切

### デメリット

1. **既存の実装を変更する必要がある**: 移行コストが発生
2. **フォールバック機能が利用できない**: 現在は使用していないため問題なし
3. **将来のプロバイダー追加が困難**: 現在は不要のため問題なし

### トレードオフ

- **シンプルさ vs 柔軟性**: シンプルさを優先し、柔軟性を犠牲にする（現在は不要）
- **パフォーマンス vs 抽象化**: パフォーマンスを優先し、抽象化を削減

### 実装への影響

1. **Anthropic SDK の導入**: `anthropic` パッケージを追加
2. **LiteLLMProvider の置き換え**: `AnthropicProvider` に置き換え
3. **既存の抽象化レイヤーの維持**: `AIProvider` インターフェースは維持
4. **フォールバック機能の削除**: プロバイダー固定のため不要
5. **依存関係の整理**: `litellm` を削除
6. **設定の簡素化**: LiteLLM 固有の設定を削除

### 移行手順

1. **Anthropic SDK の導入**: `pyproject.toml` に `anthropic` を追加
2. **AnthropicProvider の実装**: `src/kotonoha_bot/ai/anthropic_provider.py` を作成
3. **LiteLLMProvider の置き換え**: `LiteLLMProvider` を `AnthropicProvider` に置き換え
4. **テストの更新**: テストコードを更新
5. **依存関係の整理**: `litellm` を削除
6. **設定の簡素化**: LiteLLM 固有の設定を削除

### 将来の検討事項

以下の条件が満たされた場合、LiteLLM の再検討を検討する:

1. **複数プロバイダーの切り替えが必要**: 実際にプロバイダーを切り替える必要が生じた場合
2. **フォールバック機能が必要**: プロバイダー障害時の自動切り替えが必要になった場合
3. **LiteLLM の改善**: パフォーマンス、セキュリティ、オーバーヘッドの問題が解決された場合

ただし、これらの機能が必要になった場合でも、各プロバイダーの SDK を直接使用する方がシンプルで適切である可能性が高い。

## 参考資料

- [ADR-0002: LiteLLM マルチプロバイダー戦略](./0002-litellm-multi-provider-strategy.md)
- [ADR-0009: LangChain vs LiteLLM の選択](./0009-langchain-vs-litellm.md)
- [ADR-0010: aisuite vs LiteLLM の選択](./0010-aisuite-vs-litellm.md)
- [Anthropic Python SDK](https://github.com/anthropics/anthropic-sdk-python)
- [LiteLLM Issues](https://github.com/BerriAI/litellm/issues)

---

**作成日**: 2026 年 1 月 19 日
**最終更新日**: 2026 年 1 月 19 日

**更新履歴**:
- 2026 年 1 月 19 日: ステータスを Accepted に変更（実装決定）
