# ミドルウェア選定書

## 1. 選定方針

- **無料で利用可能**: 無料枠または完全無料
- **安定性**: 実績のある技術
- **保守性**: 適切なドキュメントとコミュニティサポート
- **パフォーマンス**: 場面緘黙支援に適した応答速度

---

## 2. 選定結果一覧

| カテゴリ                   | 選定技術                    | 選定理由                                 | 代替候補            |
| -------------------------- | --------------------------- | ---------------------------------------- | ------------------- |
| **言語**                   | Python 3.14                 | 最新機能、discord.py との互換性          | Python 3.13         |
| **パッケージ管理**         | uv                          | 高速、モダンなパッケージ管理             | pip, poetry         |
| **Discord フレームワーク** | discord.py                  | 最も一般的、豊富なドキュメント           | discord.js, disnake |
| **AI 統合**                | LiteLLM                     | マルチプロバイダー統合、フェーズ別切替   | 各プロバイダー SDK  |
| **AI（デフォルト）**       | Anthropic Claude Sonnet 4.5 | バランス型、デフォルトモデル             | -                   |
| **AI（判定用）**           | Anthropic Claude Haiku 4.5  | 軽量・高速、判定用に最適                 | Google Gemini API   |
| **AI（本番）**             | Anthropic Claude Opus 4.5   | 最高品質、本番運用                       | -                   |
| **データベース**           | SQLite                      | 軽量、ファイルベース、永続化に適している | PostgreSQL, MySQL   |
| **コンテナ**               | Docker                      | 標準的、Synology 対応                    | Podman              |
| **CI/CD**                  | GitHub Actions              | GitHub と統合、無料                      | GitLab CI, Jenkins  |
| **コンテナレジストリ**     | GitHub Container Registry   | GitHub と統合、無料                      | Docker Hub          |
| **自動更新**               | Watchtower                  | シンプル、Docker 統合                    | Ouroboros           |

---

## 3. 詳細選定理由

### 3.1 Python 3.14

**選定理由**:

- 最新の Python 機能を利用できる
- discord.py との互換性が高い
- パフォーマンスの改善

**実装状況**:

- `pyproject.toml` で `requires-python = ">=3.14"` を指定
- `Dockerfile` で `python:3.14-slim` を使用

**代替候補**: Python 3.13（互換性の観点から）

---

### 3.2 uv（パッケージ管理）

**選定理由**:

- 非常に高速なパッケージ管理
- Rust で実装されており、パフォーマンスが高い
- モダンな依存関係解決

**実装状況**:

- `pyproject.toml` で `build-backend = "uv_build"` を指定
- `Dockerfile` で `ghcr.io/astral-sh/uv:latest` を使用
- `uv.lock` ファイルで依存関係をロック

**代替候補**:

- **pip**: 標準的だが、速度が遅い
- **poetry**: 機能が豊富だが、設定が複雑

---

### 3.3 discord.py

**選定理由**:

- Discord Bot 開発で最も一般的
- 豊富なドキュメントとコミュニティサポート
- 非同期処理に対応
- スレッド機能をサポート

**実装状況**:

- `pyproject.toml` で `discord-py>=2.6.4` を指定
- 実際のバージョンは `uv.lock` で管理

**代替候補**:

- **discord.js**: Node.js ベース（Python プロジェクトには不適切）
- **disnake**: discord.py のフォーク（互換性の問題）

---

### 3.4 LiteLLM（AI 統合レイヤー）

**選定理由**:

**注意**: このセクションは [ADR-0011: LiteLLM の削除とプロバイダー SDK の直接使用](./0011-remove-litellm-direct-sdk.md) により更新されました。

**現在の実装**:

- `pyproject.toml` で `anthropic` パッケージを指定
- `src/kotonoha_bot/ai/anthropic_provider.py` で実装
- Anthropic SDK を直接使用（LiteLLM を削除）

**移行理由**:

- 実際の使用状況（プロバイダー固定）との不一致
- LiteLLM のデメリット（パフォーマンス、セキュリティ、オーバーヘッド）
- シンプルさの優先（プロジェクトの方針に合致）

詳細は [ADR-0011](./0011-remove-litellm-direct-sdk.md) を参照してください。

---

### 3.5 Anthropic Claude Sonnet 4.5（デフォルト）

**選定理由**:

- バランス型の品質とコスト
- デフォルトモデルとして使用
- 日本語対応が優秀

**実装状況**:

- `config.py` で `LLM_MODEL` のデフォルト値として設定
- デフォルト: `anthropic/claude-sonnet-4-5`

**用途**: デフォルトモデル（品質調整・プロンプト最適化）

---

### 3.6 Anthropic Claude Haiku 4.5（判定用）

**選定理由**:

- 軽量・高速で判定用に最適
- 低コスト（入力 $1.00/100 万トークン、出力 $5.00/100 万トークン）
- 判定タスクに十分な精度

**実装状況**:

- `config.py` で `EAVESDROP_JUDGE_MODEL` のデフォルト値として設定
- デフォルト: `anthropic/claude-haiku-4-5`
- 聞き耳型の判定用に使用

**用途**: 聞き耳型の判定（介入判定、会話状態判定、同じ会話判定など）

---

### 3.7 Anthropic Claude Opus 4.5（本番用）

**選定理由**:

- 最高品質の日本語応答
- 場面緘黙支援に必要な繊細で優しい表現が可能
- 長いコンテキストウィンドウ

**実装状況**:

- 環境変数 `LLM_MODEL` で設定可能
- フォールバックモデルとしても設定可能（`LLM_FALLBACK_MODEL`）

**用途**: 本番フェーズ（最高品質の運用）

**注意**: `google-generativeai` は依存関係に含まれているが、現在の実装では使用されていない（LiteLLM 経由で使用可能）

---

### 3.8 SQLite

**選定理由**:

- 軽量でファイルベース
- セットアップが不要
- 単一サーバー運用に適している
- 永続化に十分

**実装状況**:

- Python 標準ライブラリの `sqlite3` を使用
- `src/kotonoha_bot/db/sqlite.py` で実装
- WAL モードを有効化（長時間稼働時のファイルロック問題を回避）

**代替候補**:

- **PostgreSQL**: 高機能だが、セットアップが複雑
- **MySQL**: 一般的だが、SQLite で十分

**将来の移行**: スケールが必要になった場合、PostgreSQL への移行を検討

---

### 3.9 Docker

**選定理由**:

- 標準的なコンテナ技術
- Synology Container Manager でサポート
- 豊富なドキュメント

**実装状況**:

- `Dockerfile` でマルチステージビルドを実装
- `docker-compose.yml` でコンテナ管理
- `python:3.14-slim` をベースイメージとして使用

**代替候補**:

- **Podman**: Docker 互換だが、Synology でサポートが限定的

#### 3.9.1 Docker ベースイメージの選択

**選定**: `python:3.14-slim`

**選定理由**:

- **軽量**: 約 150MB と軽量で、デプロイメントが高速
- **互換性**: Debian ベースで、Python ライブラリとの互換性が高い
- **必要なパッケージ**: `sqlite3`、`ca-certificates` などの必要なパッケージを追加可能
- **公式サポート**: 公式イメージで継続的なメンテナンスが期待できる
- **マルチステージビルド**: ビルドツール（uv、curl など）を実行ステージから除外できるため、最終イメージが軽量

**代替案の比較**:

| イメージ             | サイズ | メリット                       | デメリット                         | 推奨度        |
| -------------------- | ------ | ------------------------------ | ---------------------------------- | ------------- |
| `python:3.14-slim`   | ~150MB | 軽量、互換性良好、公式サポート | 3.14 は新しめ                      | ✅ **推奨**   |
| `python:3.13-slim`   | ~150MB | より安定したバージョン         | プロジェクト要件が 3.14            | ❌ 要件不一致 |
| `python:3.14-alpine` | ~50MB  | 非常に軽量                     | musl libc による互換性問題の可能性 | ⚠️ 非推奨     |
| `python:3.14`        | ~900MB | 全てのツールが含まれる         | サイズが大きすぎる                 | ❌ 非推奨     |

**考慮点**:

- Python 3.14 は比較的新しいバージョン（2024 年 10 月リリース）のため、本番環境ではより安定したバージョン（3.13）を検討する余地がある
- ただし、プロジェクト要件が `requires-python = ">=3.14"` のため、3.13 は使用不可
- Alpine ベースのイメージは、互換性の問題が発生する可能性があるため、特別な理由がない限り使用しない

**結論**:

現在の `python:3.14-slim` の選択は適切です。マルチステージビルドと組み合わせることで、軽量かつ必要な機能を備えたイメージを構築できます。

---

### 3.10 GitHub Actions

**選定理由**:

- GitHub と統合
- 無料で利用可能
- 設定が簡単

**実装状況**:

- `.github/workflows/build.yml`: ビルドワークフロー
- `.github/workflows/ci.yml`: CI ワークフロー

**代替候補**:

- **GitLab CI**: 機能が豊富だが、GitHub を使用しているため不適切
- **Jenkins**: 高機能だが、セットアップが複雑

---

### 3.11 GitHub Container Registry (GHCR)

**選定理由**:

- GitHub と統合
- 無料で利用可能
- Watchtower と連携可能

**実装状況**:

- `docker-compose.yml` で
  `ghcr.io/${GITHUB_REPOSITORY:-your-username/kotonoha-bot}:latest` を指定

**代替候補**:

- **Docker Hub**: 一般的だが、レート制限がある

---

### 3.12 Watchtower

**選定理由**:

- シンプルで使いやすい
- Docker コンテナの自動更新
- 設定が簡単

**実装状況**:

- `docker-compose.yml` で `containrrr/watchtower:latest` を使用
- 環境変数 `WATCHTOWER_ENABLED` で有効/無効を切り替え可能

**代替候補**:

- **Ouroboros**: 機能が似ているが、Watchtower の方が一般的

---

## 4. 技術スタックの互換性

### 4.1 互換性マトリックス

| 技術            | Python 3.14 | discord.py | SQLite | Docker | 備考                  |
| --------------- | ----------- | ---------- | ------ | ------ | --------------------- |
| **Python 3.14** | 対応        | 対応       | 対応   | 対応   | 全てと互換            |
| **discord.py**  | 対応        | -          | 対応   | 対応   | SQLite は独立         |
| **SQLite**      | 対応        | 対応       | -      | 対応   | Python 標準ライブラリ |
| **Docker**      | 対応        | 対応       | 対応   | -      | 全てをコンテナ化      |

### 4.2 依存関係

```txt
Python 3.14
├── discord.py (>=2.6.4)
│   └── aiohttp (非同期 HTTP)
├── litellm (>=1.80.16)
│   ├── openai (内部依存)
│   └── httpx (HTTP クライアント)
├── google-generativeai (>=0.8.6)
│   └── LiteLLM 経由で使用可能（現在は未使用）
├── pynacl (>=1.6.2)
│   └── discord.py の依存関係
├── python-dotenv (>=1.2.1)
│   └── 環境変数管理
└── sqlite3 (標準ライブラリ)
    └── データベース
```

**開発依存関係**:

- `pytest` (>=9.0.2): テストフレームワーク
- `pytest-asyncio` (>=1.3.0): 非同期テスト
- `pytest-cov` (>=7.0.0): カバレッジ測定
- `ruff` (>=0.14.11): リンター・フォーマッター
- `ty` (>=0.0.11): 型チェック

---

## 5. 選定プロセス

### 5.1 評価基準

| 基準               | 重み | 説明                       |
| ------------------ | ---- | -------------------------- |
| **コスト**         | 30%  | 無料で利用可能か           |
| **パフォーマンス** | 25%  | 応答速度、処理速度         |
| **安定性**         | 20%  | 実績、信頼性               |
| **保守性**         | 15%  | ドキュメント、コミュニティ |
| **拡張性**         | 10%  | 将来の拡張に対応できるか   |

### 5.2 評価結果

| 技術            | コスト | パフォーマンス | 安定性 | 保守性 | 拡張性 | 総合 |
| --------------- | ------ | -------------- | ------ | ------ | ------ | ---- |
| **Python 3.14** | 100    | 90             | 95     | 95     | 90     | 94   |
| **uv**          | 100    | 100            | 80     | 85     | 90     | 93   |
| **discord.py**  | 100    | 85             | 95     | 100    | 85     | 93   |
| **LiteLLM**     | 100    | 90             | 90     | 95     | 95     | 93   |
| **Claude API**  | 70     | 100            | 95     | 95     | 90     | 88   |
| **SQLite**      | 100    | 85             | 95     | 90     | 70     | 90   |

---

## 6. リスクと対策

### 6.1 技術選定のリスク

| リスク                 | 影響度 | 対策                                               |
| ---------------------- | ------ | -------------------------------------------------- |
| **API の無料枠終了**   | 中     | LiteLLM で複数プロバイダー対応、フォールバック機能 |
| **本番コスト増加**     | 中     | 開発は無料枠、本番のみ有料モデルでコスト最適化     |
| **技術の非推奨化**     | 中     | 標準的な技術を選定、コミュニティの動向を監視       |
| **パフォーマンス問題** | 中     | パフォーマンステスト、最適化                       |
| **プロバイダー障害**   | 低     | LiteLLM のフォールバック機能で自動切り替え         |

---

## 7. 実装状況

### 7.1 実装済み

- ✅ Python 3.14
- ✅ uv パッケージ管理
- ✅ discord.py 2.6.4+
- ✅ LiteLLM 1.80.16+
- ✅ Anthropic Claude API（Sonnet 4.5 デフォルト、Haiku 4.5 判定用）
- ✅ SQLite
- ✅ Docker（マルチステージビルド）
- ✅ Docker Compose
- ✅ GitHub Actions（CI/CD）
- ✅ GitHub Container Registry
- ✅ Watchtower（自動更新）

### 7.2 未実装（将来の拡張）

- ⏳ Google Gemini API（依存関係は含まれているが、現在は未使用）
- ⏳ その他の LLM プロバイダー（LiteLLM 経由で使用可能）

---

**作成日**: 2026 年 1 月 14 日  
**最終更新**: 2026 年 1 月（現在の実装に基づいて改訂）  
**バージョン**: 2.0  
**作成者**: kotonoha-bot 開発チーム
