# ADR-0009: LangChain vs LiteLLM の選択

**ステータス**: Accepted

**日付**: 2026-01-19

**決定者**: kotonoha-bot 開発チーム

## コンテキスト

Kotonoha Bot では、LLM API へのアクセスを統一するために LiteLLM を使用している。LangChain も LLM アプリケーション開発のためのフレームワークとして広く使われており、LiteLLM の代替として検討する必要がある。

現在のプロジェクトの要件:

1. **単純な LLM API 呼び出し**: メッセージを受け取り、LLM で応答を生成する
2. **複数プロバイダー対応**: 開発・本番で異なるモデル（Claude Haiku/Opus）を使用
3. **コスト管理**: 開発フェーズでのコスト最適化が重要
4. **シンプルさの優先**: 1人開発に適したシンプルな構造を維持

## 決定

**LiteLLM を継続使用する**。LangChain への移行は行わない。

## 理由

### 1. プロジェクトの要件との整合性

現在のプロジェクトは以下の特性を持つ:

- **単純な API 呼び出し**: 複雑なワークフローやエージェント機能は不要
- **統一インターフェース**: 複数プロバイダーを同一 API で利用
- **コスト管理**: 開発フェーズでのコスト最適化が重要
- **シンプルさの優先**: 過度な抽象化を避ける

これらの要件に対して、LiteLLM は最適な選択である。

### 2. LangChain の強みと弱み

**LangChain の強み**:

- **ワークフロー・チェーン**: 複数ステップの処理を組み合わせる
- **エージェント機能**: ツールを選択して実行する動的な動作
- **メモリ管理**: 会話履歴やベクトルストアの管理
- **RAG (Retrieval-Augmented Generation)**: 知識ベースとの統合

**LangChain の弱み**:

- **複雑性**: 小規模プロジェクトには過剰な抽象化
- **オーバーヘッド**: 依存関係が多く、起動時間が長い
- **破壊的変更**: バージョンアップ時の互換性問題
- **学習コスト**: フレームワークの理解に時間がかかる

### 3. LiteLLM の強みと弱み

**LiteLLM の強み**:

- **統一インターフェース**: 100+ プロバイダーを同一 API で利用
- **コスト管理**: 使用量追跡、予算管理、レート制限
- **フォールバック**: プロバイダー障害時の自動切り替え
- **軽量**: オーバーヘッドが少ない
- **シンプル**: 単純な API 呼び出しに最適

**LiteLLM の弱み**:

- **ワークフロー機能**: 複数ステップの処理は手動実装が必要
- **メモリ管理**: 会話履歴管理は手動実装が必要
- **エージェント機能**: 動的なツール選択は手動実装が必要

### 4. 現在の実装との整合性

現在の実装は以下の通り:

- **単純な API 呼び出し**: `litellm.completion()` を使用
- **プロバイダー切り替え**: 環境変数でモデルを切り替え
- **会話履歴管理**: 独自の `SessionManager` で実装済み
- **レート制限**: 独自の `RateLimitMonitor` と `TokenBucket` で実装済み

これらの実装は LiteLLM の設計思想と一致しており、LangChain に移行するメリットは少ない。

## 代替案

### 代替案 A: LangChain を採用する

**メリット**:

- **ワークフロー機能**: 複数ステップの処理を組み合わせやすい
- **メモリ管理**: 会話履歴管理の標準化
- **エージェント機能**: 将来的にツール選択機能を追加しやすい
- **RAG 統合**: 知識ベースとの統合が容易
- **コミュニティ**: 大規模なコミュニティと豊富なドキュメント

**デメリット**:

- **複雑性**: 小規模プロジェクトには過剰な抽象化
- **オーバーヘッド**: 依存関係が多く、起動時間が長い
- **破壊的変更**: バージョンアップ時の互換性問題
- **学習コスト**: フレームワークの理解に時間がかかる
- **プロジェクト方針との不一致**: シンプルさを優先する方針と矛盾
- **既存実装の書き換え**: 現在の実装を大幅に変更する必要がある

**採用しなかった理由**:

- **現在の要件に過剰**: 単純な API 呼び出しには LangChain は過剰
- **プロジェクト方針との不一致**: シンプルさを優先する方針と矛盾
- **既存実装の書き換えコスト**: 現在の実装を大幅に変更する必要がある
- **オーバーヘッド**: 依存関係が多く、起動時間が長い

### 代替案 B: LiteLLM を継続使用（採用）

**メリット**:

- **シンプルさ**: 単純な API 呼び出しに最適
- **統一インターフェース**: 複数プロバイダーを同一 API で利用
- **コスト管理**: 使用量追跡、予算管理、レート制限
- **フォールバック**: プロバイダー障害時の自動切り替え
- **軽量**: オーバーヘッドが少ない
- **既存実装との整合性**: 現在の実装と完全に整合

**デメリット**:

- **ワークフロー機能**: 複数ステップの処理は手動実装が必要
- **メモリ管理**: 会話履歴管理は手動実装が必要（既に実装済み）
- **エージェント機能**: 動的なツール選択は手動実装が必要

**採用した理由**:

- **現在の要件に最適**: 単純な API 呼び出しに最適
- **プロジェクト方針との整合性**: シンプルさを優先する方針に合致
- **既存実装の活用**: 現在の実装を継続使用できる
- **オーバーヘッドが少ない**: 依存関係が少なく、起動時間が短い

### 代替案 C: LangChain と LiteLLM の併用

**メリット**:

- **両方の利点を活用**: LangChain のワークフロー機能と LiteLLM の統一インターフェース
- **段階的な移行**: 必要な部分だけ LangChain を導入

**デメリット**:

- **複雑性の増加**: 2つのフレームワークを理解する必要がある
- **依存関係の増加**: 両方のライブラリが必要
- **オーバーヘッド**: 両方のライブラリによるオーバーヘッド

**採用しなかった理由**:

- **現在の要件に過剰**: 単純な API 呼び出しには併用は不要
- **複雑性の増加**: 2つのフレームワークを理解する必要がある
- **プロジェクト方針との不一致**: シンプルさを優先する方針と矛盾

## 結果

### メリット

1. **シンプルさの維持**: プロジェクトの設計方針に合致し、理解しやすいコードを維持
2. **既存実装の活用**: 既に動作している実装を継続使用できる
3. **パフォーマンス**: オーバーヘッドが少なく、高速な処理が可能
4. **コスト管理**: LiteLLM のコスト管理機能を活用できる
5. **統一インターフェース**: 複数プロバイダーを同一 API で利用できる

### デメリット

1. **ワークフロー機能**: 複数ステップの処理は手動実装が必要（現在は不要）
2. **エージェント機能**: 動的なツール選択は手動実装が必要（現在は不要）

### トレードオフ

- **シンプルさ vs 機能性**: シンプルさを優先し、高度な機能は必要に応じて手動実装
- **現在の実装 vs 将来の拡張性**: 現在の実装を優先し、将来の拡張性は必要に応じて対応

### 実装への影響

1. **現在の実装を継続**: `src/kotonoha_bot/ai/litellm_provider.py` の実装を継続使用
2. **会話履歴管理**: 独自の `SessionManager` を継続使用
3. **レート制限**: 独自の `RateLimitMonitor` と `TokenBucket` を継続使用

### 将来の検討事項

以下の条件が満たされた場合、LangChain の再検討を検討する:

1. **複雑なワークフローの追加**: 複数ステップの処理が必要になった場合
2. **エージェント機能の追加**: 動的なツール選択が必要になった場合
3. **RAG 統合の必要性**: 知識ベースとの統合が必要になった場合
4. **メモリ管理の複雑化**: 会話履歴管理が複雑になった場合

ただし、これらの機能が必要になった場合でも、LiteLLM と LangChain の併用を検討する（LangChain が LiteLLM をラップして使用可能）。

## 参考資料

- [ADR-0002: LiteLLM マルチプロバイダー戦略](./0002-litellm-multi-provider-strategy.md)
- [ADR-0008: LangGraph の適用可能性検討](./0008-langgraph-consideration.md)
- [LiteLLM Documentation](https://docs.litellm.ai/)
- [LangChain Documentation](https://docs.langchain.com/)
- [LangChain LiteLLM Integration](https://python.langchain.com/docs/integrations/llms/litellm)

---

**作成日**: 2026 年 1 月 19 日
**最終更新日**: 2026 年 1 月 19 日
