# 聞き耳型介入機能の改善

## 概要

評価レポートに基づき、オーバーフィッティングを避けつつ、一般的な原則に基づいた改善を実施しました。現在の実装では、**LLM 判定**を活用して柔軟な判定を行っています。

## 改善内容

### 1. 介入履歴の追跡機能

**問題**: 同じ会話で 3 回も介入しており、会話の自然な流れを妨げていた

**改善**:

- チャンネルごとの介入履歴を追跡
- 介入の最小間隔を設定（デフォルト: 10 分）
- 同じ会話での介入を制限（LLM 判定で会話状況の変化を確認）

**実装**:

**データ構造**:

```python
intervention_history: dict[int, list[tuple[datetime, str]]]
  - キー: チャンネルID
  - 値: (介入時刻, 介入時の会話ログ)のリスト
```

**実装箇所**: `src/kotonoha_bot/eavesdrop/llm_judge.py`

**主要メソッド**:

- `_record_intervention()`: 介入を記録（介入時に最新 5 メッセージの会話ログを保存）
- `_has_conversation_changed_after_intervention()`: 介入後の会話状況が変わったか判定
- `_is_same_conversation()`: 同じ会話かどうかを LLM で判定
- `_check_conversation_situation_changed()`: 会話状況が変わったかを
  LLM で判定

**管理方法**:

- チャンネル ID ごとに介入履歴を追跡
- 介入時に、最新の 5 メッセージの会話ログを保存
- 1 時間以内の履歴を保持（古い履歴は自動削除）

**介入の制限ロジック**:

1. **最小間隔チェック**: 最後の介入から
   `EAVESDROP_MIN_INTERVENTION_INTERVAL_MINUTES`（デフォルト: 10 分）経過しているか確認
2. **同じ会話判定**: LLM で前回の介入時の会話と現在の会話が同じかどうかを判定
3. **会話状況の変化判定**: 同じ会話の場合、会話状況が変わったかを LLM で判定

**設定項目**:

- `EAVESDROP_MIN_INTERVENTION_INTERVAL_MINUTES`: 介入の最小間隔（分、デフォルト: 10）

### 2. 会話の状態判定機能

**問題**: 会話が終了しようとしている時や、誤解が発生している時を検知できていなかった

**改善**:

- 会話の状態を分析する機能を追加（LLM 判定）
- 会話が終了しようとしている場合は介入しない
- 誤解が発生している場合は、ファシリテートが必要な状況として判定

**実装**:

**実装メソッド**: `_analyze_conversation_state()`

**判定方法**: LLM 判定を使用（キーワードリストベースではない）

**状態の種類**:

- `"active"`: 通常の会話が順調に進行している
- `"ending"`: 会話が終了しようとしている
- `"misunderstanding"`: 参加者間の誤解が発生している
- `"conflict"`: 対立や緊張感が高まっている

**判定の優先順位**:

1. 最優先: 会話が終了しようとしているか（ENDING）
2. 次に重要: 参加者間の誤解が発生しているか（MISUNDERSTANDING）
3. 次に重要: 対立や緊張感が高まっているか（CONFLICT）
4. デフォルト: 会話が順調に進行している（ACTIVE）

**プロンプト**: `prompts/eavesdrop_conversation_state_prompt.md`

**実装箇所**: `src/kotonoha_bot/eavesdrop/llm_judge.py` (432-484 行目)

**使用箇所**:

- `should_respond()` メソッドの最初で、会話が終了しようとしている場合は介入をブロック
- 会話の状態が `conflict` や `misunderstanding` の場合は、LLM 判定に進む（介入が必要な可能性があるため）

### 3. 同じ会話判定機能（LLM 判定）

**改善**:

- 同じ会話かどうかを LLM で判定
- トピック、参加者、時間的な連続性、会話の文脈を総合的に判断
- 機械的なルールに依存しない柔軟な判定

**実装**:

**実装メソッド**: `_is_same_conversation()`

**判定方法**:

- 前回の介入時の会話ログ（最新 5 メッセージ）と
- 現在の会話ログ（最新 5 メッセージ）を比較
- LLM に「SAME」または「DIFFERENT」で判定させる

**プロンプト**: `prompts/eavesdrop_same_conversation_prompt.md`

**判定基準**:

- **SAME**: トピックが同じ/関連、参加者が同じ/重複、時間が経過していても返信の場合は同じ会話
- **DIFFERENT**: トピックが全く異なる、会話の文脈が切れている

**優先順位**:

1. トピックと内容の関連性（最優先）
2. 会話の文脈の連続性
3. 時間的な間隔、参加者の変化（参考程度）

**キャッシュ機能**:

- 同じ会話ログの判定結果を 5 分間キャッシュ
- トークン消費を削減

### 4. 会話状況の変化判定機能（LLM 判定）

**改善**:

- 同じ会話内で会話状況が変わったかを LLM で判定
- 新しい質問、新しい話題、状況の変化を検知

**実装**:

**実装メソッド**: `_check_conversation_situation_changed()`

**判定方法**:

- 前回の介入時の会話ログと現在の会話ログを比較
- LLM に「CHANGED」または「UNCHANGED」で判定させる

**プロンプト**: `prompts/eavesdrop_conversation_situation_changed_prompt.md`

**判定基準**:

- **CHANGED**: 会話の状況が変わった（新しい質問、新しい話題、状況の変化など）
- **UNCHANGED**: 会話の状況が変わっていない（同じ話題が続いている）

**使用箇所**:

- 同じ会話の場合のみ、会話状況が変わったかを確認
- 変わっていない場合は介入しない

### 5. 判定プロンプトの改善

**改善**:

- 会話が終了しようとしている時の判定を追加
- 判定の優先順位を明確化
- 会話の状態を考慮した判定を指示

**変更点**:

- 「会話が終了しようとしている時は介入しない」という指示を追加
- 判定の優先順位を更新（会話終了の判定を最優先に）
- 決めつけ的な発言の判定を追加

### 6. 応答生成プロンプトの改善

**改善**:

- 参加者間の誤解が発生している時の応答方法を追加
- 同じ内容を繰り返し提案しないよう指示
- 会話の流れに応じた応答を指示

**変更点**:

- 「参加者間の誤解が発生している時」の応答方法を追加
- 「同じ内容を繰り返し提案しない」という指示を追加

## オーバーフィッティング対策

以下の対策を実施しました：

1. **一般的な原則に基づく実装**

   - 特定のキーワードに過度に依存しない
   - 会話の流れ、雰囲気、状態という一般的な原則に基づく判定
   - LLM 判定を活用し、機械的なルールに依存しない

2. **柔軟性の確保**

   - LLM 判定を活用し、機械的なルールに依存しない
   - 会話の状態を分析し、状況に応じた判定を行う
   - トピック、参加者、時間的な連続性、会話の文脈を総合的に判断

3. **過度に複雑なルールの回避**

   - シンプルで理解しやすい実装
   - 設定項目は最小限に（最小間隔のみ）
   - 介入回数の制限は LLM 判定に委ねる

4. **一般的な表現の使用**
   - 特定の会話パターンに特化しない
   - LLM で会話の文脈と雰囲気を総合的に判断
   - プロンプトで一般的な判断基準を指示

## 設定項目

**設定ファイル**: `src/kotonoha_bot/config.py`

| 設定項目                                      | デフォルト値                 | 説明                 |
| --------------------------------------------- | ---------------------------- | -------------------- |
| `EAVESDROP_MIN_INTERVENTION_INTERVAL_MINUTES` | 10                           | 介入の最小間隔（分） |
| `EAVESDROP_JUDGE_MODEL`                       | `anthropic/claude-haiku-4-5` | 判定用モデル         |

**介入履歴の保持期間**: 1 時間（コード内で固定）

**キャッシュの有効期限**: 5 分間（コード内で固定）

**注意**: 介入回数の制限は LLM 判定に委ねられているため、設定項目は最小間隔のみです。

## 期待される効果

1. **過度な介入の防止**

   - 同じ会話で過度に介入することがなくなる
   - 会話の自然な流れを妨げない
   - 最小間隔チェックと会話状況の変化判定により、適切なタイミングでのみ介入

2. **会話の状態を考慮した判定**

   - 会話が終了しようとしている時は介入しない
   - 誤解が発生している時は適切にファシリテート
   - LLM 判定により、会話の文脈と雰囲気を総合的に判断

3. **より適切な応答**

   - 会話の流れに応じた応答
   - 誤解を深める可能性のある発言を避ける
   - 同じ内容を繰り返し提案しない

4. **柔軟な判定**

   - 機械的なルールに依存しない
   - 会話の内容を分析し、状況に応じた判定
   - トピックが同じでも時間が経過していれば別の会話として扱える

## 実装の流れ

### 介入判定の流れ

1. **会話状態の分析**: 会話が終了しようとしている場合は介入をブロック
2. **介入履歴の確認**: 介入履歴がある場合、会話状況が変わったかをチェック
3. **最小間隔チェック**: 最後の介入から 10 分経過しているか確認
4. **同じ会話判定**: LLM で前回の介入時の会話と現在の会話が同じかどうかを判定
5. **会話状況の変化判定**: 同じ会話の場合、会話状況が変わったかを LLM で判定
6. **介入判定**: LLM で発言すべきかどうかを判定
7. **介入の記録**: 介入した場合、介入履歴に記録

詳細は [「同じ会話」の定義](./conversation_definition.md) を参照してください。

## 今後の改善案

1. **会話の状態追跡の強化**

   - より詳細な状態分析
   - 会話の流れの変化をより正確に検知

2. **介入履歴の可視化**

   - デバッグ用のログ出力
   - 介入履歴の確認機能

3. **プロンプトの継続的な改善**

   - 実際の使用状況に基づいた改善
   - より自然な応答の生成

4. **キャッシュ機能の拡張**

   - 会話状態判定の結果もキャッシュ
   - トークン消費のさらなる削減

## 注意事項

- 設定項目は環境に応じて調整してください
- 過度に厳しい制限を設定すると、必要な時に介入できなくなる可能性があります
- 会話の状態判定は LLM 判定に基づいているため、判定の精度はプロンプトの品質に依存します
- エラー時は安全側に倒す実装になっているため、エラーが発生しても会話の進行を妨げません

## 関連ドキュメント

- [「同じ会話」の定義](./conversation_definition.md)
- [会話状態判定の LLM 判定実装](./conversation_state_llm_judgment.md)
- [聞き耳型介入機能 詳細仕様書](../specifications/eavesdrop-specification.md)

---

**作成日**: 2025 年 1 月  
**最終更新日**: 2026 年 1 月（現在の実装に基づいて改訂）  
**実装状況**: ✅ 実装完了
