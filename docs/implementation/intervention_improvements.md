# 聞き耳型介入機能の改善

## 概要

評価レポート（`docs/analysis/intervention_evaluation_2024.md`）に基づき、オーバーフィッティングを避けつつ、一般的な原則に基づいた改善を実施しました。

## 改善内容

### 1. 介入履歴の追跡機能

**問題**: 同じ会話で 3 回も介入しており、会話の自然な流れを妨げていた

**改善**:

- チャンネルごとの介入履歴を追跡
- 介入の最小間隔を設定（デフォルト: 10 分）
- 同じ会話での最大介入回数を制限（デフォルト: 30 分以内に 2 回まで）

**実装**:

- `LLMJudge`クラスに`intervention_history`を追加
- `_should_allow_intervention()`メソッドで介入の可否を判定
- `_record_intervention()`メソッドで介入を記録

**設定項目**:

- なし（LLM 判定に委ねられているため）

### 2. 会話の状態判定機能

**問題**: 会話が終了しようとしている時や、誤解が発生している時を検知できていなかった

**改善**:

- 会話の状態を分析する機能を追加
- 会話が終了しようとしている場合は介入しない
- 誤解が発生している場合は、ファシリテートが必要な状況として判定

**実装**:

- `_analyze_conversation_state()`メソッドで会話の状態を分析
- 状態: `"active"`, `"ending"`, `"misunderstanding"`, `"conflict"`
- オーバーフィッティングを避けるため、一般的な表現のみを検出

**検出する表現**:

- 会話終了: 「これ以上」「以上です」「以上になります」「申し上げることはありません」など
- 誤解: 「誤解」「勘違い」「違う」「そうではない」など

### 3. 判定プロンプトの改善

**改善**:

- 会話が終了しようとしている時の判定を追加
- 判定の優先順位を明確化
- 会話の状態を考慮した判定を指示

**変更点**:

- 「会話が終了しようとしている時は介入しない」という指示を追加
- 判定の優先順位を更新（会話終了の判定を最優先に）

### 4. 応答生成プロンプトの改善

**改善**:

- 参加者間の誤解が発生している時の応答方法を追加
- 同じ内容を繰り返し提案しないよう指示
- 会話の流れに応じた応答を指示

**変更点**:

- 「参加者間の誤解が発生している時」の応答方法を追加
- 「同じ内容を繰り返し提案しない」という指示を追加

## オーバーフィッティング対策

以下の対策を実施しました：

1. **一般的な原則に基づく実装**

   - 特定のキーワードに過度に依存しない
   - 会話の流れ、雰囲気、状態という一般的な原則に基づく判定

2. **柔軟性の確保**

   - LLM 判定を活用し、機械的なルールに依存しない
   - 会話の状態を分析し、状況に応じた判定を行う

3. **過度に複雑なルールの回避**

   - シンプルで理解しやすい実装
   - 設定項目は最小限に

4. **一般的な表現の使用**
   - 特定の会話パターンに特化しない
   - 一般的に使われる表現のみを検出

## 設定項目

介入タイミングと回数は LLM 判定に委ねられているため、設定項目はありません。

## 期待される効果

1. **過度な介入の防止**

   - 同じ会話で過度に介入することがなくなる
   - 会話の自然な流れを妨げない

2. **会話の状態を考慮した判定**

   - 会話が終了しようとしている時は介入しない
   - 誤解が発生している時は適切にファシリテート

3. **より適切な応答**
   - 会話の流れに応じた応答
   - 誤解を深める可能性のある発言を避ける

## 今後の改善案

1. **会話の状態追跡の強化**

   - より詳細な状態分析
   - 会話の流れの変化をより正確に検知

2. **介入履歴の可視化**

   - デバッグ用のログ出力
   - 介入履歴の確認機能

3. **プロンプトの継続的な改善**
   - 実際の使用状況に基づいた改善
   - より自然な応答の生成

## 注意事項

- 設定項目は環境に応じて調整してください
- 過度に厳しい制限を設定すると、必要な時に介入できなくなる可能性があります
- 会話の状態判定は一般的な表現に基づいているため、特殊な表現は検出できない場合があります
