# 実装ロードマップ

段階的な実装計画と各段階での実装順序を定義します。

## 1. 実装方針

### 1.1 段階的実装のメリット

- **早期の動作確認**: 各段階で動作する最小限の機能を実装し、早期に動作確認できる
- **リスクの低減**: 小さな単位で実装・テストすることで、問題を早期に発見できる
- **学習効果**: 各段階で学んだことを次の段階に活かせる
- **柔軟な変更**: 要件変更に柔軟に対応できる
- **進捗管理**: 明確なマイルストーンで進捗を管理しやすい

### 1.2 実装原則

1. **動作する最小限の機能を優先**: 各段階で必ず動作する状態を作る
2. **テスト可能な状態を維持**: 各段階でテスト可能な状態を保つ
3. **リファクタリングを適宜実施**: コードの品質を維持しながら進める
4. **ドキュメントを更新**: 実装と同時にドキュメントも更新

---

## 2. 実装状況サマリー

| Phase        | 実装状況  | 期間     | 主要機能                                             |
| ------------ | --------- | -------- | ---------------------------------------------------- |
| **Phase 1**  | ✅ 完了   | 実装済み | MVP（メンション応答型、セッション管理）              |
| **Phase 2**  | ✅ 完了   | 実装済み | NAS デプロイ、Docker 化、バックアップ                |
| **Phase 3**  | ✅ 完了   | 実装済み | CI/CD、テスト、コード品質                            |
| **Phase 4**  | ✅ 完了   | 実装済み | メッセージ長制限、バッチ同期                         |
| **Phase 5**  | ✅ 完了   | 実装済み | スレッド型、聞き耳型                                 |
| **Phase 6**  | ✅ 完了   | 実装済み | レート制限、コマンド、エラーハンドリング強化         |
| **Phase 7**  | ✅ 完了   | 実装済み | aiosqlite への移行（非同期化）                       |
| **Phase 8**  | ⏳ 未実装 | 10-15 日 | PostgreSQL への移行（pgvector 対応）                 |
| **Phase 9**  | ⏳ 未実装 | 2-3 日   | ハイブリッド検索（pg_trgm）                           |
| **Phase 10** | ⏳ 未実装 | 2-3 日   | Reranking（オプション）                               |
| **Phase 11** | ⏳ 未実装 | 10-15 日 | 完全リファクタリング（非同期コードの整理を含む）     |
| **Phase 12** | ⏳ 未実装 | 3-6 日   | 高度なモニタリング機能（管理者用ダッシュボード含む） |
| **Phase 13** | ⏳ 未実装 | 2-3 日   | コスト管理機能                                       |
| **Phase 14** | ⏳ 未実装 | 3-4 日   | 監査ログ機能                                         |
| **Phase 15** | ⏳ 未実装 | 2-3 日   | 設定管理機能                                         |
| **Phase 16** | ⏳ 未実装 | 2-3 日   | パフォーマンス分析                                   |
| **Phase 17** | ⏳ 未実装 | 1-2 日   | ログ出力の強化                                       |
| **Phase 18** | ⏳ 未実装 | 2-3 日   | モデル切り替えオプション                             |
| **Phase 19** | ⏳ 未実装 | 1-2 日   | バックアップの自動化強化                             |
| **Phase 20** | ⏳ 未実装 | 2-3 日   | データベース最適化                                   |
| **Phase 21** | ⏳ 未実装 | 2-3 日   | コスト計算機能                                       |
| **Phase 22** | ⏳ 未実装 | 15-20 日 | 統合知識ベース機能（会話・添付ファイル・ウェブ）   |
| **Phase 23** | ⏳ 未実装 | 10-15 日 | 会話の要約・ハイライト機能                           |
| **Phase 24** | ⏳ 未実装 | 8-12 日  | 議題提案機能                                         |
| **Phase 25** | ⏳ 未実装 | 5-10 日  | 聞き耳モードでの自動リアクション機能                 |
| **Phase 26** | ⏳ 未実装 | 5-8 日   | ポジティブフィードバック生成機能                     |
| **Phase 27** | ⏳ 未実装 | 5-8 日   | 翻訳要約機能                                         |
| **Phase 28** | ⏳ 未実装 | 20-30 日 | 音声チャンネル機能（要約・議事録、合成音声発話）     |
| **Phase 29** | ⏳ 未実装 | 15-20 日 | コンテキスト理解の向上機能                           |

---

## 3. フェーズ別実装計画

### Phase 1: MVP（メンション応答型）✅ 完了

**目標**: Discord 上でメンションされた時に LiteLLM 経由で LLM API を使って応答できる最小限の Bot

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

- ✅ 環境構築と Discord 接続
- ✅ AI 応答機能（メンション応答型）
  - ✅ LiteLLM 統合
  - ✅ システムプロンプトの実装
  - ✅ 動的プロンプト生成（日付情報の注入）
  - ✅ フォールバック機能
- ✅ セッション管理と会話履歴保持
  - ✅ SQLite データベースのセットアップ
  - ✅ ChatSession クラスの実装
  - ✅ セッション管理モジュール
  - ✅ 会話履歴の保持と復元
- ✅ 基本的なエラーハンドリング
- ✅ ログ出力機能

**詳細**: [Phase 1 実装完了報告](./phases/phase01.md)

---

### Phase 2: NAS デプロイ ✅ 完了

**目標**: Phase 1 で実装済みの Bot を NAS 上で 24 時間稼働させ、本番環境として運用できるようにする

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

- ✅ Dockerfile の作成（マルチステージビルド）
- ✅ Docker Compose の作成
- ✅ NAS へのデプロイ（Synology Container Manager）
- ✅ バックアップ機能（SQLite オンラインバックアップ、gzip 圧縮）
- ✅ ログ管理（RotatingFileHandler）
- ✅ ヘルスチェック機能（HTTP エンドポイント）
- ✅ セキュリティ設定（非 root ユーザーでの実行）

**詳細**: [Phase 2 実装完了報告](./phases/phase02.md)

---

### Phase 3: CI/CD と運用機能 ✅ 完了

**目標**: CI/CD パイプラインを構築し、運用に必要な機能を実装する

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

- ✅ テストフレームワーク（pytest）の設定
- ✅ コード品質ツールの設定（Ruff、ty）
- ✅ GitHub Actions CI ワークフロー（lint、format、type-check、test）
- ✅ GitHub Actions ビルドワークフロー（Docker イメージのビルド・プッシュ）
- ✅ GHCR への自動プッシュ（マルチプラットフォーム: amd64、arm64）
- ✅ Watchtower による自動更新機能
- ✅ 通知機能（Discord Webhook、オプション）

**詳細**: [Phase 3 実装完了報告](./phases/phase03.md)

---

### Phase 4: 機能改善 ✅ 完了

**目標**: Phase 1 で実装した機能の改善と不足機能の追加

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

#### 4.1 メッセージ長制限対応

- ✅ メッセージ分割機能の実装
  - ✅ 2000 文字超の応答を検知
  - ✅ 文の区切り（句点、改行）で分割
  - ✅ 連番を付与して複数メッセージに分割
  - ✅ Embed の活用（オプション、6000 文字制限あり）

#### 4.2 セッション同期機能の改善

- ✅ バッチ同期の定期実行タスク
  - ✅ `discord.ext.tasks` または `asyncio` を使用
  - ✅ 5 分ごとにアイドル状態のセッションを自動保存
  - ✅ `cleanup_old_sessions` の定期実行（1 時間ごと）

#### 4.3 エラーハンドリングの改善

- ✅ メッセージ追加時の自動保存
  - ✅ `add_message` 後に自動的に `save_session` を呼ぶ（オプション）
  - ✅ または、バッチ同期に任せる

**詳細**: [Phase 4 実装完了報告](./phases/phase04.md)

---

### Phase 5: 会話の契機拡張（スレッド型・聞き耳型）✅ 完了

**目標**: 3 つの会話の契機（メンション/スレッド/聞き耳型）を実装する

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

#### 5.1 メッセージルーターの実装

- ✅ `router/message_router.py`: メッセージルーティング
- ✅ 会話の契機判定ロジック
  - ✅ メンション応答型の判定（既存）
  - ✅ スレッド型の判定
  - ✅ 聞き耳型の判定

#### 5.2 スレッド型の実装

- ✅ メンション検知時の自動スレッド作成
- ✅ スレッド名の生成（メッセージの最初の 50 文字、文の区切りで切る）
- ✅ スレッド内での会話継続（メンション不要）
- ✅ スレッドアーカイブ検知
- ✅ アーカイブ時のセッション保存

#### 5.3 聞き耳型の実装

- ✅ `eavesdrop/llm_judge.py`: LLM 判断機能（アプローチ 1）
  - ✅ 会話ログの一時保存（直近 20 件）
  - ✅ 判定フェーズ（裁判官）の実装
  - ✅ 発言生成フェーズ（演者）の実装
  - ✅ 判定用プロンプトの最適化
- [ ] `eavesdrop/rule_judge.py`: ルールベース判断機能（アプローチ 2、オプション）
  - [ ] キーワード検知
  - [ ] 盛り上がり検知
  - [ ] ランダム判定
- ✅ チャンネルごとの有効/無効設定
- ✅ メインチャンネルへの直接投稿機能

#### 5.4 統一インターフェースの実装

- ✅ 3 つの方式を統一的に扱うインターフェース
- ✅ セッションキーの統一管理
  - ✅ メンション応答型: `mention:{user_id}`
  - ✅ スレッド型: `thread:{thread_id}`
  - ✅ 聞き耳型: `eavesdrop:{channel_id}`

**詳細**: [Phase 5 実装完了報告](./phases/phase05.md)

---

### Phase 6: 高度な機能（レート制限・コマンド・エラーハンドリング強化）✅ 完了

**目標**: レート制限対応、スラッシュコマンド機能、エラーハンドリングの強化を実装し、運用性とユーザー体験を向上させる

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

#### Step 1: レート制限モニタリングの実装 ✅

- ✅ `src/kotonoha_bot/rate_limit/__init__.py` の作成
- ✅ `src/kotonoha_bot/rate_limit/monitor.py` の作成
  - ✅ API リクエスト数の追跡
  - ✅ レート制限の接近を検知
  - ✅ 警告ログの出力
- ✅ `litellm_provider.py` への統合

#### Step 2: トークンバケットアルゴリズムの実装 ✅

- ✅ `src/kotonoha_bot/rate_limit/token_bucket.py` の作成
  - ✅ リクエストレートの制御
  - ✅ バースト対応
  - ✅ トークンの自動補充
- ✅ `litellm_provider.py` への統合

#### Step 3: リクエストキューイングの実装 ✅

- ✅ `src/kotonoha_bot/rate_limit/request_queue.py` の作成
  - ✅ リクエストのキューイング
  - ✅ 優先度管理（メンション > スレッド > 聞き耳型）
  - ✅ 非同期処理
- ✅ `handlers.py` への統合

#### Step 4: スラッシュコマンドの実装 ✅

- ✅ `src/kotonoha_bot/commands/__init__.py` の作成
- ✅ `src/kotonoha_bot/commands/chat.py` の作成
  - ✅ `/chat reset` コマンド（会話履歴リセット）
  - ✅ `/chat status` コマンド（セッション状態表示）
  - [ ] `/chat start` コマンド（スレッド型開始、未実装）
- ✅ `main.py` でのコマンド登録
- ✅ コマンドの同期（`bot.tree.sync()`）

#### Step 4.5: 応答メッセージにモデル情報フッターを追加 ✅

- ✅ `src/kotonoha_bot/utils/message_formatter.py` の作成
- ✅ Embed を使用したメッセージフォーマット関数の実装
- ✅ フッターに使用モデル名を表示
- ✅ `handlers.py` の更新

#### Step 5: エラーハンドリングの強化 ✅

- ✅ `src/kotonoha_bot/errors/__init__.py` の作成
- ✅ `src/kotonoha_bot/errors/discord_errors.py` の作成
- ✅ `src/kotonoha_bot/errors/database_errors.py` の作成
- ✅ `handlers.py` への統合

#### Step 6: テストの実装 ✅

- ✅ `tests/unit/test_rate_limit.py` の作成
- ✅ `tests/unit/test_commands.py` の作成
- ✅ `tests/unit/test_errors.py` の作成

**詳細**: [Phase 6 実装計画](./phases/phase06.md)

---

### Phase 7: aiosqlite への移行 ✅ 完了

**目標**: 同期的な `sqlite3` から非同期対応の `aiosqlite` に移行し、Bot 全体のブロッキング問題を解決する

**実装期間**: 2026 年 1 月 15 日（完了）

**実装済み機能**:

- ✅ `SQLiteDatabase` クラスの全メソッドを `async def` に変更
- ✅ `SessionManager` クラスの DB 操作を呼び出すメソッドを非同期化
- ✅ 呼び出し元の修正（`handlers.py`、`main.py`、`commands/chat.py`）
- ✅ テストの更新（すべてのテストを非同期化）
- ✅ 動作確認とドキュメント更新

**詳細**:

- [ADR-0006: aiosqlite への移行](../architecture/adr/0006-migrate-to-aiosqlite.md)
- [Phase 7 実装計画](./phases/phase07.md)

---

### Phase 8: PostgreSQL への移行 ⏳ 未実装

**目標**: PostgreSQL 18 + pgvector 0.8.1 を新規実装し、ベクトル検索機能とスケーラビリティを実現する

**期間**: 約 10-15 日

**前提条件**: ✅ **Phase 7（aiosqlite への移行）が完了していること**

**実装優先度**: **高**（ベクトル検索・RAG機能の前提条件）

**設計思想**
（[PostgreSQL スキーマ設計書](../architecture/postgresql-schema-design.md) に基づく）:

- **短期記憶（Sessions）**: Discord Botがリアルタイムに読み書きする場所。
  高速動作優先。`sessions` テーブルで管理。
- **長期記憶（Knowledge）**: AI検索用。あらゆるデータ（会話、ファイル、Web）を
  「Source」と「Chunk」に抽象化して管理。
- **Source-Chunk構造**: すべてのデータを「Source（親）」と「Chunk（子）」に抽象化
  することで、将来の機能拡張（動画検索など）にも柔軟に対応。
- **データフロー**: `sessions` テーブルの非アクティブなセッションは、
  バッチ処理によって `knowledge_sources` と `knowledge_chunks` に変換される。

**実装内容**:

- [ ] データベース抽象化レイヤーの実装
- [ ] PostgreSQL 実装の追加（pgvector 拡張、ENUM型、テーブル定義）
- [ ] ベクトル検索機能の実装
- [ ] 知識ベーススキーマの実装
- [ ] Embedding処理の実装
- [ ] セッション知識化処理の実装
- [ ] Docker Compose の更新
- [ ] テストと最適化

**詳細**: [Phase 8 詳細実装計画](./phases/phase08.md)

---

### Phase 9: ハイブリッド検索の実装（推奨）⏳ 未実装

**目標**: pg_trgm を使用したハイブリッド検索を実装し、検索品質を向上させる

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 8（PostgreSQL への移行）が完了していること**

**実装優先度**: **中**（検索品質向上のため推奨）

**実装内容**:

- [ ] ハイブリッド検索メソッドの実装（ベクトル検索 + pg_trgm キーワード検索）
- [ ] ベクトル類似度とキーワード類似度のスコアを組み合わせた検索
- [ ] 検索品質の向上が確認できる（固有名詞の検索精度が向上）

**詳細**: [Phase 8 詳細実装計画 - 11.1 Phase 8.5](./phases/phase08.md#111-phase-85-ハイブリッド検索の実装推奨)

---

### Phase 10: Reranking の実装（オプション）⏳ 未実装

**目標**: Cross-Encoder（Reranker）を使用して検索精度を向上させる

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 8（PostgreSQL への移行）が完了していること**

**実装優先度**: **低**（オプション、CPU負荷を考慮）

**実装内容**:

- [ ] `Reranker` クラスの実装（Cross-Encoder を使用）
- [ ] ベクトル検索の結果を再ランキングできる
- [ ] 環境変数で有効/無効を切り替え可能
- [ ] CPU負荷が許容範囲内であることを確認

**詳細**: [Phase 8 詳細実装計画 - 11.2 Phase 9: Reranking](./phases/phase08.md#112-phase-9-reranking-の実装オプション)

---

### Phase 11: 完全リファクタリング ⏳ 未実装

**目標**: コードベースの品質向上と技術的負債の解消を実現する

**期間**: 約 10-15 日

**前提条件**: ✅ **Phase 7（aiosqlite への移行）が完了していること**、
✅ **Phase 8（PostgreSQL への移行）が完了していること**

**主な改善点**:

- ✅ レイヤードアーキテクチャの明確化
- ✅ 依存性注入の改善
- ✅ 設定管理の階層化と分離
- ✅ エラーハンドリングの統一
- ✅ ログ設定の分離
- ✅ 巨大ファイルの分割（handlers.py 833 行 → 複数モジュールに分割）
- ✅ 型安全性の向上
- ✅ テストの充実
- ✅ フォルダ構造の最適化
- ✅ 重複コードの削除（日付フォーマット、プロンプト読み込み、エラーメッセージ）
- ✅ **重要**: `litellm.py` の戻り値を `tuple[str, dict]` に変更（Phase 13 と Phase 14 で必要）

**実装内容**:

- [ ] コア機能の整理（`core/` ディレクトリ）
- [ ] handlers.py の分割（`bot/handlers/` ディレクトリ）
- [ ] サービス層の整理（`services/` ディレクトリ）
- [ ] データアクセス層の整理（`data/` ディレクトリ）
- [ ] 外部サービス層の整理（`external/` ディレクトリ）
- [ ] 機能別モジュールの整理（`features/` ディレクトリ）
- [ ] ユーティリティの整理（`utils/` ディレクトリ）
- [ ] 型ヒントとドキュメントの充実
- [ ] テストの充実

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 12: 高度なモニタリング機能 ⏳ 未実装

**目標**: 運用性と管理性を向上させるための高度なモニタリング機能を実装する

**期間**: 約 3-6 日（ダッシュボード含む場合は約 5-6 日）

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**

**実装優先度**: **最優先**

**実装内容**:

- [ ] `src/kotonoha_bot/features/monitoring/` ディレクトリを新規作成
  - [ ] `metrics.py`: メトリクス収集クラス
  - [ ] `collector.py`: メトリクス収集ロジック
  - [ ] `dashboard.py`: ダッシュボード機能（管理者用高機能ダッシュボード）
  - [ ] `alerts.py`: アラート機能（閾値超過時の通知）
- [ ] `src/kotonoha_bot/services/monitoring.py`: モニタリングサービスのビジネスロジック
- [ ] `src/kotonoha_bot/external/health.py` を拡張してメトリクスエンドポイントを追加

**機能**:

- [ ] 基本的なメトリクス収集（API リクエスト数、レスポンス時間、エラー率など）
- [ ] メトリクスエンドポイント
- [ ] 管理者用高機能ダッシュボード機能
- [ ] アラート機能（閾値超過時の通知）

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 13: コスト管理機能 ⏳ 未実装

**目標**: トークン使用量とコストを追跡・管理する機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**（`litellm.py` の戻り値変更が完了しているため）

**実装優先度**: **高**

**実装内容**:

- [ ] `src/kotonoha_bot/features/cost_management/` ディレクトリを新規作成
  - [ ] `tracker.py`: トークン使用量の追跡
  - [ ] `calculator.py`: コスト計算機能
  - [ ] `reporter.py`: コストレポート生成
  - [ ] `budget.py`: 予算管理機能（オプション）
- [ ] `src/kotonoha_bot/services/cost_tracking.py`: コスト追跡サービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/models.py`: コストデータモデルを追加

**機能**:

- [ ] トークン使用量の詳細追跡（ユーザー・チャンネル・セッション・モデルごと）
- [ ] コスト計算機能（トークン数からコストを計算、モデルごとのコスト単価管理）
- [ ] コストレポート機能（日次・週次・月次のコスト集計、可視化、エクスポート）
- [ ] 予算管理機能（オプション、予算の設定、予算超過時のアラート、コスト予測）

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 14: 監査ログ機能 ⏳ 未実装

**目標**: 監査ログとコンプライアンス対応を実現する

**期間**: 約 3-4 日

**前提条件**: ✅ **Phase 7（aiosqlite への移行）が完了していること**、
✅ **Phase 8（PostgreSQL への移行）が完了していること**、
✅ **Phase 11（完全リファクタリング）が完了していること**

**実装優先度**: **高**

**実装内容**:

- [ ] `src/kotonoha_bot/features/audit/` ディレクトリを新規作成
  - [ ] `logger.py`: `AuditLogger` クラス（監査ログの記録）
  - [ ] `reporter.py`: 監査レポート生成
- [ ] `src/kotonoha_bot/data/models.py`: 監査ログデータモデルを追加
- [ ] `src/kotonoha_bot/data/database.py`: 監査ログテーブルの作成と操作メソッドを追加
- [ ] `src/kotonoha_bot/bot/handlers/` の各ハンドラーで監査ログを記録（非同期で実行）

**機能**:

- [ ] データベーススキーマの実装（`audit_logs` テーブル、`monthly_usage` テーブル、インデックス）
- [ ] `AuditLogger` クラスの実装
- [ ] すべての応答生成箇所で監査ログを記録（非同期ログ記録）

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 15: 設定管理機能 ⏳ 未実装

**目標**: チャンネルごと、ユーザーごとの設定管理機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**

**実装内容**:

- [ ] `src/kotonoha_bot/commands/settings.py`: `/settings` コマンドの実装
- [ ] `src/kotonoha_bot/services/settings.py`: 設定管理サービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/models.py`: 設定データモデルを追加
- [ ] `src/kotonoha_bot/data/database.py`: 設定の永続化メソッドを追加

**設定項目**:

- [ ] グローバル設定（全サーバー共通、管理者のみ変更可能）
- [ ] チャンネルごとの設定
- [ ] ユーザーごとの設定（オプション）

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 16: パフォーマンス分析 ⏳ 未実装

**目標**: システムのパフォーマンスを分析・監視する機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**

**実装内容**:

- [ ] `src/kotonoha_bot/features/monitoring/performance.py`: パフォーマンス分析機能
- [ ] `src/kotonoha_bot/services/performance.py`: パフォーマンス分析サービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/models.py`: パフォーマンスメトリクスデータモデルを追加

**機能**:

- [ ] パフォーマンスメトリクスの収集（応答時間、スループット、リソース使用率）
- [ ] 分析レポートの生成（日次・週次・月次）
- [ ] ボトルネックの特定（遅延の原因分析、リソース制約の検出）

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 17: ログ出力の強化 ⏳ 未実装

**目標**: ログ出力を強化し、検索・フィルタリング・エクスポート機能を実装する

**期間**: 約 1-2 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**

**実装内容**:

- [ ] `src/kotonoha_bot/core/logging.py` を拡張
  - [ ] 構造化ログ（JSON 形式）のサポート
  - [ ] ログ検索・フィルタリング機能
  - [ ] ログエクスポート機能
- [ ] `src/kotonoha_bot/features/logging/` ディレクトリを新規作成（必要に応じて）

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 18: モデル切り替えオプション ⏳ 未実装

**目標**: メッセージからモデル選択指示を検出し、動的にモデルを切り替える機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**

**実装内容**:

- [ ] `src/kotonoha_bot/features/model_selection/` ディレクトリを新規作成
  - [ ] `selector.py`: モデル選択ロジック（メッセージからモデル指示を検出）
  - [ ] `validator.py`: 許可されたモデル名の検証
- [ ] `src/kotonoha_bot/bot/handlers/` の各ハンドラーでモデル選択機能を使用

**機能**:

- [ ] メッセージからモデル選択指示を検出（例: `@model: claude-opus`）
- [ ] モデル指示をメッセージから除去
- [ ] 許可されていないモデル名の無視
- [ ] 指定モデルが利用できない場合のフォールバック

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 19: バックアップの自動化強化 ⏳ 未実装

**目標**: バックアップの自動化を強化し、スケジュール・検証・通知機能を実装する

**期間**: 約 1-2 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**

**実装内容**:

- [ ] `src/kotonoha_bot/features/automation/backup.py`: バックアップ自動化機能
- [ ] `src/kotonoha_bot/services/automation.py`: 自動化サービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/database.py`: バックアップ検証機能を追加

**機能**:

- [ ] スケジュールバックアップ（定期バックアップの設定）
- [ ] バックアップの自動削除（古いバックアップ）
- [ ] バックアップの検証（整合性チェック、リストアテストの自動実行）
- [ ] バックアップの通知（成功/失敗の通知、ディスク使用量の警告）

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 20: データベース最適化 ⏳ 未実装

**目標**: データベースの最適化を自動化し、パフォーマンスを向上させる機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 8（PostgreSQL への移行）が完了していること**、
✅ **Phase 11（完全リファクタリング）が完了していること**

**実装内容**:

- [ ] `src/kotonoha_bot/features/automation/optimization.py`: データベース最適化機能
- [ ] `src/kotonoha_bot/data/database.py`: 最適化メソッドを追加（`VACUUM`, インデックス再構築など）
- [ ] `src/kotonoha_bot/services/automation.py`: 自動最適化のスケジューリング

**機能**:

- [ ] 自動最適化機能（定期的な `VACUUM` 実行、インデックスの再構築、統計情報の更新）
- [ ] クエリ最適化（スロークエリの検出、インデックスの最適化）
- [ ] データアーカイブ機能（古いセッションのアーカイブ、アーカイブデータの検索）

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 21: コスト計算機能 ⏳ 未実装

**目標**: トークン数からコストを計算し、モデルごとのコスト単価を管理する機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**

**実装内容**:

- [ ] `src/kotonoha_bot/features/audit/cost_calculator.py`: コスト計算機能
- [ ] `src/kotonoha_bot/data/models.py`: コストデータモデルを追加
- [ ] トークン数からコストを計算する実装

**機能**:

- [ ] トークン数からコストを計算
- [ ] モデルごとのコスト単価管理
- [ ] コスト計算の精度向上

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 22: 統合知識ベース機能 ⏳ 未実装

**目標**: 会話、添付ファイル、ウェブから統合的に知識ベースを構築する機能を実装する

**期間**: 約 15-20 日

**前提条件**: ✅ **Phase 8（PostgreSQL への移行）が完了していること**
（pgvector が必要）、✅ **Phase 11（完全リファクタリング）が完了していること**

**実装優先度**: **高**

**実装内容**:

- [ ] `src/kotonoha_bot/features/knowledge_base/` ディレクトリを新規作成
  - [ ] `summarizer.py`: 要約機能
  - [ ] `storage.py`: 知識ベース保存機能
  - [ ] `search.py`: 検索機能
  - [ ] `semantic_search.py`: セマンティック検索機能（オプション）
  - [ ] `file_processor.py`: 添付ファイル処理機能
  - [ ] `web_scraper.py`: ウェブコンテンツ取得機能
  - [ ] `content_integrator.py`: 統合コンテンツ管理機能
- [ ] `src/kotonoha_bot/services/knowledge_base.py`: 知識ベースサービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/models.py`: 知識ベースデータモデルを追加

**機能**:

- [ ] 会話からの知識抽出・要約
- [ ] 添付ファイル（テキスト、PDF、画像など）からの知識抽出
- [ ] ウェブコンテンツ（URL 指定）からの知識抽出
- [ ] 統合検索機能（会話・ファイル・ウェブを横断検索）
- [ ] 知識ベースの更新・管理機能

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 23: 会話の要約・ハイライト機能 ⏳ 未実装

**目標**: 会話の要約とハイライト抽出機能を実装する

**期間**: 約 10-15 日

**前提条件**: ✅ **Phase 8（PostgreSQL への移行）が完了していること**、
✅ **Phase 11（完全リファクタリング）が完了していること**

**実装優先度**: **高**（知識ベース機能と同時に実装）

**実装内容**:

- [ ] `src/kotonoha_bot/features/knowledge_base/` ディレクトリを拡張
  - [ ] `conversation_analyzer.py`: 会話分析機能
  - [ ] `highlight_extractor.py`: ハイライト抽出機能
  - [ ] `conversation_summarizer.py`: 会話要約機能
  - [ ] `highlight_formatter.py`: ハイライトフォーマット機能
- [ ] `src/kotonoha_bot/commands/summary.py`: 要約・ハイライトコマンド
- [ ] `src/kotonoha_bot/services/summary.py`: 要約・ハイライトサービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/models.py`: 要約・ハイライトデータモデルの追加

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 24: 議題提案機能 ⏳ 未実装

**目標**: 未解決事項や継続課題を抽出し、議題を提案する機能を実装する

**期間**: 約 8-12 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**、
✅ **Phase 22（統合知識ベース機能）が完了していること**、
✅ **Phase 23（会話の要約・ハイライト機能）が完了していること**

**実装優先度**: **高**（知識ベース機能と要約・ハイライト機能の後に実装）

**実装内容**:

- [ ] `src/kotonoha_bot/features/agenda/` ディレクトリを新規作成
  - [ ] `issue_extractor.py`: 課題抽出機能
  - [ ] `agenda_generator.py`: 議題生成機能
  - [ ] `priority_ranker.py`: 優先順位付け機能
- [ ] `src/kotonoha_bot/services/agenda.py`: 議題サービスのビジネスロジック
- [ ] `src/kotonoha_bot/commands/agenda.py`: 議題提案コマンド
- [ ] `src/kotonoha_bot/data/models.py`: 議題データモデルの追加

**機能**:

- [ ] 未解決事項の抽出
- [ ] 継続課題の特定（セマンティック検索で関連情報を取得）
- [ ] 議題の優先順位付け
- [ ] 議題の提案・管理

**詳細**: [将来実装予定機能の詳細レビュー](./phases/future_features_review.md)

---

### Phase 25: 聞き耳モードでの自動リアクション機能 ⏳ 未実装

**目標**: 聞き耳モードで会話を分析し、適切なリアクションを自動で付与する機能を実装する

**期間**: 約 5-10 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**

**実装優先度**: **中**

**実装内容**:

- [ ] `src/kotonoha_bot/features/eavesdrop/` ディレクトリを拡張
  - [ ] `reaction_judge.py`: リアクション判定機能
  - [ ] `reaction_manager.py`: リアクション管理機能
- [ ] `src/kotonoha_bot/bot/handlers/eavesdrop.py`: 聞き耳型ハンドラーの拡張
- [ ] `src/kotonoha_bot/services/reaction.py`: リアクションサービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/models.py`: リアクション履歴データモデルの追加

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 26: ポジティブフィードバック生成機能 ⏳ 未実装

**目標**: 会話の感情分析を行い、ポジティブフィードバックと週次サマリーを自動生成する機能を実装する

**期間**: 約 5-8 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**

**実装優先度**: **中**

**実装内容**:

- [ ] `src/kotonoha_bot/features/feedback/` ディレクトリを新規作成
  - [ ] `sentiment_analyzer.py`: 感情分析機能
  - [ ] `positive_feedback_generator.py`: ポジティブフィードバック生成機能
  - [ ] `weekly_summary.py`: 週次サマリー生成機能
- [ ] `src/kotonoha_bot/services/feedback.py`: フィードバックサービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/models.py`: フィードバックデータモデルの追加

**機能**:

- [ ] 会話の感情分析
- [ ] ポジティブフィードバックの自動生成
- [ ] 週次サマリーの自動生成（場面緘黙支援を考慮した表現）
- [ ] フィードバック履歴の管理

**詳細**: [将来実装予定機能の詳細レビュー](./phases/future_features_review.md)

---

### Phase 27: 翻訳要約機能 ⏳ 未実装

**目標**: 多言語対応の強化として、会話や要約の翻訳機能を実装する

**期間**: 約 5-8 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**

**実装優先度**: **中**（多言語対応の強化として）

**実装内容**:

- [ ] `src/kotonoha_bot/features/translation/` ディレクトリを新規作成
  - [ ] `translator.py`: 翻訳機能
  - [ ] `summary_translator.py`: 要約翻訳機能
- [ ] `src/kotonoha_bot/services/translation.py`: 翻訳サービスのビジネスロジック
- [ ] `src/kotonoha_bot/commands/translate.py`: 翻訳コマンド

**機能**:

- [ ] 会話の多言語翻訳機能
- [ ] 要約の多言語翻訳機能
- [ ] 自動言語検出
- [ ] 翻訳品質の管理

**詳細**: [将来実装予定機能の詳細レビュー](./phases/future_features_review.md)

---

### Phase 28: 音声チャンネル機能（要約・議事録、合成音声発話）⏳ 未実装

**目標**: 音声チャンネルでの要約・議事録生成と合成音声発話機能を実装する

**期間**: 約 20-30 日

**前提条件**: ✅ **Phase 11（完全リファクタリング）が完了していること**

**実装優先度**: **低**（技術検討後に実装）

**実装内容**:

- [ ] `src/kotonoha_bot/features/knowledge_base/` ディレクトリを拡張
  - [ ] `voice_recorder.py`: 音声録音機能
  - [ ] `transcription.py`: 文字起こし機能
  - [ ] `meeting_minutes.py`: 議事録生成機能
  - [ ] `tts_generator.py`: 合成音声生成機能
- [ ] `src/kotonoha_bot/external/voice/` ディレクトリを新規作成
- [ ] `src/kotonoha_bot/external/tts/` ディレクトリを新規作成

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

### Phase 29: コンテキスト理解の向上機能 ⏳ 未実装

**目標**: ベクトル DB と Embedding API を使用してコンテキスト理解を向上させる機能を実装する

**期間**: 約 15-20 日

**前提条件**: ✅ **Phase 8（PostgreSQL への移行）が完了していること**
（pgvector が必要）、✅ **Phase 11（完全リファクタリング）が完了していること**

**実装優先度**: **低**（技術検討後に実装）

**実装内容**:

- [ ] `src/kotonoha_bot/features/knowledge_base/` ディレクトリを拡張
  - [ ] `vector_store.py`: ベクトルストア機能
  - [ ] `embedding_generator.py`: 埋め込み生成機能
  - [ ] `semantic_search.py`: セマンティック検索機能
  - [ ] `context_retriever.py`: コンテキスト取得機能
- [ ] `src/kotonoha_bot/external/vector/` ディレクトリを新規作成
- [ ] `src/kotonoha_bot/external/embedding/` ディレクトリを新規作成

**詳細**: [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

## 4. 実装の進め方

### 4.1 各フェーズの進め方

1. **実装**: フェーズの内容を実装
2. **テスト**: 動作確認とテスト
3. **コミット**: 動作する状態でコミット
4. **ドキュメント更新**: 必要に応じてドキュメントを更新
5. **次のフェーズへ**: 次のフェーズに進む

### 4.2 コミット方針

- **フェーズごとのコミット**: 各フェーズが完了したらコミット
- **明確なコミットメッセージ**: 何を実装したか明確に
- **動作確認**: コミット前に必ず動作確認

### 4.3 テスト方針

- **各フェーズでテスト**: 各フェーズで動作確認
- **手動テスト**: まずは手動で動作確認
- **自動テスト**: 可能な範囲で自動テストを追加

---

## 5. リスク管理

### 5.1 各フェーズでのリスク

**Phase 1-7**: ✅ 完了（リスクは解消済み）

**Phase 8**:

- PostgreSQL 新規実装による既存機能の破壊
- 新規設計のため、SQLiteからの移行ツールは作成せず、既存のデータは破棄
- パフォーマンスの劣化リスク
- バックアップの権限問題（バインドマウント使用時）

**Phase 11**:

- リファクタリングによる既存機能の破壊
- テストカバレッジの不足による回帰バグ
- パフォーマンス最適化による予期しない副作用

### 5.2 対策

- **早期の動作確認**: 各フェーズで動作確認
- **ドキュメント参照**: 実装前にドキュメントを確認
- **段階的な実装**: 小さな単位で実装
- **テストの実施**: 各フェーズでテストを実施

---

## 6. 次のステップ

現在の実装状況:

- ✅ **Phase 1**: 完了（MVP、メンション応答型）
- ✅ **Phase 2**: 完了（NAS デプロイ、Docker 化）
- ✅ **Phase 3**: 完了（CI/CD と運用機能）
- ✅ **Phase 4**: 完了（機能改善）
- ✅ **Phase 5**: 完了（会話の契機拡張、スレッド型・聞き耳型）
- ✅ **Phase 6**: 完了（高度な機能、レート制限・コマンド・エラーハンドリング強化）
- ✅ **Phase 7**: 完了（aiosqlite への移行、非同期化）

次の実装ステップは **Phase 8（PostgreSQL への移行）** です。

### 6.1 推奨実装順序

1. ✅ **Phase 7（aiosqlite への移行）**: 完了（2026 年 1 月 15 日）

2. **Phase 8（PostgreSQL への移行）**: Phase 7 完了後に実施
   - **重要**: ベクトル検索機能の実現（pgvector を使用）
   - **重要**: Phase 22-24 の知識ベース機能の前提条件
   - データベース抽象化レイヤーの確立
   - スケーラビリティの確保

3. **Phase 9（ハイブリッド検索）**: Phase 8 完了後に実施（推奨）
   - 検索品質の向上

4. **Phase 10（Reranking）**: Phase 8 完了後に実施（オプション）
   - CPU負荷を考慮

5. **Phase 11（完全リファクタリング）**: Phase 8 完了後に実施
   - 非同期コードを基にリファクタリングする方が効率的
   - **重要**: `litellm.py` の戻り値を `tuple[str, dict]` に変更（Phase 13 と Phase 14 で必要）
   - 重複コードの削除

6. **Phase 12-21**: Phase 11 完了後に実施
   - **Phase 12**: 高度なモニタリング機能（運用の基盤、最優先）⭐⭐⭐⭐⭐
   - **Phase 13**: コスト管理機能（Phase 11 でトークン情報が取得できる状態）⭐⭐⭐⭐☆
   - **Phase 14**: 監査ログ機能（Phase 8, 11 でトークン情報が取得できる状態）⭐⭐⭐⭐☆
   - **Phase 15-17**: 設定管理、パフォーマンス分析、ログ強化
   - **Phase 18-20**: 自動化・最適化機能
   - **Phase 21**: コスト計算機能

7. **Phase 22-27**: ロードマップ外の高優先度機能（Phase 8 で pgvector が必要）
   - **Phase 22**: 統合知識ベース機能（pgvector を使用）⭐⭐⭐⭐⭐
   - **Phase 23**: 会話の要約・ハイライト機能（知識ベース機能と同時に実装）⭐⭐⭐⭐⭐
   - **Phase 24**: 議題提案機能（知識ベース機能の後に実装）⭐⭐⭐⭐⭐
   - **Phase 25**: 聞き耳モードでの自動リアクション機能⭐⭐⭐⭐⭐
   - **Phase 26**: ポジティブフィードバック生成機能⭐⭐⭐⭐☆
   - **Phase 27**: 翻訳要約機能（多言語対応の強化）⭐⭐⭐⭐☆

8. **Phase 28-29**: ロードマップ外の低優先度機能（技術検討後）
   - **Phase 28**: 音声チャンネル機能（要約・議事録、合成音声発話）⭐⭐⭐☆☆
   - **Phase 29**: コンテキスト理解の向上機能（pgvector を使用）⭐⭐⭐☆☆

**詳細**:

- [ADR-0006: aiosqlite への移行](../architecture/adr/0006-migrate-to-aiosqlite.md)
- [ADR-0007: PostgreSQL への移行](../architecture/adr/0007-migrate-to-postgresql.md)
- [Phase 8 詳細実装計画](./phases/phase08.md)
- [Phase 9 実装計画](./phases/phase09_detailed_plan.md)

---

**作成日**: 2026 年 1 月 14 日  
**最終更新日**: 2026 年 1 月 18 日（フェーズ番号を整理、小数点を削除、文書構造を再構築）  
**バージョン**: 11.0  
**作成者**: kotonoha-bot 開発チーム

### 更新履歴

- **v11.0** (2026-01-18): フェーズ番号を整理（小数点を削除、連番に統一）、文書構造をゼロベースで再構築、重複を削除
- **v10.0** (2026-01-18): 全機能を統合（統合知識ベース、翻訳要約、
  ポジティブフィードバック、議題提案、管理者用ダッシュボード）、
  実装順序と優先度を再整理
- **v9.0** (2026-01-17): Phase 8+ の内容を統合、Phase 9-11 をゼロベースで再構築、実装優先度を明確化
- **v8.0** (2026-01-15): Phase 7 の実装完了を反映、実装状況を更新
- **v7.0** (2026-01): Phase 6 の実装完了を反映、実装状況を更新
- **v6.0** (2026-01-15): Phase 7-11 の実装計画を追加、将来の機能拡張案を追加
- **v5.0** (2026-01-15): Phase 5 の実装完了を反映、実装状況を更新
- **v4.0** (2026-01-15): Phase 3 の実装完了を反映、実装状況を更新
- **v3.0** (2026-01-15): 実装状況に基づいてフェーズを再整理、各フェーズで実装すべき機能を明確化
- **v2.0** (2026-01-14): 実装状況の反映、チェックボックスの更新
- **v1.0** (2026-01-14): 初版リリース
