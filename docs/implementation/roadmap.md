# 実装ロードマップ

段階的な実装計画と各段階での実装順序を定義します。

## 1. 実装方針

### 1.1 段階的実装のメリット

- **早期の動作確認**: 各段階で動作する最小限の機能を実装し、早期に動作確認できる
- **リスクの低減**: 小さな単位で実装・テストすることで、問題を早期に発見できる
- **学習効果**: 各段階で学んだことを次の段階に活かせる
- **柔軟な変更**: 要件変更に柔軟に対応できる
- **進捗管理**: 明確なマイルストーンで進捗を管理しやすい

### 1.2 実装原則

1. **動作する最小限の機能を優先**: 各段階で必ず動作する状態を作る
2. **テスト可能な状態を維持**: 各段階でテスト可能な状態を保つ
3. **リファクタリングを適宜実施**: コードの品質を維持しながら進める
4. **ドキュメントを更新**: 実装と同時にドキュメントも更新

---

## 2. 実装段階の全体像と実装状況

### 実装状況サマリー

| Phase        | 段階              | 実装状況  | 期間     | 主要機能                                             |
| ------------ | ----------------- | --------- | -------- | ---------------------------------------------------- |
| **Phase 1**  | 段階 1, 3, 4 統合 | ✅ 完了   | 実装済み | MVP（メンション応答型、セッション管理）              |
| **Phase 2**  | 段階 2            | ✅ 完了   | 実装済み | NAS デプロイ、Docker 化、バックアップ                |
| **Phase 3**  | 段階 7            | ✅ 完了   | 実装済み | CI/CD、テスト、コード品質                            |
| **Phase 4**  | -                 | ✅ 完了   | 実装済み | メッセージ長制限、バッチ同期                         |
| **Phase 5**  | 段階 5            | ✅ 完了   | 実装済み | スレッド型、聞き耳型                                 |
| **Phase 6**  | 段階 6            | ⏳ 未実装 | 8-10 日  | レート制限、コマンド、エラーハンドリング強化         |
| **Phase 7**  | -                 | ⏳ 未実装 | 10-15 日 | 完全リファクタリング                                 |
| **Phase 8**  | -                 | ⏳ 未実装 | 12-18 日 | 高度な運用機能（モニタリング・設定管理・コスト管理） |
| **Phase 9**  | -                 | ⏳ 未実装 | 5-8 日   | 自動化・最適化機能                                   |
| **Phase 10** | -                 | ⏳ 未実装 | 3-4 日   | 監査機能                                             |

---

## Phase 1: MVP（メンション応答型）✅ 完了

**目標**: Discord 上でメンションされた時に LiteLLM 経由で LLM API を使って応答できる最小限の Bot

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

- ✅ 環境構築と Discord 接続
- ✅ AI 応答機能（メンション応答型）
  - ✅ LiteLLM 統合
  - ✅ システムプロンプトの実装
  - ✅ 動的プロンプト生成（日付情報の注入）
  - ✅ フォールバック機能
- ✅ セッション管理と会話履歴保持
  - ✅ SQLite データベースのセットアップ
  - ✅ ChatSession クラスの実装
  - ✅ セッション管理モジュール
  - ✅ 会話履歴の保持と復元
- ✅ 基本的なエラーハンドリング
- ✅ ログ出力機能

**未実装機能（Phase 4 で実装予定）**:

- ❌ メッセージ長制限対応（2000 文字超の場合は分割）

**詳細**: [Phase 1 実装完了報告](./phases/phase1.md)

---

## Phase 2: NAS デプロイ ✅ 完了

**目標**: Phase 1 で実装済みの Bot を NAS 上で 24 時間稼働させ、本番環境として運用できるようにする

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

- ✅ Dockerfile の作成（マルチステージビルド）
- ✅ Docker Compose の作成
- ✅ NAS へのデプロイ（Synology Container Manager）
- ✅ バックアップ機能（SQLite オンラインバックアップ、gzip 圧縮）
- ✅ ログ管理（RotatingFileHandler）
- ✅ ヘルスチェック機能（HTTP エンドポイント）
- ✅ セキュリティ設定（非 root ユーザーでの実行）

**詳細**: [Phase 2 実装完了報告](./phases/phase2.md)

---

## Phase 3: CI/CD と運用機能 ✅ 完了

**目標**: CI/CD パイプラインを構築し、運用に必要な機能を実装する

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

- ✅ テストフレームワーク（pytest）の設定
- ✅ コード品質ツールの設定（Ruff、ty）
- ✅ GitHub Actions CI ワークフロー（lint、format、type-check、test）
- ✅ GitHub Actions ビルドワークフロー（Docker イメージのビルド・プッシュ）
- ✅ GHCR への自動プッシュ（マルチプラットフォーム: amd64、arm64）
- ✅ Watchtower による自動更新機能
- ✅ 通知機能（Discord Webhook、オプション）

**詳細**: [Phase 3 実装完了報告](./phases/phase3.md)

---

## Phase 4: 機能改善 ✅ 完了

**目標**: Phase 1 で実装した機能の改善と不足機能の追加

**期間**: 約 3-5 日

**実装すべき機能**:

### 4.1 メッセージ長制限対応

- [ ] メッセージ分割機能の実装
  - [ ] 2000 文字超の応答を検知
  - [ ] 文の区切り（句点、改行）で分割
  - [ ] 連番を付与して複数メッセージに分割
  - [ ] Embed の活用（オプション、6000 文字制限あり）

### 4.2 セッション同期機能の改善

- [ ] バッチ同期の定期実行タスク
  - [ ] `discord.ext.tasks` または `asyncio` を使用
  - [ ] 5 分ごとにアイドル状態のセッションを自動保存
  - [ ] `cleanup_old_sessions` の定期実行（1 時間ごと）

### 4.3 エラーハンドリングの改善

- [ ] メッセージ追加時の自動保存
  - [ ] `add_message` 後に自動的に `save_session` を呼ぶ（オプション）
  - [ ] または、バッチ同期に任せる

**完了基準**:

- [ ] 2000 文字超の応答が自動的に分割される
- [ ] バッチ同期が 5 分ごとに実行される
- [ ] セッションクリーンアップが 1 時間ごとに実行される

**詳細**: [Phase 4 実装計画](./phases/phase4.md)

---

## Phase 5: 会話の契機拡張（スレッド型・聞き耳型）✅ 完了

**目標**: 3 つの会話の契機（メンション/スレッド/聞き耳型）を実装する

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

### 5.1 メッセージルーターの実装

- [x] `router/message_router.py`: メッセージルーティング
- [x] 会話の契機判定ロジック
  - [x] メンション応答型の判定（既存）
  - [x] スレッド型の判定
  - [x] 聞き耳型の判定

### 5.2 スレッド型の実装

- [x] メンション検知時の自動スレッド作成
- [x] スレッド名の生成（メッセージの最初の 50 文字、文の区切りで切る）
- [x] スレッド内での会話継続（メンション不要）
- [x] スレッドアーカイブ検知
- [x] アーカイブ時のセッション保存

### 5.3 聞き耳型の実装

- [x] `eavesdrop/llm_judge.py`: LLM 判断機能（アプローチ 1）
  - [x] 会話ログの一時保存（直近 20 件）
  - [x] 判定フェーズ（裁判官）の実装
  - [x] 発言生成フェーズ（演者）の実装
  - [x] 判定用プロンプトの最適化
- [ ] `eavesdrop/rule_judge.py`: ルールベース判断機能（アプローチ 2、オプション）
  - [ ] キーワード検知
  - [ ] 盛り上がり検知
  - [ ] ランダム判定
- [x] チャンネルごとの有効/無効設定
- [x] メインチャンネルへの直接投稿機能

### 5.4 統一インターフェースの実装

- [x] 3 つの方式を統一的に扱うインターフェース
- [x] セッションキーの統一管理
  - [x] メンション応答型: `mention:{user_id}`
  - [x] スレッド型: `thread:{thread_id}`
  - [x] 聞き耳型: `eavesdrop:{channel_id}`

**完了基準**:

- [x] メッセージルーターが実装されている
- [x] スレッド型が動作する（自動スレッド作成）
- [x] 聞き耳型が動作する（アプローチ 1）
- [x] 各方式で会話履歴が正しく管理される
- [x] すべてのテストが通過する（49 テストケース）

**詳細**: [Phase 5 実装完了報告](./phases/phase5.md)

---

## Phase 6: 高度な機能（レート制限・コマンド・エラーハンドリング強化）⏳ 未実装

**目標**: レート制限対応、スラッシュコマンド機能、エラーハンドリングの強化を実装し、運用性とユーザー体験を向上させる

**期間**: 約 8-10 日

**実装ステップ**:

### Step 1: レート制限モニタリングの実装 (2-3 日)

- [ ] `src/kotonoha_bot/rate_limit/__init__.py` の作成
- [ ] `src/kotonoha_bot/rate_limit/monitor.py` の作成
  - [ ] API リクエスト数の追跡
  - [ ] レート制限の接近を検知
  - [ ] 警告ログの出力
- [ ] `litellm_provider.py` への統合

### Step 2: トークンバケットアルゴリズムの実装 (2-3 日)

- [ ] `src/kotonoha_bot/rate_limit/token_bucket.py` の作成
  - [ ] リクエストレートの制御
  - [ ] バースト対応
  - [ ] トークンの自動補充
- [ ] `litellm_provider.py` への統合

### Step 3: リクエストキューイングの実装 (2-3 日)

- [ ] `src/kotonoha_bot/rate_limit/request_queue.py` の作成
  - [ ] リクエストのキューイング
  - [ ] 優先度管理（メンション > スレッド > 聞き耳型）
  - [ ] 非同期処理
- [ ] `handlers.py` への統合

### Step 4: スラッシュコマンドの実装 (2-3 日)

- [ ] `src/kotonoha_bot/commands/__init__.py` の作成
- [ ] `src/kotonoha_bot/commands/chat.py` の作成
  - [ ] `/chat start` コマンド（スレッド型開始）
    - [ ] スレッドの自動作成
    - [ ] セッションの初期化
  - [ ] `/chat reset` コマンド（会話履歴リセット）
    - [ ] セッションの会話履歴をクリア
    - [ ] メモリ内のセッションをリセット
  - [ ] `/chat status` コマンド（セッション状態表示）
    - [ ] セッションタイプの表示
    - [ ] 会話履歴の件数表示
    - [ ] セッションの開始時刻表示
- [ ] `main.py` でのコマンド登録
- [ ] コマンドの同期（`bot.tree.sync()`）

### Step 4.5: 応答メッセージにモデル情報フッターを追加 (0.5 日)

- [ ] `src/kotonoha_bot/utils/message_formatter.py` の作成（または既存ファイルの更新）
  - [ ] Embed を使用したメッセージフォーマット関数の実装
  - [ ] フッターに使用モデル名を表示
- [ ] `handlers.py` の更新
  - [ ] すべての応答メッセージ（mention、thread、eavesdrop）にフッターを追加
  - [ ] `generate_response` から使用モデル情報を取得
- [ ] メッセージ分割時の対応
  - [ ] 分割されたメッセージの最初のメッセージのみフッターを表示（オプション）
  - [ ] またはすべてのメッセージにフッターを表示

### Step 5: エラーハンドリングの強化 (1-2 日)

- [ ] `src/kotonoha_bot/errors/__init__.py` の作成
- [ ] `src/kotonoha_bot/errors/discord_errors.py` の作成
  - [ ] Discord API エラーの分類
  - [ ] エラータイプの判定
  - [ ] 適切なエラーメッセージの生成
- [ ] `src/kotonoha_bot/errors/database_errors.py` の作成
  - [ ] データベースエラーの分類
  - [ ] エラータイプの判定
  - [ ] 適切なエラーメッセージの生成
- [ ] `handlers.py` への統合
  - [ ] ユーザーフレンドリーなエラーメッセージの送信
  - [ ] 場面緘黙支援を考慮した表現

### Step 6: テストの実装 (1-2 日)

- [ ] `tests/unit/test_rate_limit.py` の作成
  - [ ] レート制限モニターのテスト
  - [ ] トークンバケットのテスト
  - [ ] リクエストキューのテスト
- [ ] `tests/unit/test_commands.py` の作成
  - [ ] `/chat start` コマンドのテスト
  - [ ] `/chat reset` コマンドのテスト
  - [ ] `/chat status` コマンドのテスト
- [ ] `tests/unit/test_errors.py` の作成
  - [ ] Discord エラーの分類テスト
  - [ ] データベースエラーの分類テスト
  - [ ] エラーメッセージの生成テスト

### Step 7: 動作確認とドキュメント更新 (1 日)

- [ ] レート制限対応の動作確認
- [ ] スラッシュコマンドの動作確認
- [ ] エラーハンドリングの動作確認
- [ ] `.env.example` の更新
- [ ] README の更新
- [ ] 実装ロードマップの更新

**既に実装済みの機能**:

- ✅ API エラーの分類（RateLimitError、InternalServerError、AuthenticationError）: Phase 1 で実装済み
- ✅ リトライロジック（指数バックオフ）: Phase 1 で実装済み
  - ✅ 最大リトライ回数の設定（`LLM_MAX_RETRIES`、デフォルト: 3）
  - ✅ リトライ間隔の指数バックオフ（`LLM_RETRY_DELAY_BASE`、デフォルト: 1.0 秒）
  - ✅ `InternalServerError`（HTTP 529 Overloaded を含む）のリトライ対応
  - ✅ `RateLimitError`（HTTP 429）のリトライ対応
- ✅ フォールバック機能: Phase 1 で実装済み
  - ✅ フォールバックモデルへの自動切り替え（LiteLLM の`fallbacks`パラメータ）
  - ✅ フォールバック時のログ出力

**完了基準**:

- [ ] レート制限モニターが実装されている
- [ ] トークンバケットアルゴリズムが実装されている
- [ ] リクエストキューが実装されている
- [ ] 優先度管理が動作する（メンション > スレッド > 聞き耳型）
- [ ] `/chat start` コマンドが動作する
- [ ] `/chat reset` コマンドが動作する
- [ ] `/chat status` コマンドが動作する
- [ ] Discord API エラーの分類が実装されている（新規実装）
- [ ] データベースエラーの分類が実装されている（新規実装）
- [ ] ユーザーフレンドリーなエラーメッセージが生成される（新規実装）
- [ ] 場面緘黙支援を考慮した表現が使用される（新規実装）
- [ ] すべてのテストが通過する

---

## 実装状況の詳細

### ✅ 実装完了（Phase 1, Phase 2, Phase 3）

| 機能カテゴリ                    | 実装状況 | 備考    |
| ------------------------------- | -------- | ------- |
| 環境構築・Discord 接続          | ✅ 完了  | Phase 1 |
| AI 応答機能（メンション応答型） | ✅ 完了  | Phase 1 |
| セッション管理・会話履歴保持    | ✅ 完了  | Phase 1 |
| NAS デプロイ・Docker 化         | ✅ 完了  | Phase 2 |
| バックアップ機能                | ✅ 完了  | Phase 2 |
| ログ管理                        | ✅ 完了  | Phase 2 |
| ヘルスチェック                  | ✅ 完了  | Phase 2 |
| CI/CD パイプライン              | ✅ 完了  | Phase 3 |
| テストフレームワーク            | ✅ 完了  | Phase 3 |
| コード品質ツール                | ✅ 完了  | Phase 3 |
| Watchtower 設定                 | ✅ 完了  | Phase 3 |

### ✅ 実装完了（Phase 4）

| 機能カテゴリ                 | 実装状況 | 備考    |
| ---------------------------- | -------- | ------- |
| メッセージ長制限対応         | ✅ 完了  | Phase 4 |
| バッチ同期の定期実行         | ✅ 完了  | Phase 4 |
| セッション設定の環境変数対応 | ✅ 完了  | Phase 4 |
| エラーハンドリング改善       | ✅ 完了  | Phase 4 |

### ✅ 実装完了（Phase 5）

| 機能カテゴリ         | 実装状況 | 備考    |
| -------------------- | -------- | ------- |
| メッセージルーター   | ✅ 完了  | Phase 5 |
| スレッド型           | ✅ 完了  | Phase 5 |
| 聞き耳型             | ✅ 完了  | Phase 5 |
| 統一インターフェース | ✅ 完了  | Phase 5 |

### ⏳ 未実装（Phase 6）

| 機能カテゴリ                 | 実装状況  | 備考    |
| ---------------------------- | --------- | ------- |
| レート制限モニタリング       | ❌ 未実装 | Phase 6 |
| トークンバケットアルゴリズム | ❌ 未実装 | Phase 6 |
| リクエストキューイング       | ❌ 未実装 | Phase 6 |
| スラッシュコマンド           | ❌ 未実装 | Phase 6 |
| Discord API エラー分類       | ❌ 未実装 | Phase 6 |
| データベースエラー分類       | ❌ 未実装 | Phase 6 |
| ユーザーフレンドリーなエラー | ❌ 未実装 | Phase 6 |
| リトライロジック（基本）     | ✅ 完了   | Phase 1 |
| API エラー分類（基本）       | ✅ 完了   | Phase 1 |
| フォールバック機能           | ✅ 完了   | Phase 1 |

---

## フェーズ別実装計画

### Phase 1 の詳細: MVP（メンション応答型）✅ 完了

**実装済み機能**:

1. **環境構築と Discord 接続**

   - ✅ プロジェクト構造の作成
   - ✅ `pyproject.toml` の設定
   - ✅ Discord Bot の基本接続

2. **AI 応答機能**

   - ✅ LiteLLM 統合
   - ✅ システムプロンプトの実装
   - ✅ 動的プロンプト生成（日付情報の注入）
   - ✅ フォールバック機能

3. **セッション管理**
   - ✅ SQLite データベースのセットアップ
   - ✅ ChatSession クラスの実装
   - ✅ セッション管理モジュール
   - ✅ 会話履歴の保持と復元

**詳細**: [Phase 1 実装完了報告](./phases/phase1.md)

---

### Phase 2 の詳細: NAS デプロイ ✅ 完了

**実装済み機能**:

1. **Docker 化**

   - ✅ Dockerfile の作成（マルチステージビルド）
   - ✅ Docker Compose の作成
   - ✅ 非 root ユーザーでの実行

2. **NAS デプロイ**

   - ✅ Synology Container Manager での設定
   - ✅ 自動起動の設定
   - ✅ ボリュームマウント

3. **運用機能**
   - ✅ バックアップ機能
   - ✅ ログ管理
   - ✅ ヘルスチェック機能

**詳細**: [Phase 2 実装完了報告](./phases/phase2.md)

---

### Phase 3 の詳細: CI/CD と運用機能 ✅ 完了

**実装済み機能**:

1. **テストフレームワーク**

   - ✅ pytest 設定
   - ✅ テストディレクトリ構造
   - ✅ 基本的なテストの実装

2. **コード品質ツール**

   - ✅ Ruff 設定（lint、format）
   - ✅ ty 設定（type-check）

3. **CI/CD パイプライン**
   - ✅ GitHub Actions CI ワークフロー
   - ✅ GitHub Actions ビルドワークフロー
   - ✅ Docker イメージのビルドと GHCR へのプッシュ
   - ✅ Watchtower の設定

**詳細**: [Phase 3 実装完了報告](./phases/phase3.md)

---

### Phase 4 の詳細: 機能改善 ✅ 完了

**実装済み機能**:

1. **メッセージ長制限対応**

   - [x] 2000 文字超の応答を分割
   - [x] 文の区切りで分割
   - [x] 連番を付与

2. **セッション同期機能の改善**

   - [x] バッチ同期の定期実行（5 分ごと）
   - [x] セッションクリーンアップの定期実行（1 時間ごと）

3. **セッション設定の環境変数対応**

   - [x] `SESSION_TIMEOUT_HOURS`、`MAX_SESSIONS` を環境変数から読み込み

4. **エラーハンドリングの改善**
   - [x] エラーメッセージの改善

**期間**: 実装済み（2026 年 1 月 15 日完了）

**詳細**: [Phase 4 実装完了報告](./phases/phase4.md)

---

### Phase 5 の詳細: 会話の契機拡張（スレッド型・聞き耳型）✅ 完了

**実装済み機能**:

1. **メッセージルーター**

   - [x] メッセージルーティング
   - [x] 会話の契機判定ロジック

2. **スレッド型**

   - [x] メンション検知時の自動スレッド作成
   - [x] スレッド名の生成（メッセージの最初の 50 文字、文の区切りで切る）
   - [x] スレッド内での会話継続（メンション不要）
   - [x] スレッドアーカイブ検知
   - [x] アーカイブ時のセッション保存

3. **聞き耳型**
   - [x] LLM 判断機能（アプローチ 1）
   - [ ] ルールベース判断機能（アプローチ 2、オプション）
   - [x] チャンネルごとの有効/無効設定
   - [x] 会話ログの一時保存（直近 20 件）
   - [x] 介入履歴の追跡
   - [x] 会話状態の分析

**実装期間**: 2026 年 1 月（完了）

**詳細**: [Phase 5 実装完了報告](./phases/phase5.md)

---

### Phase 6 の詳細: 高度な機能（レート制限・コマンド・エラーハンドリング強化）⏳ 未実装

**実装ステップ**:

1. **Step 1: レート制限モニタリングの実装 (2-3 日)**

   - [ ] `rate_limit/monitor.py` の作成
   - [ ] API リクエスト数の追跡
   - [ ] レート制限の接近を検知
   - [ ] 警告ログの出力
   - [ ] `litellm_provider.py` への統合

2. **Step 2: トークンバケットアルゴリズムの実装 (2-3 日)**

   - [ ] `rate_limit/token_bucket.py` の作成
   - [ ] リクエストレートの制御
   - [ ] バースト対応
   - [ ] トークンの自動補充
   - [ ] `litellm_provider.py` への統合

3. **Step 3: リクエストキューイングの実装 (2-3 日)**

   - [ ] `rate_limit/request_queue.py` の作成
   - [ ] リクエストのキューイング
   - [ ] 優先度管理（メンション > スレッド > 聞き耳型）
   - [ ] 非同期処理
   - [ ] `handlers.py` への統合

4. **Step 4: スラッシュコマンドの実装 (2-3 日)**

   - [ ] `commands/chat.py` の作成
   - [ ] `/chat start` コマンド（スレッド型開始）
   - [ ] `/chat reset` コマンド（会話履歴リセット）
   - [ ] `/chat status` コマンド（セッション状態表示）
   - [ ] `main.py` でのコマンド登録

5. **Step 5: エラーハンドリングの強化 (1-2 日)**

   - [ ] `errors/discord_errors.py` の作成
   - [ ] `errors/database_errors.py` の作成
   - [ ] Discord API エラーの分類
   - [ ] データベースエラーの分類
   - [ ] ユーザーフレンドリーなエラーメッセージの生成
   - [ ] 場面緘黙支援を考慮した表現
   - [ ] `handlers.py` への統合

6. **Step 6: テストの実装 (1-2 日)**

   - [ ] レート制限のテスト
   - [ ] コマンドのテスト
   - [ ] エラーハンドリングのテスト

7. **Step 7: 動作確認とドキュメント更新 (1 日)**

   - [ ] 動作確認
   - [ ] ドキュメント更新

**既に実装済みの機能**:

- ✅ API エラーの分類（RateLimitError、InternalServerError、AuthenticationError）: Phase 1 で実装済み
- ✅ リトライロジック（指数バックオフ）: Phase 1 で実装済み
- ✅ フォールバック機能: Phase 1 で実装済み

**期間**: 約 8-10 日

**詳細**: [Phase 6 実装計画](./phases/phase6.md)

---

## Phase 7: 完全リファクタリング ⏳ 未実装

**目標**: コードベースの品質向上と技術的負債の解消を実現する

**期間**: 約 10-15 日

**実装すべき機能**:

### 7.1 コード構造の整理 (3-4 日)

- [ ] モジュール構造の最適化
  - [ ] 不要な依存関係の削除
  - [ ] 循環参照の解消
  - [ ] モジュールの責務の明確化
- [ ] クラス設計の改善
  - [ ] 単一責任の原則の適用
  - [ ] インターフェースの明確化
  - [ ] 継承関係の見直し
- [ ] 関数・メソッドの整理
  - [ ] 長すぎる関数の分割
  - [ ] 重複コードの削除
  - [ ] 命名規則の統一

### 7.2 アーキテクチャの改善 (2-3 日)

- [ ] 設計パターンの適用
  - [ ] 適切なデザインパターンの導入
  - [ ] 依存性注入の改善
  - [ ] イベント駆動アーキテクチャの検討（オプション）
- [ ] エラーハンドリングの統一
  - [ ] エラーハンドリング戦略の統一
  - [ ] カスタム例外クラスの整理
  - [ ] エラーログの統一フォーマット
- [ ] 設定管理の改善
  - [ ] 設定の階層化（環境変数、データベース、デフォルト）
  - [ ] 設定の検証ロジックの強化

### 7.3 パフォーマンス最適化 (2-3 日)

- [ ] データベースクエリの最適化
  - [ ] スロークエリの特定と最適化
  - [ ] インデックスの見直し
  - [ ] バッチ処理の最適化
- [ ] メモリ使用量の最適化
  - [ ] メモリリークの特定と修正
  - [ ] キャッシュ戦略の見直し
  - [ ] 不要なオブジェクトの削除
- [ ] 非同期処理の最適化
  - [ ] 非同期処理の効率化
  - [ ] 並行処理の見直し
  - [ ] デッドロックの回避

### 7.4 コード品質の向上 (2-3 日)

- [ ] 型ヒントの完全化
  - [ ] すべての関数・メソッドに型ヒントを追加
  - [ ] `ty` による型チェックの通過
  - [ ] 型安全性の向上
- [ ] ドキュメントの充実
  - [ ] docstring の追加・改善
  - [ ] コメントの整理
  - [ ] API ドキュメントの生成
- [ ] コードスタイルの統一
  - [ ] Ruff による自動フォーマット
  - [ ] コーディング規約の統一
  - [ ] 命名規則の統一

### 7.5 テストの充実 (1-2 日)

- [ ] テストカバレッジの向上
  - [ ] カバレッジ目標の設定（例: 80%以上）
  - [ ] 不足しているテストの追加
  - [ ] エッジケースのテスト追加
- [ ] テストの品質向上
  - [ ] テストの可読性向上
  - [ ] テストの実行速度の最適化
  - [ ] モックの適切な使用

### 7.6 ドキュメントの更新 (1 日)

- [ ] アーキテクチャドキュメントの更新
- [ ] API ドキュメントの更新
- [ ] 開発者向けガイドの更新
- [ ] README の更新

**完了基準**:

- [ ] コード構造が整理されている
- [ ] アーキテクチャが改善されている
- [ ] パフォーマンスが最適化されている
- [ ] コード品質が向上している（型ヒント、ドキュメント、スタイル）
- [ ] テストカバレッジが向上している（目標値以上）
- [ ] すべてのテストが通過する
- [ ] ドキュメントが更新されている

---

## Phase 8: 高度な運用機能（モニタリング・設定管理）⏳ 未実装

**目標**: 運用性と管理性を向上させるための高度な機能を実装する

**期間**: 約 12-18 日

**実装すべき機能**:

### 8.1 高度なモニタリング機能 (3-4 日)

- [ ] メトリクス収集機能
  - [ ] API リクエスト数の追跡
  - [ ] レスポンス時間の測定
  - [ ] エラー率の計算
  - [ ] メモリ・CPU 使用率の監視
  - [ ] セッション数の追跡
- [ ] ダッシュボード機能（オプション）
  - [ ] メトリクスの可視化
  - [ ] リアルタイム監視
- [ ] アラート機能
  - [ ] 閾値超過時の通知
  - [ ] Discord チャンネルへの通知
  - [ ] ログへの記録

### 8.2 設定管理機能 (2-3 日)

- [ ] `/settings` スラッシュコマンドの実装
  - [ ] 設定の表示
  - [ ] 設定の変更
  - [ ] チャンネルごとの設定
  - [ ] ユーザーごとの設定
  - [ ] 権限管理（グローバル設定は管理者のみ変更可能）
- [ ] 設定の永続化
  - [ ] データベースへの保存
  - [ ] 設定の読み込み
- [ ] 設定項目
  - [ ] グローバル設定（全サーバー共通、管理者のみ変更可能）
    - [ ] デフォルト LLM モデル
    - [ ] システムプロンプトのカスタマイズ
  - [ ] チャンネルごとの設定
    - [ ] 聞き耳型の有効/無効
    - [ ] スレッド型の有効/無効
    - [ ] チャンネル固有の LLM モデル（オプション）
  - [ ] ユーザーごとの設定（オプション）
    - [ ] ユーザー固有の LLM モデル

### 8.3 パフォーマンス分析 (2-3 日)

- [ ] パフォーマンスメトリクスの収集
  - [ ] 応答時間の統計
  - [ ] スループットの測定
  - [ ] リソース使用率の追跡
- [ ] 分析レポートの生成
  - [ ] 日次レポート
  - [ ] 週次レポート
  - [ ] 月次レポート
- [ ] ボトルネックの特定
  - [ ] 遅延の原因分析
  - [ ] リソース制約の検出

### 8.4 ログ出力の強化 (1-2 日)

- [ ] 構造化ログの実装
  - [ ] JSON 形式のログ出力
  - [ ] ログレベルの適切な設定
- [ ] ログの検索・フィルタリング機能
  - [ ] 日付範囲での検索
  - [ ] ログレベルでのフィルタリング
  - [ ] キーワード検索
- [ ] ログのエクスポート機能
  - [ ] CSV 形式でのエクスポート
  - [ ] JSON 形式でのエクスポート

### 8.5 コスト管理機能 (2-3 日)

- [ ] トークン使用量の詳細追跡
  - [ ] ユーザーごとの使用量追跡
  - [ ] チャンネルごとの使用量追跡
  - [ ] セッションごとの使用量追跡
  - [ ] モデルごとの使用量追跡
- [ ] コスト計算機能
  - [ ] トークン数からコストを計算
  - [ ] モデルごとのコスト単価管理
  - [ ] 日次・週次・月次のコスト集計
- [ ] コストレポート機能
  - [ ] コストレポートの生成
  - [ ] コストの可視化（グラフなど）
  - [ ] コストのエクスポート
- [ ] 予算管理機能（オプション）
  - [ ] 予算の設定
  - [ ] 予算超過時のアラート
  - [ ] コスト予測機能

**既に実装済みの機能**:

- ✅ 基本的なヘルスチェック機能: Phase 2 で実装済み（`health.py`）
- ✅ 基本的なログ管理: Phase 2 で実装済み（RotatingFileHandler）
- ✅ 基本的なバックアップ機能: Phase 2 で実装済み（SQLite オンラインバックアップ）

**完了基準**:

- [ ] 高度なモニタリング機能が実装されている
- [ ] `/settings` コマンドが動作する
- [ ] パフォーマンス分析機能が実装されている
- [ ] ログ出力が強化されている
- [ ] コスト管理機能が実装されている

---

## Phase 9: 自動化・最適化機能 ⏳ 未実装

**目標**: 運用の自動化とシステムの最適化を実現する

**期間**: 約 5-8 日

**実装すべき機能**:

### 9.1 モデル切り替えオプション (2-3 日)

- [ ] `src/kotonoha_bot/ai/model_selector.py` の作成
  - [ ] メッセージからモデル選択指示を検出（Claude/Gemini）
  - [ ] モデル指示をメッセージから除去
  - [ ] 許可されていないモデル名の無視
- [ ] `handlers.py` への統合
  - [ ] 各ハンドラーでモデル選択機能を使用
  - [ ] 選択されたモデルで応答生成
- [ ] エラーハンドリング
  - [ ] 指定モデルが利用できない場合のフォールバック
- [ ] テストの実装
  - [ ] `tests/unit/test_model_selector.py` の作成

### 9.2 バックアップの自動化強化 (1-2 日)

- [ ] スケジュールバックアップ
  - [ ] 定期バックアップの設定
  - [ ] バックアップの自動削除（古いバックアップ）
- [ ] バックアップの検証
  - [ ] バックアップの整合性チェック
  - [ ] リストアテストの自動実行
- [ ] バックアップの通知
  - [ ] 成功/失敗の通知
  - [ ] ディスク使用量の警告

### 9.3 データベース最適化 (2-3 日)

- [ ] 自動最適化機能
  - [ ] 定期的な `VACUUM` 実行
  - [ ] インデックスの再構築
  - [ ] 統計情報の更新
- [ ] クエリ最適化
  - [ ] スロークエリの検出
  - [ ] インデックスの最適化
- [ ] データアーカイブ機能
  - [ ] 古いセッションのアーカイブ
  - [ ] アーカイブデータの検索

**完了基準**:

- [ ] モデル切り替えオプションが実装されている
- [ ] バックアップの自動化が強化されている
- [ ] データベース最適化が実装されている

---

## Phase 10: 監査機能 ⏳ 未実装

**目標**: 監査ログとコンプライアンス対応を実現する

**期間**: 約 3-4 日

**実装すべき機能**:

### 10.1 監査機能 (3-4 日)

- [ ] 監査ログの実装
  - [ ] ユーザー操作の記録
  - [ ] 設定変更の記録
  - [ ] エラーの記録
  - [ ] API 呼び出しの記録
- [ ] 監査ログの管理
  - [ ] ログの検索・フィルタリング
  - [ ] ログのエクスポート
  - [ ] データ保持期間の管理

**完了基準**:

- [ ] 監査機能が実装されている

---

## 実装の進め方

### 各フェーズの進め方

1. **実装**: フェーズの内容を実装
2. **テスト**: 動作確認とテスト
3. **コミット**: 動作する状態でコミット
4. **ドキュメント更新**: 必要に応じてドキュメントを更新
5. **次のフェーズへ**: 次のフェーズに進む

### コミット方針

- **フェーズごとのコミット**: 各フェーズが完了したらコミット
- **明確なコミットメッセージ**: 何を実装したか明確に
- **動作確認**: コミット前に必ず動作確認

### テスト方針

- **各フェーズでテスト**: 各フェーズで動作確認
- **手動テスト**: まずは手動で動作確認
- **自動テスト**: 可能な範囲で自動テストを追加

---

## 見積もり

| Phase        | 期間     | 主要機能                                             | 実装状況  |
| ------------ | -------- | ---------------------------------------------------- | --------- |
| **Phase 1**  | 実装済み | MVP（メンション応答型、セッション管理）              | ✅ 完了   |
| **Phase 2**  | 実装済み | NAS デプロイ、Docker 化、バックアップ                | ✅ 完了   |
| **Phase 3**  | 実装済み | CI/CD、テスト、コード品質                            | ✅ 完了   |
| **Phase 4**  | 実装済み | メッセージ長制限、バッチ同期                         | ✅ 完了   |
| **Phase 5**  | 実装済み | スレッド型、聞き耳型                                 | ✅ 完了   |
| **Phase 6**  | 8-10 日  | レート制限、コマンド、エラーハンドリング強化         | ⏳ 未実装 |
| **Phase 7**  | 10-15 日 | 完全リファクタリング                                 | ⏳ 未実装 |
| **Phase 8**  | 12-18 日 | 高度な運用機能（モニタリング・設定管理・コスト管理） | ⏳ 未実装 |
| **Phase 9**  | 5-8 日   | 自動化・最適化機能                                   | ⏳ 未実装 |
| **Phase 10** | 3-4 日   | 監査機能                                             | ⏳ 未実装 |
| **合計**     | 実装済み | Phase 1-5 完了、Phase 6-10 は未実装                  |           |

**注意**: Phase 1、Phase 2、Phase 3、Phase 4、Phase 5 は既に完了しているため、残りの実装期間は Phase 6 以降です。Phase 6 完了後は Phase 7（完全リファクタリング）の実施を推奨します。

---

## リスク管理

### 各フェーズでのリスク

**Phase 3**:

- ✅ 完了（CI/CD の設定、GitHub Actions、Watchtower の設定が完了）

**Phase 4**:

- メッセージ分割の実装が複雑
- バッチ同期のタイミング問題

**Phase 5**:

- スレッド作成の権限問題
- 聞き耳型の判定精度の問題
- LLM 判断のコスト増加

**Phase 6**:

- レート制限の実装が複雑
- リトライロジックの実装が複雑
- コマンド機能の実装が複雑

**Phase 7**:

- リファクタリングによる既存機能の破壊
- テストカバレッジの不足による回帰バグ
- パフォーマンス最適化による予期しない副作用

### 対策

- **早期の動作確認**: 各フェーズで動作確認
- **ドキュメント参照**: 実装前にドキュメントを確認
- **段階的な実装**: 小さな単位で実装
- **テストの実施**: 各フェーズでテストを実施

---

## 次のステップ

現在の実装状況:

- ✅ **Phase 1**: 完了（MVP、メンション応答型）
- ✅ **Phase 2**: 完了（NAS デプロイ、Docker 化）
- ✅ **Phase 3**: 完了（CI/CD と運用機能）
- ✅ **Phase 4**: 完了（機能改善）
- ✅ **Phase 5**: 完了（会話の契機拡張、スレッド型・聞き耳型）

次の実装ステップは **Phase 6** です。詳細は「Phase 6: 高度な機能」セクションを参照してください。

**Phase 6 完了後**: **Phase 7（完全リファクタリング）** を実施することを推奨します。コードベースの品質向上と技術的負債の解消により、その後の Phase 8-10 の実装がより効率的になります。

各フェーズの詳細な実装手順については、各フェーズの実装計画書を参照してください。

---

**作成日**: 2026 年 1 月 14 日
**最終更新日**: 2026 年 1 月 15 日
**バージョン**: 6.0
**作成者**: kotonoha-bot 開発チーム

### 更新履歴

- **v6.0** (2026-01-15): Phase 7-10 の実装計画を追加、将来の機能拡張案を追加
- **v5.0** (2026-01-15): Phase 5 の実装完了を反映、実装状況を更新
- **v4.0** (2026-01-15): Phase 3 の実装完了を反映、実装状況を更新
- **v3.0** (2026-01-15): 実装状況に基づいてフェーズを再整理、各フェーズで実装すべき機能を明確化
- **v2.0** (2026-01-14): 実装状況の反映、チェックボックスの更新
- **v1.0** (2026-01-14): 初版リリース
