# 実装ロードマップ

段階的な実装計画と各段階での実装順序を定義します。

## 1. 実装方針

### 1.1 段階的実装のメリット

- **早期の動作確認**: 各段階で動作する最小限の機能を実装し、早期に動作確認できる
- **リスクの低減**: 小さな単位で実装・テストすることで、問題を早期に発見できる
- **学習効果**: 各段階で学んだことを次の段階に活かせる
- **柔軟な変更**: 要件変更に柔軟に対応できる
- **進捗管理**: 明確なマイルストーンで進捗を管理しやすい

### 1.2 実装原則

1. **動作する最小限の機能を優先**: 各段階で必ず動作する状態を作る
2. **テスト可能な状態を維持**: 各段階でテスト可能な状態を保つ
3. **リファクタリングを適宜実施**: コードの品質を維持しながら進める
4. **ドキュメントを更新**: 実装と同時にドキュメントも更新

---

## 2. 実装段階の全体像と実装状況

### 実装状況サマリー

| Phase        | 段階              | 実装状況  | 期間     | 主要機能                                             |
| ------------ | ----------------- | --------- | -------- | ---------------------------------------------------- |
| **Phase 1**  | 段階 1, 3, 4 統合 | ✅ 完了   | 実装済み | MVP（メンション応答型、セッション管理）              |
| **Phase 2**  | 段階 2            | ✅ 完了   | 実装済み | NAS デプロイ、Docker 化、バックアップ                |
| **Phase 3**  | 段階 7            | ✅ 完了   | 実装済み | CI/CD、テスト、コード品質                            |
| **Phase 4**  | -                 | ✅ 完了   | 実装済み | メッセージ長制限、バッチ同期                         |
| **Phase 5**  | 段階 5            | ✅ 完了   | 実装済み | スレッド型、聞き耳型                                 |
| **Phase 6**  | 段階 6            | ✅ 完了   | 実装済み | レート制限、コマンド、エラーハンドリング強化         |
| **Phase 7**  | -                 | ✅ 完了   | 実装済み | aiosqlite への移行（非同期化）                       |
| **Phase 8**  | -                 | ⏳ 未実装 | 10-15 日 | 完全リファクタリング（非同期コードの整理を含む）     |
| **Phase 9**  | -                 | ⏳ 未実装 | 12-18 日 | 高度な運用機能（モニタリング・設定管理・コスト管理） |
| **Phase 10** | -                 | ⏳ 未実装 | 5-8 日   | 自動化・最適化機能                                   |
| **Phase 11** | -                 | ⏳ 未実装 | 3-4 日   | 監査機能（aiosqlite 移行後で実装）                   |

---

## Phase 1: MVP（メンション応答型）✅ 完了

**目標**: Discord 上でメンションされた時に LiteLLM 経由で LLM API を使って応答できる最小限の Bot

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

- ✅ 環境構築と Discord 接続
- ✅ AI 応答機能（メンション応答型）
  - ✅ LiteLLM 統合
  - ✅ システムプロンプトの実装
  - ✅ 動的プロンプト生成（日付情報の注入）
  - ✅ フォールバック機能
- ✅ セッション管理と会話履歴保持
  - ✅ SQLite データベースのセットアップ
  - ✅ ChatSession クラスの実装
  - ✅ セッション管理モジュール
  - ✅ 会話履歴の保持と復元
- ✅ 基本的なエラーハンドリング
- ✅ ログ出力機能

**詳細**: [Phase 1 実装完了報告](./phases/phase1.md)

---

## Phase 2: NAS デプロイ ✅ 完了

**目標**: Phase 1 で実装済みの Bot を NAS 上で 24 時間稼働させ、本番環境として運用できるようにする

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

- ✅ Dockerfile の作成（マルチステージビルド）
- ✅ Docker Compose の作成
- ✅ NAS へのデプロイ（Synology Container Manager）
- ✅ バックアップ機能（SQLite オンラインバックアップ、gzip 圧縮）
- ✅ ログ管理（RotatingFileHandler）
- ✅ ヘルスチェック機能（HTTP エンドポイント）
- ✅ セキュリティ設定（非 root ユーザーでの実行）

**詳細**: [Phase 2 実装完了報告](./phases/phase2.md)

---

## Phase 3: CI/CD と運用機能 ✅ 完了

**目標**: CI/CD パイプラインを構築し、運用に必要な機能を実装する

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

- ✅ テストフレームワーク（pytest）の設定
- ✅ コード品質ツールの設定（Ruff、ty）
- ✅ GitHub Actions CI ワークフロー（lint、format、type-check、test）
- ✅ GitHub Actions ビルドワークフロー（Docker イメージのビルド・プッシュ）
- ✅ GHCR への自動プッシュ（マルチプラットフォーム: amd64、arm64）
- ✅ Watchtower による自動更新機能
- ✅ 通知機能（Discord Webhook、オプション）

**詳細**: [Phase 3 実装完了報告](./phases/phase3.md)

---

## Phase 4: 機能改善 ✅ 完了

**目標**: Phase 1 で実装した機能の改善と不足機能の追加

**期間**: 約 3-5 日

**実装済み機能**:

### 4.1 メッセージ長制限対応

- [x] メッセージ分割機能の実装
  - [x] 2000 文字超の応答を検知
  - [x] 文の区切り（句点、改行）で分割
  - [x] 連番を付与して複数メッセージに分割
  - [x] Embed の活用（オプション、6000 文字制限あり）

### 4.2 セッション同期機能の改善

- [x] バッチ同期の定期実行タスク
  - [x] `discord.ext.tasks` または `asyncio` を使用
  - [x] 5 分ごとにアイドル状態のセッションを自動保存
  - [x] `cleanup_old_sessions` の定期実行（1 時間ごと）

### 4.3 エラーハンドリングの改善

- [x] メッセージ追加時の自動保存
  - [x] `add_message` 後に自動的に `save_session` を呼ぶ（オプション）
  - [x] または、バッチ同期に任せる

**完了基準**:

- [x] 2000 文字超の応答が自動的に分割される
- [x] バッチ同期が 5 分ごとに実行される
- [x] セッションクリーンアップが 1 時間ごとに実行される

**詳細**: [Phase 4 実装完了報告](./phases/phase4.md)

---

## Phase 5: 会話の契機拡張（スレッド型・聞き耳型）✅ 完了

**目標**: 3 つの会話の契機（メンション/スレッド/聞き耳型）を実装する

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

### 5.1 メッセージルーターの実装

- [x] `router/message_router.py`: メッセージルーティング
- [x] 会話の契機判定ロジック
  - [x] メンション応答型の判定（既存）
  - [x] スレッド型の判定
  - [x] 聞き耳型の判定

### 5.2 スレッド型の実装

- [x] メンション検知時の自動スレッド作成
- [x] スレッド名の生成（メッセージの最初の 50 文字、文の区切りで切る）
- [x] スレッド内での会話継続（メンション不要）
- [x] スレッドアーカイブ検知
- [x] アーカイブ時のセッション保存

### 5.3 聞き耳型の実装

- [x] `eavesdrop/llm_judge.py`: LLM 判断機能（アプローチ 1）
  - [x] 会話ログの一時保存（直近 20 件）
  - [x] 判定フェーズ（裁判官）の実装
  - [x] 発言生成フェーズ（演者）の実装
  - [x] 判定用プロンプトの最適化
- [ ] `eavesdrop/rule_judge.py`: ルールベース判断機能（アプローチ 2、オプション）
  - [ ] キーワード検知
  - [ ] 盛り上がり検知
  - [ ] ランダム判定
- [x] チャンネルごとの有効/無効設定
- [x] メインチャンネルへの直接投稿機能

### 5.4 統一インターフェースの実装

- [x] 3 つの方式を統一的に扱うインターフェース
- [x] セッションキーの統一管理
  - [x] メンション応答型: `mention:{user_id}`
  - [x] スレッド型: `thread:{thread_id}`
  - [x] 聞き耳型: `eavesdrop:{channel_id}`

**完了基準**:

- [x] メッセージルーターが実装されている
- [x] スレッド型が動作する（自動スレッド作成）
- [x] 聞き耳型が動作する（アプローチ 1）
- [x] 各方式で会話履歴が正しく管理される
- [x] すべてのテストが通過する（49 テストケース）

**詳細**: [Phase 5 実装完了報告](./phases/phase5.md)

---

## Phase 6: 高度な機能（レート制限・コマンド・エラーハンドリング強化）✅ 完了

**目標**: レート制限対応、スラッシュコマンド機能、エラーハンドリングの強化を実装し、運用性とユーザー体験を向上させる

**実装期間**: 2026 年 1 月（完了）

**実装済み機能**:

### Step 1: レート制限モニタリングの実装 ✅

- ✅ `src/kotonoha_bot/rate_limit/__init__.py` の作成
- ✅ `src/kotonoha_bot/rate_limit/monitor.py` の作成
  - ✅ API リクエスト数の追跡
  - ✅ レート制限の接近を検知
  - ✅ 警告ログの出力
- ✅ `litellm_provider.py` への統合

### Step 2: トークンバケットアルゴリズムの実装 ✅

- ✅ `src/kotonoha_bot/rate_limit/token_bucket.py` の作成
  - ✅ リクエストレートの制御
  - ✅ バースト対応
  - ✅ トークンの自動補充
- ✅ `litellm_provider.py` への統合

### Step 3: リクエストキューイングの実装 ✅

- ✅ `src/kotonoha_bot/rate_limit/request_queue.py` の作成
  - ✅ リクエストのキューイング
  - ✅ 優先度管理（メンション > スレッド > 聞き耳型）
  - ✅ 非同期処理
- ✅ `handlers.py` への統合

### Step 4: スラッシュコマンドの実装 ✅

- ✅ `src/kotonoha_bot/commands/__init__.py` の作成
- ✅ `src/kotonoha_bot/commands/chat.py` の作成
  - ✅ `/chat reset` コマンド（会話履歴リセット）
    - ✅ セッションの会話履歴をクリア
    - ✅ メモリ内のセッションをリセット
  - ✅ `/chat status` コマンド（セッション状態表示）
    - ✅ セッションタイプの表示
    - ✅ 会話履歴の件数表示
    - ✅ セッションの開始時刻表示
  - [ ] `/chat start` コマンド（スレッド型開始）
    - [ ] スレッドの自動作成
    - [ ] セッションの初期化
    - **注意**: スレッド型はメンション時に自動作成されるため、
      現時点では未実装
- ✅ `main.py` でのコマンド登録
- ✅ コマンドの同期（`bot.tree.sync()`）

### Step 4.5: 応答メッセージにモデル情報フッターを追加 ✅

- ✅ `src/kotonoha_bot/utils/message_formatter.py` の作成
  - ✅ Embed を使用したメッセージフォーマット関数の実装
  - ✅ フッターに使用モデル名を表示
  - ✅ レート制限使用率の表示（オプション）
- ✅ `handlers.py` の更新
  - ✅ すべての応答メッセージ（mention、thread、eavesdrop）にフッターを追加
  - ✅ `generate_response` から使用モデル情報を取得
- ✅ メッセージ分割時の対応
  - ✅ 分割されたメッセージの最初のメッセージのみフッターを表示

### Step 5: エラーハンドリングの強化 ✅

- ✅ `src/kotonoha_bot/errors/__init__.py` の作成
- ✅ `src/kotonoha_bot/errors/discord_errors.py` の作成
  - ✅ Discord API エラーの分類
  - ✅ エラータイプの判定
  - ✅ 適切なエラーメッセージの生成
- ✅ `src/kotonoha_bot/errors/database_errors.py` の作成
  - ✅ データベースエラーの分類
  - ✅ エラータイプの判定
  - ✅ 適切なエラーメッセージの生成
- ✅ `handlers.py` への統合
  - ✅ ユーザーフレンドリーなエラーメッセージの送信
  - ✅ 場面緘黙支援を考慮した表現

### Step 6: テストの実装 ✅

- ✅ `tests/unit/test_rate_limit.py` の作成（実装状況を確認）
  - ✅ レート制限モニターのテスト
  - ✅ トークンバケットのテスト
  - ✅ リクエストキューのテスト
- ✅ `tests/unit/test_commands.py` の作成（実装状況を確認）
  - ✅ `/chat reset` コマンドのテスト
  - ✅ `/chat status` コマンドのテスト
- ✅ `tests/unit/test_errors.py` の作成（実装状況を確認）
  - ✅ Discord エラーの分類テスト
  - ✅ データベースエラーの分類テスト
  - ✅ エラーメッセージの生成テスト

### Step 7: 動作確認とドキュメント更新 ✅

- ✅ レート制限対応の動作確認
- ✅ スラッシュコマンドの動作確認
- ✅ エラーハンドリングの動作確認
- ✅ `.env.example` の更新
- ✅ README の更新
- ✅ 実装ロードマップの更新

**既に実装済みの機能**:

- ✅ API エラーの分類（RateLimitError、InternalServerError、AuthenticationError）:
  Phase 1 で実装済み
- ✅ リトライロジック（指数バックオフ）: Phase 1 で実装済み
  - ✅ 最大リトライ回数の設定（`LLM_MAX_RETRIES`、デフォルト: 3）
  - ✅ リトライ間隔の指数バックオフ（`LLM_RETRY_DELAY_BASE`、デフォルト: 1.0 秒）
  - ✅ `InternalServerError`（HTTP 529 Overloaded を含む）のリトライ対応
  - ✅ `RateLimitError`（HTTP 429）のリトライ対応
- ✅ フォールバック機能: Phase 1 で実装済み
  - ✅ フォールバックモデルへの自動切り替え（LiteLLM の`fallbacks`パラメータ）
  - ✅ フォールバック時のログ出力

**完了基準**:

- ✅ レート制限モニターが実装されている
- ✅ トークンバケットアルゴリズムが実装されている
- ✅ リクエストキューが実装されている
- ✅ 優先度管理が動作する（メンション > スレッド > 聞き耳型）
- ✅ `/chat reset` コマンドが動作する
- ✅ `/chat status` コマンドが動作する
- ✅ Discord API エラーの分類が実装されている
- ✅ データベースエラーの分類が実装されている
- ✅ ユーザーフレンドリーなエラーメッセージが生成される
- ✅ 場面緘黙支援を考慮した表現が使用される
- ✅ 応答メッセージにモデル情報フッターが追加されている
- ✅ すべてのテストが通過する

**詳細**: [Phase 6 実装計画](./phases/phase6.md)

---

## 実装状況の詳細

### ✅ 実装完了（Phase 1, Phase 2, Phase 3）

| 機能カテゴリ                    | 実装状況 | 備考    |
| ------------------------------- | -------- | ------- |
| 環境構築・Discord 接続          | ✅ 完了  | Phase 1 |
| AI 応答機能（メンション応答型） | ✅ 完了  | Phase 1 |
| セッション管理・会話履歴保持    | ✅ 完了  | Phase 1 |
| NAS デプロイ・Docker 化         | ✅ 完了  | Phase 2 |
| バックアップ機能                | ✅ 完了  | Phase 2 |
| ログ管理                        | ✅ 完了  | Phase 2 |
| ヘルスチェック                  | ✅ 完了  | Phase 2 |
| CI/CD パイプライン              | ✅ 完了  | Phase 3 |
| テストフレームワーク            | ✅ 完了  | Phase 3 |
| コード品質ツール                | ✅ 完了  | Phase 3 |
| Watchtower 設定                 | ✅ 完了  | Phase 3 |

### ✅ 実装完了（Phase 4）

| 機能カテゴリ                 | 実装状況 | 備考    |
| ---------------------------- | -------- | ------- |
| メッセージ長制限対応         | ✅ 完了  | Phase 4 |
| バッチ同期の定期実行         | ✅ 完了  | Phase 4 |
| セッション設定の環境変数対応 | ✅ 完了  | Phase 4 |
| エラーハンドリング改善       | ✅ 完了  | Phase 4 |

### ✅ 実装完了（Phase 5）

| 機能カテゴリ         | 実装状況 | 備考    |
| -------------------- | -------- | ------- |
| メッセージルーター   | ✅ 完了  | Phase 5 |
| スレッド型           | ✅ 完了  | Phase 5 |
| 聞き耳型             | ✅ 完了  | Phase 5 |
| 統一インターフェース | ✅ 完了  | Phase 5 |

### ✅ 実装完了（Phase 6）

| 機能カテゴリ                 | 実装状況 | 備考    |
| ---------------------------- | -------- | ------- |
| レート制限モニタリング       | ✅ 完了  | Phase 6 |
| トークンバケットアルゴリズム | ✅ 完了  | Phase 6 |
| リクエストキューイング       | ✅ 完了  | Phase 6 |
| スラッシュコマンド           | ✅ 完了  | Phase 6 |
| Discord API エラー分類       | ✅ 完了  | Phase 6 |
| データベースエラー分類       | ✅ 完了  | Phase 6 |
| ユーザーフレンドリーなエラー | ✅ 完了  | Phase 6 |
| 応答メッセージフッター       | ✅ 完了  | Phase 6 |
| リトライロジック（基本）     | ✅ 完了  | Phase 1 |
| API エラー分類（基本）       | ✅ 完了  | Phase 1 |
| フォールバック機能           | ✅ 完了  | Phase 1 |

---

## フェーズ別実装計画

### Phase 1 の詳細: MVP（メンション応答型）✅ 完了

**実装済み機能**:

1. **環境構築と Discord 接続**

   - ✅ プロジェクト構造の作成
   - ✅ `pyproject.toml` の設定
   - ✅ Discord Bot の基本接続

2. **AI 応答機能**

   - ✅ LiteLLM 統合
   - ✅ システムプロンプトの実装
   - ✅ 動的プロンプト生成（日付情報の注入）
   - ✅ フォールバック機能

3. **セッション管理**
   - ✅ SQLite データベースのセットアップ
   - ✅ ChatSession クラスの実装
   - ✅ セッション管理モジュール
   - ✅ 会話履歴の保持と復元

**詳細**: [Phase 1 実装完了報告](./phases/phase1.md)

---

### Phase 2 の詳細: NAS デプロイ ✅ 完了

**実装済み機能**:

1. **Docker 化**

   - ✅ Dockerfile の作成（マルチステージビルド）
   - ✅ Docker Compose の作成
   - ✅ 非 root ユーザーでの実行

2. **NAS デプロイ**

   - ✅ Synology Container Manager での設定
   - ✅ 自動起動の設定
   - ✅ ボリュームマウント

3. **運用機能**
   - ✅ バックアップ機能
   - ✅ ログ管理
   - ✅ ヘルスチェック機能

**詳細**: [Phase 2 実装完了報告](./phases/phase2.md)

---

### Phase 3 の詳細: CI/CD と運用機能 ✅ 完了

**実装済み機能**:

1. **テストフレームワーク**

   - ✅ pytest 設定
   - ✅ テストディレクトリ構造
   - ✅ 基本的なテストの実装

2. **コード品質ツール**

   - ✅ Ruff 設定（lint、format）
   - ✅ ty 設定（type-check）

3. **CI/CD パイプライン**
   - ✅ GitHub Actions CI ワークフロー
   - ✅ GitHub Actions ビルドワークフロー
   - ✅ Docker イメージのビルドと GHCR へのプッシュ
   - ✅ Watchtower の設定

**詳細**: [Phase 3 実装完了報告](./phases/phase3.md)

---

### Phase 4 の詳細: 機能改善 ✅ 完了

**実装済み機能**:

1. **メッセージ長制限対応**

   - ✅ 2000 文字超の応答を分割
   - ✅ 文の区切りで分割
   - ✅ 連番を付与

2. **セッション同期機能の改善**

   - ✅ バッチ同期の定期実行（5 分ごと）
   - ✅ セッションクリーンアップの定期実行（1 時間ごと）

3. **セッション設定の環境変数対応**

   - ✅ `SESSION_TIMEOUT_HOURS`、`MAX_SESSIONS` を環境変数から読み込み

4. **エラーハンドリングの改善**
   - ✅ エラーメッセージの改善

**期間**: 実装済み（2026 年 1 月 15 日完了）

**詳細**: [Phase 4 実装完了報告](./phases/phase4.md)

---

### Phase 5 の詳細: 会話の契機拡張（スレッド型・聞き耳型）✅ 完了

**実装済み機能**:

1. **メッセージルーター**

   - ✅ メッセージルーティング
   - ✅ 会話の契機判定ロジック

2. **スレッド型**

   - ✅ メンション検知時の自動スレッド作成
   - ✅ スレッド名の生成（メッセージの最初の 50 文字、文の区切りで切る）
   - ✅ スレッド内での会話継続（メンション不要）
   - ✅ スレッドアーカイブ検知
   - ✅ アーカイブ時のセッション保存

3. **聞き耳型**
   - ✅ LLM 判断機能（アプローチ 1）
   - [ ] ルールベース判断機能（アプローチ 2、オプション）
   - ✅ チャンネルごとの有効/無効設定
   - ✅ 会話ログの一時保存（直近 20 件）
   - ✅ 介入履歴の追跡
   - ✅ 会話状態の分析

**実装期間**: 2026 年 1 月（完了）

**詳細**: [Phase 5 実装完了報告](./phases/phase5.md)

---

### Phase 6 の詳細: 高度な機能（レート制限・コマンド・エラーハンドリング強化）✅ 完了

**実装済み機能**:

1. **レート制限モニタリング**

   - ✅ `rate_limit/monitor.py` の作成
   - ✅ API リクエスト数の追跡
   - ✅ レート制限の接近を検知
   - ✅ 警告ログの出力
   - ✅ `litellm_provider.py` への統合

2. **トークンバケットアルゴリズム**

   - ✅ `rate_limit/token_bucket.py` の作成
   - ✅ リクエストレートの制御
   - ✅ バースト対応
   - ✅ トークンの自動補充
   - ✅ `litellm_provider.py` への統合

3. **リクエストキューイング**

   - ✅ `rate_limit/request_queue.py` の作成
   - ✅ リクエストのキューイング
   - ✅ 優先度管理（メンション > スレッド > 聞き耳型）
   - ✅ 非同期処理
   - ✅ `handlers.py` への統合

4. **スラッシュコマンド**

   - ✅ `commands/chat.py` の作成
   - ✅ `/chat reset` コマンド（会話履歴リセット）
   - ✅ `/chat status` コマンド（セッション状態表示）
   - [ ] `/chat start` コマンド（スレッド型開始、未実装）
     - **注意**: スレッド型はメンション時に自動作成されるため、
       現時点では未実装
   - ✅ `main.py` でのコマンド登録

5. **エラーハンドリングの強化**

   - ✅ `errors/discord_errors.py` の作成
   - ✅ `errors/database_errors.py` の作成
   - ✅ Discord API エラーの分類
   - ✅ データベースエラーの分類
   - ✅ ユーザーフレンドリーなエラーメッセージの生成
   - ✅ 場面緘黙支援を考慮した表現
   - ✅ `handlers.py` への統合

6. **応答メッセージフッター**

   - ✅ `utils/message_formatter.py` の作成
   - ✅ Embed を使用したメッセージフォーマット関数の実装
   - ✅ フッターに使用モデル名を表示
   - ✅ レート制限使用率の表示（オプション）
   - ✅ `handlers.py` の更新

**既に実装済みの機能**:

- ✅ API エラーの分類（RateLimitError、InternalServerError、AuthenticationError）:
  Phase 1 で実装済み
- ✅ リトライロジック（指数バックオフ）: Phase 1 で実装済み
- ✅ フォールバック機能: Phase 1 で実装済み

**期間**: 実装済み（2026 年 1 月完了）

**詳細**: [Phase 6 実装計画](./phases/phase6.md)

---

## Phase 7: aiosqlite への移行 ✅ 完了

**目標**: 同期的な `sqlite3` から非同期対応の `aiosqlite` に移行し、Bot 全体のブロッキング問題を解決する

**期間**: 約 2-3 日

**実装完了日**: 2026 年 1 月 15 日

**実装済み機能**:

### Step 1: SQLiteDatabase クラスの非同期化 ✅

- [x] `SQLiteDatabase` クラスの全メソッドを `async def` に変更
  - [x] `_get_connection()` を非同期化（各メソッドで直接 `aiosqlite.connect()` を使用する実装に変更）
  - [x] `_init_database()` を非同期化
  - [x] `__init__()` を変更し、`initialize()` メソッドを追加
  - [x] `save_session()` を非同期化
  - [x] `load_session()` を非同期化
  - [x] `load_all_sessions()` を非同期化
  - [x] `delete_session()` を非同期化
  - [x] `close()` を非同期化（aiosqlite は接続プールを自動管理するため、実装を簡素化）
- [x] `aiosqlite` の API に合わせて実装を修正
- [x] WAL モード、外部キー制約などの設定を維持（各接続で PRAGMA 設定を実行）
- [x] すべての `sqlite3.Error` を `aiosqlite.Error` に変更

### Step 2: SessionManager クラスの非同期化 ✅

- [x] `SessionManager` の DB 操作を呼び出すメソッドを非同期化
  - [x] `__init__()` を変更し、`initialize()` メソッドを追加
  - [x] `_load_active_sessions()` を非同期化
  - [x] `get_session()` を非同期化
  - [x] `create_session()` を非同期化
  - [x] `save_session()` を非同期化
  - [x] `save_all_sessions()` を非同期化
  - [x] `cleanup_old_sessions()` を非同期化
- [x] 初期化処理を `on_ready` イベントで実行するように変更

### Step 3: 呼び出し元の修正 ✅

- [x] `handlers.py` のすべての呼び出し箇所で `await` を追加
  - [x] `on_ready()` イベントで `session_manager.initialize()` を呼び出す
  - [x] `cleanup_task()` 内の呼び出し
  - [x] `batch_sync_task()` 内の呼び出し
  - [x] `_process_mention()` 内の呼び出し
  - [x] `_process_thread_creation()` 内の呼び出し
  - [x] `_process_thread_message()` 内の呼び出し
  - [x] `_process_eavesdrop()` 内の呼び出し
  - [x] `on_thread_update()` 内の呼び出し
- [x] `main.py` の `shutdown_gracefully()` を修正
- [x] コマンド実装（`commands/chat.py`）の DB 操作を確認・修正

### Step 4: テストの更新 ✅

- [x] `tests/conftest.py` のフィクスチャを非同期化
- [x] `tests/unit/test_db.py` のすべてのテストを非同期化
- [x] `tests/unit/test_session.py` のすべてのテストを非同期化
- [x] 他のテストファイルで DB 操作を使用している場合は修正（モックを `AsyncMock` に変更）
- [x] すべてのテストが通過することを確認（137 テストケースすべて通過）

### Step 5: 動作確認とドキュメント更新 ✅

- [x] 基本機能が正常に動作することを確認
- [x] パフォーマンスが改善されていることを確認
- [x] エラーハンドリングが正しく動作することを確認
- [x] すべてのテストが通過することを確認
- [x] ADR-0006 のステータスを更新
- [x] ロードマップの実装状況を更新

**完了基準**:

- [x] `aiosqlite` が依存関係に追加されている（✅ 既に完了: `aiosqlite>=0.22.1`）
- [x] `SQLiteDatabase` クラスが完全に非同期化されている
- [x] `SessionManager` クラスが完全に非同期化されている
- [x] すべての呼び出し箇所で `await` が使用されている
- [x] Bot 全体がブロックされない（非同期処理が正常に動作）
- [x] すべてのテストが通過する（137 テストケースすべて通過）
- [x] 既存の機能が正常に動作する（セッション保存・読み込み）
- [x] ドキュメントが更新されている

**実装の優先度**: **高**（技術的負債の解消、監査ログ機能の前提条件）

**詳細**:

- [ADR-0006: aiosqlite への移行](../architecture/adr/0006-migrate-to-aiosqlite.md)
- [Phase 7 実装計画](./phases/phase7.md)

**注意**: この移行は Phase 8（完全リファクタリング）の前に実施することを推奨します。理由:

1. **技術的負債の早期解消**: 同期コードが非同期イベントハンドラーから呼ばれているのは重大な問題
2. **パフォーマンスの即時改善**: Bot 全体のブロッキング問題を解決
3. **Phase 8 の効率化**: 非同期コードを基にリファクタリングする方が効率的
4. **監査ログ機能の前提**: Phase 11 の監査ログ機能は非同期 DB が必要

---

## Phase 8: 完全リファクタリング ⏳ 未実装

**目標**: コードベースの品質向上と技術的負債の解消を実現する

**期間**: 約 10-15 日

**前提条件**: ✅ **Phase 7（aiosqlite への移行）が完了していること**

**主な改善点**:

- ✅ レイヤードアーキテクチャの明確化
- ✅ 依存性注入の改善
- ✅ 設定管理の階層化と分離
- ✅ エラーハンドリングの統一
- ✅ ログ設定の分離
- ✅ 巨大ファイルの分割（handlers.py 833 行 → 複数モジュールに分割）
- ✅ 型安全性の向上
- ✅ テストの充実
- ✅ フォルダ構造の最適化
- ✅ 重複コードの削除（日付フォーマット、プロンプト読み込み、エラーメッセージ）
- ✅ **重要**: `litellm.py` の戻り値を `tuple[str, dict]` に変更
  （Phase 9.5 と Phase 11.1 で必要）

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

### Step 1: コア機能の整理 (1-2 日)

- [ ] `src/kotonoha_bot/core/` ディレクトリを新規作成
- [ ] `src/kotonoha_bot/core/config.py` の作成（`config.py` から設定管理を整理）
- [ ] `src/kotonoha_bot/core/logging.py` の作成（ログ設定の分離）
- [ ] `src/kotonoha_bot/core/exceptions.py` の作成（カスタム例外クラス）
- [ ] `src/kotonoha_bot/main.py` の更新（インポートパスの更新）

### Step 2: handlers.py の分割 (2-3 日)

- [ ] `src/kotonoha_bot/bot/handlers/` ディレクトリを新規作成
- [ ] `src/kotonoha_bot/bot/handlers/base.py` の作成（基底ハンドラー）
- [ ] `src/kotonoha_bot/bot/handlers/mention.py` の作成（メンション応答型）
- [ ] `src/kotonoha_bot/bot/handlers/thread.py` の作成（スレッド型）
- [ ] `src/kotonoha_bot/bot/handlers/eavesdrop.py` の作成（聞き耳型）
- [ ] **重要**: `src/kotonoha_bot/ai/litellm_provider.py` の
  `generate_response()` の戻り値を `tuple[str, dict]` に変更
  （後で `src/kotonoha_bot/external/ai/litellm.py` に移動予定）
- [ ] すべての呼び出し箇所（8箇所）を更新

### Step 3: サービス層の整理 (1-2 日)

- [ ] `src/kotonoha_bot/services/` ディレクトリを新規作成
- [ ] `src/kotonoha_bot/services/session.py` の作成（`session/manager.py` からビジネスロジックを抽出）
- [ ] `src/kotonoha_bot/services/ai.py` の作成
- [ ] `src/kotonoha_bot/services/conversation.py` の作成
- [ ] 既存コードの更新（インポートパスの更新）

### Step 4: データアクセス層の整理 (1 日)

- [ ] `src/kotonoha_bot/data/` ディレクトリを新規作成
- [ ] `src/kotonoha_bot/data/database.py` の作成（`db/sqlite.py` から移動）
- [ ] `src/kotonoha_bot/data/models.py` の作成（`session/models.py` から移動）
- [ ] 既存コードの更新（インポートパスの更新）

### Step 5: 外部サービス層の整理 (1 日)

- [ ] `src/kotonoha_bot/external/` ディレクトリを新規作成
- [ ] `src/kotonoha_bot/external/ai/` ディレクトリを新規作成
- [ ] `src/kotonoha_bot/external/ai/provider.py` の作成（`ai/provider.py` から移動）
- [ ] `src/kotonoha_bot/external/ai/litellm.py` の作成（`ai/litellm_provider.py` から移動）
- [ ] `src/kotonoha_bot/external/ai/prompts.py` の作成
  （`ai/prompts.py` の `_load_prompt_from_markdown()` を公開関数化）
- [ ] `src/kotonoha_bot/external/health.py` の作成（`health.py` から移動）
- [ ] `src/kotonoha_bot/eavesdrop/llm_judge.py` の更新（プロンプト読み込みの重複削除）

### Step 6: 機能別モジュールの整理 (1-2 日)

- [ ] `src/kotonoha_bot/features/` ディレクトリを新規作成
- [ ] `src/kotonoha_bot/features/rate_limit/` の作成（`rate_limit/` から移動）
- [ ] `src/kotonoha_bot/features/eavesdrop/` の作成（`eavesdrop/` から移動）
- [ ] `src/kotonoha_bot/features/errors/` ディレクトリを新規作成
- [ ] `src/kotonoha_bot/features/errors/messages.py` の作成（エラーメッセージの一元管理）
- [ ] `src/kotonoha_bot/features/errors/discord.py` の作成
  （`errors/discord_errors.py` から移動）
- [ ] `src/kotonoha_bot/features/errors/database.py` の作成
  （`errors/database_errors.py` から移動）
- [ ] `src/kotonoha_bot/bot/router.py` の作成（`router/message_router.py` から移動）

### Step 7: ユーティリティの整理 (1 日)

- [ ] `src/kotonoha_bot/utils/message.py` の作成
  （`utils/message_formatter.py` と `utils/message_splitter.py` を統合）
- [ ] `src/kotonoha_bot/utils/datetime.py` の作成（日付フォーマット関数、重複削除）
- [ ] 既存コードの更新（日付フォーマットの3箇所を置き換え）

### Step 8: 型ヒントとドキュメントの充実 (1-2 日)

- [ ] すべての関数・メソッドに型ヒントを追加
- [ ] すべてのクラス・関数・メソッドに docstring を追加
- [ ] `ty` による型チェックの通過

### Step 9: テストの充実 (1-2 日)

- [ ] テストカバレッジの測定
- [ ] 不足しているテストの追加
- [ ] `litellm.py` の戻り値変更に関するテストを追加
- [ ] すべてのテストが通過することを確認

**完了基準**:

- [ ] コード構造が整理されている（シンプルなレイヤードアーキテクチャ）
- [ ] アーキテクチャが改善されている（依存性注入の改善）
- [ ] パフォーマンスが最適化されている（データベースクエリ、非同期処理）
- [ ] コード品質が向上している（型ヒント、ドキュメント、スタイル）
- [ ] テストカバレッジが向上している（80% 以上）
- [ ] すべてのテストが通過する（既存の 137 テストケース + 新規テスト）
- [ ] ドキュメントが更新されている
- [ ] 既存の機能が正常に動作する（回帰テスト）
- [ ] 重複コードが削除されている（日付フォーマット、プロンプト読み込み、エラーメッセージ）
- [ ] `litellm.py` の戻り値が `tuple[str, dict]` になっている

---

## Phase 9: 高度なモニタリング機能 ⏳ 未実装

**目標**: 運用性と管理性を向上させるための高度なモニタリング機能を実装する

**期間**: 約 3-4 日（ダッシュボード含む場合は約 5-6 日）

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**実装優先度**: **最優先**

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

**実装優先度**: **最優先**

**実装期間**: 約 3-4 日（ダッシュボード含む場合は約 5-6 日）

- [ ] `src/kotonoha_bot/features/monitoring/` ディレクトリを新規作成
  - [ ] `metrics.py`: メトリクス収集クラス
  - [ ] `collector.py`: メトリクス収集ロジック（API リクエスト数、レスポンス時間、エラー率など）
  - [ ] `dashboard.py`: ダッシュボード機能（管理者用高機能ダッシュボード）
  - [ ] `alerts.py`: アラート機能（閾値超過時の通知）
- [ ] `src/kotonoha_bot/services/monitoring.py`: モニタリングサービスのビジネスロジック
- [ ] `src/kotonoha_bot/external/health.py` を拡張してメトリクスエンドポイントを追加

**機能**:

- [ ] 基本的なメトリクス収集（API リクエスト数、レスポンス時間、エラー率など）
- [ ] メトリクスエンドポイント（`src/kotonoha_bot/external/health.py` の拡張）
- [ ] 管理者用高機能ダッシュボード機能
  - メトリクスの可視化（グラフ、チャート）
  - リアルタイム監視
  - 履歴データの表示
  - エクスポート機能
- [ ] アラート機能（閾値超過時の通知）

**完了基準**:

- [ ] 高度なモニタリング機能が実装されている
- [ ] 管理者用高機能ダッシュボードが動作する

---

## Phase 10: コスト管理機能 ⏳ 未実装

**目標**: トークン使用量とコストを追跡・管理する機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**（`litellm.py` の戻り値変更が完了しているため）

**実装優先度**: **高**

**実装期間**: 約 2-3 日

- [ ] `src/kotonoha_bot/features/cost_management/` ディレクトリを新規作成
  - [ ] `tracker.py`: トークン使用量の追跡
  - [ ] `calculator.py`: コスト計算機能
  - [ ] `reporter.py`: コストレポート生成
  - [ ] `budget.py`: 予算管理機能（オプション）
- [ ] `src/kotonoha_bot/services/cost_tracking.py`:
  コスト追跡サービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/models.py`:
  コストデータモデルを追加（`TokenUsage`, `CostRecord` など）
- [ ] `src/kotonoha_bot/external/ai/litellm.py` でトークン使用量を取得して記録（Phase 8 で既に実装済み）

**機能**:

- [ ] トークン使用量の詳細追跡（ユーザー・チャンネル・セッション・モデルごと）
- [ ] コスト計算機能（トークン数からコストを計算、モデルごとのコスト単価管理）
- [ ] コストレポート機能（日次・週次・月次のコスト集計、可視化、エクスポート）
- [ ] 予算管理機能（オプション、予算の設定、予算超過時のアラート、コスト予測）

**注意**: Phase 8 で `litellm.py` の `generate_response()` の戻り値が
`tuple[str, dict]` になっているため、トークン情報が既に取得できる状態です。

**完了基準**:

- [ ] コスト管理機能が実装されている
- [ ] トークン使用量が追跡されている
- [ ] コストレポートが生成できる

---

## Phase 12: 設定管理機能 ⏳ 未実装

**目標**: チャンネルごと、ユーザーごとの設定管理機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

- [ ] `src/kotonoha_bot/commands/settings.py`: `/settings` コマンドの実装
- [ ] `src/kotonoha_bot/services/settings.py`:
  設定管理サービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/models.py`: 設定データモデルを追加
  （`ChannelSettings`, `UserSettings`, `GlobalSettings`）
- [ ] `src/kotonoha_bot/data/database.py`:
  設定の永続化メソッドを追加
- [ ] `src/kotonoha_bot/core/config.py` を拡張して、
  データベースから設定を読み込む機能を追加

**設定項目**:

- [ ] グローバル設定（全サーバー共通、管理者のみ変更可能）
  - [ ] デフォルト LLM モデル
  - [ ] システムプロンプトのカスタマイズ
- [ ] チャンネルごとの設定
  - [ ] 聞き耳型の有効/無効
  - [ ] スレッド型の有効/無効
  - [ ] チャンネル固有の LLM モデル（オプション）
- [ ] ユーザーごとの設定（オプション）
  - [ ] ユーザー固有の LLM モデル

**完了基準**:

- [ ] `/settings` コマンドが動作する
- [ ] チャンネルごとの設定が管理できる
- [ ] ユーザーごとの設定が管理できる（オプション）

---

## Phase 13: パフォーマンス分析 ⏳ 未実装

**目標**: システムのパフォーマンスを分析・監視する機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

**実装期間**: 約 2-3 日

- [ ] `src/kotonoha_bot/features/monitoring/performance.py`: パフォーマンス分析機能
- [ ] `src/kotonoha_bot/services/performance.py`: パフォーマンス分析サービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/models.py`: パフォーマンスメトリクスデータモデルを追加

**機能**:

- [ ] パフォーマンスメトリクスの収集（応答時間、スループット、リソース使用率）
- [ ] 分析レポートの生成（日次・週次・月次）
- [ ] ボトルネックの特定（遅延の原因分析、リソース制約の検出）

**完了基準**:

- [ ] パフォーマンス分析機能が実装されている
- [ ] 分析レポートが生成できる

---

## Phase 14: ログ出力の強化 ⏳ 未実装

**目標**: ログ出力を強化し、検索・フィルタリング・エクスポート機能を実装する

**期間**: 約 1-2 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

**実装期間**: 約 1-2 日

- [ ] `src/kotonoha_bot/core/logging.py` を拡張
  - [ ] 構造化ログ（JSON 形式）のサポート
  - [ ] ログ検索・フィルタリング機能
  - [ ] ログエクスポート機能
- [ ] `src/kotonoha_bot/features/logging/` ディレクトリを新規作成（必要に応じて）
  - [ ] `search.py`: ログ検索機能
  - [ ] `export.py`: ログエクスポート機能

**完了基準**:

- [ ] ログ出力が強化されている
- [ ] ログ検索・フィルタリング機能が動作する
- [ ] ログエクスポート機能が動作する

---

## Phase 11: 監査ログ機能 ⏳ 未実装

**目標**: 監査ログとコンプライアンス対応を実現する

**期間**: 約 3-4 日

**前提条件**: ✅ **Phase 7（aiosqlite への移行）が完了していること**、
✅ **Phase 8（完全リファクタリング）が完了していること**

**実装優先度**: **高**（Phase 8 で `litellm.py` の戻り値変更が完了しているため）

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

- [ ] `src/kotonoha_bot/features/audit/` ディレクトリを新規作成
  - [ ] `logger.py`: `AuditLogger` クラス（監査ログの記録）
  - [ ] `reporter.py`: 監査レポート生成
- [ ] `src/kotonoha_bot/data/models.py`:
  監査ログデータモデルを追加（`AuditLog`, `MonthlyUsage` など）
- [ ] `src/kotonoha_bot/data/database.py`: 監査ログテーブルの作成と操作メソッドを追加
- [ ] `src/kotonoha_bot/bot/handlers/` の各ハンドラーで監査ログを記録（非同期で実行）
- [ ] `src/kotonoha_bot/external/ai/litellm.py` でトークン情報とレイテンシを取得（Phase 8 で既に実装済み）

**機能**:

- [ ] データベーススキーマの実装（`audit_logs` テーブル、`monthly_usage` テーブル、インデックス）
- [ ] `AuditLogger` クラスの実装
  （`log_interaction()` メソッド、`get_monthly_usage()` メソッド、
  `get_user_usage()` メソッド）
- [ ] すべての応答生成箇所で監査ログを記録（非同期ログ記録）

**注意**: Phase 8 で `litellm.py` の `generate_response()` の戻り値が
`tuple[str, dict]` になっているため、トークン情報とレイテンシが既に取得できる
状態です。

**完了基準**:

- [ ] 監査ログ機能が実装されている
- [ ] すべての応答生成箇所で監査ログが記録されている
- [ ] 月次集計が可能（オプション）

---

## Phase 15: モデル切り替えオプション ⏳ 未実装

**目標**: メッセージからモデル選択指示を検出し、動的にモデルを切り替える機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

- [ ] `src/kotonoha_bot/features/model_selection/` ディレクトリを新規作成
  - [ ] `selector.py`: モデル選択ロジック（メッセージからモデル指示を検出）
  - [ ] `validator.py`: 許可されたモデル名の検証
- [ ] `src/kotonoha_bot/bot/handlers/` の各ハンドラーでモデル選択機能を使用

**機能**:

- [ ] メッセージからモデル選択指示を検出（例: `@model: claude-opus`）
- [ ] モデル指示をメッセージから除去
- [ ] 許可されていないモデル名の無視
- [ ] 指定モデルが利用できない場合のフォールバック

**完了基準**:

- [ ] モデル切り替えオプションが実装されている
- [ ] メッセージからモデル指示を検出できる

---

## Phase 16: バックアップの自動化強化 ⏳ 未実装

**目標**: バックアップの自動化を強化し、スケジュール・検証・通知機能を実装する

**期間**: 約 1-2 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

**実装期間**: 約 1-2 日

- [ ] `src/kotonoha_bot/features/automation/backup.py`: バックアップ自動化機能
- [ ] `src/kotonoha_bot/services/automation.py`: 自動化サービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/database.py`: バックアップ検証機能を追加
- [ ] Phase 2 で実装済みのバックアップ機能を拡張

**機能**:

- [ ] スケジュールバックアップ（定期バックアップの設定）
- [ ] バックアップの自動削除（古いバックアップ）
- [ ] バックアップの検証（整合性チェック、リストアテストの自動実行）
- [ ] バックアップの通知（成功/失敗の通知、ディスク使用量の警告）

**完了基準**:

- [ ] バックアップの自動化が強化されている
- [ ] スケジュールバックアップが動作する

---

## Phase 17: データベース最適化 ⏳ 未実装

**目標**: データベースの最適化を自動化し、パフォーマンスを向上させる機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

**実装期間**: 約 2-3 日

- [ ] `src/kotonoha_bot/features/automation/optimization.py`: データベース最適化機能
- [ ] `src/kotonoha_bot/data/database.py`: 最適化メソッドを追加（`VACUUM`, インデックス再構築など）
- [ ] `src/kotonoha_bot/services/automation.py`: 自動最適化のスケジューリング

**機能**:

- [ ] 自動最適化機能（定期的な `VACUUM` 実行、インデックスの再構築、統計情報の更新）
- [ ] クエリ最適化（スロークエリの検出、インデックスの最適化）
- [ ] データアーカイブ機能（古いセッションのアーカイブ、アーカイブデータの検索）

**完了基準**:

- [ ] データベース最適化が実装されている
- [ ] 自動最適化が動作する

---

## Phase 18: コスト計算機能 ⏳ 未実装

**目標**: トークン数からコストを計算し、モデルごとのコスト単価を管理する機能を実装する

**期間**: 約 2-3 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

- [ ] `src/kotonoha_bot/features/audit/cost_calculator.py`: コスト計算機能
- [ ] `src/kotonoha_bot/data/models.py`: コストデータモデルを追加
- [ ] トークン数からコストを計算する実装

**機能**:

- [ ] トークン数からコストを計算
- [ ] モデルごとのコスト単価管理
- [ ] コスト計算の精度向上

**完了基準**:

- [ ] コスト計算機能が実装されている
- [ ] モデルごとのコスト単価が管理できる

---

## Phase 19: 統合知識ベース機能 ⏳ 未実装

**目標**: 会話、添付ファイル、ウェブから統合的に知識ベースを構築する機能を実装する

**期間**: 約 15-20 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**実装優先度**: **高**（Phase 9 完了後に実装）

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

- [ ] `src/kotonoha_bot/features/knowledge_base/` ディレクトリを新規作成
  - [ ] `summarizer.py`: 要約機能
  - [ ] `storage.py`: 知識ベース保存機能
  - [ ] `search.py`: 検索機能
  - [ ] `semantic_search.py`: セマンティック検索機能（オプション）
  - [ ] `file_processor.py`: 添付ファイル処理機能（新規追加）
  - [ ] `web_scraper.py`: ウェブコンテンツ取得機能（新規追加）
  - [ ] `content_integrator.py`: 統合コンテンツ管理機能（新規追加）
- [ ] `src/kotonoha_bot/services/knowledge_base.py`: 知識ベースサービスのビジネスロジック
- [ ] `src/kotonoha_bot/data/models.py`: 知識ベースデータモデルを追加

**機能**:

- [ ] 会話からの知識抽出・要約
- [ ] 添付ファイル（テキスト、PDF、画像など）からの知識抽出
- [ ] ウェブコンテンツ（URL 指定）からの知識抽出
- [ ] 統合検索機能（会話・ファイル・ウェブを横断検索）
- [ ] 知識ベースの更新・管理機能

**潜在的な課題**:

- **ファイル処理の時間**: 大きなファイルの処理に時間がかかる
  - **対策**: 非同期処理で実装、バックグラウンドで処理
- **ファイル形式の対応**: 多様なファイル形式に対応する必要がある
  - **対策**: 段階的な実装（まずはテキストファイル、次に PDF、画像など）
- **ウェブスクレイピングの制限**: ウェブサイトの利用規約や技術的制限
  - **対策**: 利用規約の確認、適切なレート制限

**完了基準**:

- [ ] 統合知識ベース機能が実装されている
- [ ] 会話・ファイル・ウェブからの知識抽出が動作する
- [ ] 統合検索機能が動作する

---

## Phase 20: 会話の要約・ハイライト機能 ⏳ 未実装

**目標**: 会話の要約とハイライト抽出機能を実装する

**期間**: 約 10-15 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**実装優先度**: **高**（知識ベース機能と同時に実装）

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

**実装優先度**: **中**（Phase 9 完了後に実装）

**実装期間**: 約 5-10 日

- [ ] `src/kotonoha_bot/features/knowledge_base/` ディレクトリを拡張
  - [ ] `conversation_analyzer.py`: 会話分析機能（新規追加）
  - [ ] `highlight_extractor.py`: ハイライト抽出機能（新規追加）
  - [ ] `conversation_summarizer.py`: 会話要約機能（新規追加）
  - [ ] `highlight_formatter.py`: ハイライトフォーマット機能（新規追加）
- [ ] `src/kotonoha_bot/commands/summary.py`: 要約・ハイライトコマンド（新規追加）
- [ ] `src/kotonoha_bot/services/summary.py`: 要約・ハイライトサービスのビジネスロジック（新規追加）
- [ ] `src/kotonoha_bot/data/models.py`: 要約・ハイライトデータモデルの追加

**完了基準**:

- [ ] 会話の要約・ハイライト機能が実装されている
- [ ] 要約・ハイライトコマンドが動作する

---

## Phase 21: 議題提案機能 ⏳ 未実装

**目標**: 未解決事項や継続課題を抽出し、議題を提案する機能を実装する

**期間**: 約 8-12 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**、
✅ **Phase 19（統合知識ベース機能）が完了していること**、
✅ **Phase 20（会話の要約・ハイライト機能）が完了していること**

**実装優先度**: **高**（知識ベース機能と要約・ハイライト機能の後に実装）

**詳細**: [将来実装予定機能の詳細レビュー](./phases/future_features_review.md)

- [ ] `src/kotonoha_bot/features/agenda/` ディレクトリを新規作成
  - [ ] `issue_extractor.py`: 課題抽出機能（新規追加）
  - [ ] `agenda_generator.py`: 議題生成機能（新規追加）
  - [ ] `priority_ranker.py`: 優先順位付け機能（新規追加）
- [ ] `src/kotonoha_bot/services/agenda.py`: 議題サービスのビジネスロジック（新規追加）
- [ ] `src/kotonoha_bot/commands/agenda.py`: 議題提案コマンド（新規追加）
- [ ] `src/kotonoha_bot/data/models.py`: 議題データモデルの追加

**機能**:

- [ ] 未解決事項の抽出
- [ ] 継続課題の特定（セマンティック検索で関連情報を取得）
- [ ] 議題の優先順位付け
- [ ] 議題の提案・管理

**潜在的な課題**:

- **課題抽出の精度**: LLM 判定の精度が重要
  - **対策**: 高精度な LLM 判定、セマンティック検索で関連情報を取得
- **継続課題の特定**: セマンティック検索で関連する課題を検索
  - **対策**: セマンティック検索の実装、言及回数の追跡

**完了基準**:

- [ ] 議題提案機能が実装されている
- [ ] 議題提案コマンドが動作する

---

## Phase 22: 聞き耳モードでの自動リアクション機能 ⏳ 未実装

**目標**: 聞き耳モードで会話を分析し、適切なリアクションを自動で付与する機能を実装する

**期間**: 約 5-10 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**実装優先度**: **中**（Phase 9 完了後に実装）

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

- [ ] `src/kotonoha_bot/features/eavesdrop/` ディレクトリを拡張
  - [ ] `reaction_judge.py`: リアクション判定機能（新規追加）
  - [ ] `reaction_manager.py`: リアクション管理機能（新規追加）
- [ ] `src/kotonoha_bot/bot/handlers/eavesdrop.py`: 聞き耳型ハンドラーの拡張
- [ ] `src/kotonoha_bot/services/reaction.py`: リアクションサービスのビジネスロジック（新規追加）
- [ ] `src/kotonoha_bot/data/models.py`: リアクション履歴データモデルの追加

**完了基準**:

- [ ] 聞き耳モードでの自動リアクション機能が実装されている
- [ ] リアクション判定が動作する

---

## Phase 23: ポジティブフィードバック生成機能 ⏳ 未実装

**目標**: 会話の感情分析を行い、ポジティブフィードバックと週次サマリーを自動生成する機能を実装する

**期間**: 約 5-8 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**実装優先度**: **中**（Phase 9 完了後に実装）

**詳細**: [将来実装予定機能の詳細レビュー](./phases/future_features_review.md)

- [ ] `src/kotonoha_bot/features/feedback/` ディレクトリを新規作成
  - [ ] `sentiment_analyzer.py`: 感情分析機能（新規追加）
  - [ ] `positive_feedback_generator.py`: ポジティブフィードバック生成機能（新規追加）
  - [ ] `weekly_summary.py`: 週次サマリー生成機能（新規追加）
- [ ] `src/kotonoha_bot/services/feedback.py`: フィードバックサービスのビジネスロジック（新規追加）
- [ ] `src/kotonoha_bot/data/models.py`: フィードバックデータモデルの追加

**機能**:

- [ ] 会話の感情分析
- [ ] ポジティブフィードバックの自動生成
- [ ] 週次サマリーの自動生成（場面緘黙支援を考慮した表現）
- [ ] フィードバック履歴の管理

**潜在的な課題**:

- **感情分析の精度**: 感情分析の精度が重要
  - **対策**: 高精度な感情分析、複数の指標を統合
- **サマリー生成の品質**: LLM を使ったサマリー生成の品質が重要
  - **対策**: 高品質なサマリー生成、場面緘黙支援を考慮した表現

**完了基準**:

- [ ] ポジティブフィードバック生成機能が実装されている
- [ ] 週次サマリーが自動生成される

---

## Phase 24: 翻訳要約機能 ⏳ 未実装

**目標**: 多言語対応の強化として、会話や要約の翻訳機能を実装する

**期間**: 約 5-8 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**実装優先度**: **中**（多言語対応の強化として、Phase 9 完了後に実装）

**詳細**: [将来実装予定機能の詳細レビュー](./phases/future_features_review.md)

- [ ] `src/kotonoha_bot/features/translation/` ディレクトリを新規作成
  - [ ] `translator.py`: 翻訳機能（新規追加）
  - [ ] `summary_translator.py`: 要約翻訳機能（新規追加）
- [ ] `src/kotonoha_bot/services/translation.py`: 翻訳サービスのビジネスロジック（新規追加）
- [ ] `src/kotonoha_bot/commands/translate.py`: 翻訳コマンド（新規追加）

**機能**:

- [ ] 会話の多言語翻訳機能
- [ ] 要約の多言語翻訳機能
- [ ] 自動言語検出
- [ ] 翻訳品質の管理

**潜在的な課題**:

- **翻訳の精度**: 自動翻訳の精度が課題
  - **対策**: LLM を使った翻訳、または外部翻訳 API の統合
- **多言語メッセージの管理**: 多言語メッセージを誰が管理するか
  - **対策**: 翻訳ファイルを管理、または LLM による自動翻訳

**完了基準**:

- [ ] 翻訳要約機能が実装されている
- [ ] 翻訳コマンドが動作する

---

## Phase 25: 音声チャンネル機能（要約・議事録、合成音声発話） ⏳ 未実装

**目標**: 音声チャンネルでの要約・議事録生成と合成音声発話機能を実装する

**期間**: 約 20-30 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**実装優先度**: **低**（技術検討後に実装）

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

- [ ] `src/kotonoha_bot/features/knowledge_base/` ディレクトリを拡張
  - [ ] `voice_recorder.py`: 音声録音機能（新規追加）
  - [ ] `transcription.py`: 文字起こし機能（新規追加）
  - [ ] `meeting_minutes.py`: 議事録生成機能（新規追加）
  - [ ] `tts_generator.py`: 合成音声生成機能（新規追加）
- [ ] `src/kotonoha_bot/external/voice/` ディレクトリを新規作成
  - [ ] `whisper_provider.py`: Whisper API プロバイダー
- [ ] `src/kotonoha_bot/external/tts/` ディレクトリを新規作成
  - [ ] `tts_provider.py`: TTS プロバイダーインターフェース
  - [ ] `openai_tts.py`: OpenAI TTS API プロバイダー

**完了基準**:

- [ ] 音声チャンネル機能が実装されている
- [ ] 音声録音・文字起こしが動作する
- [ ] 合成音声発話が動作する

---

## Phase 26: コンテキスト理解の向上機能 ⏳ 未実装

**目標**: ベクトル DB と Embedding API を使用してコンテキスト理解を向上させる機能を実装する

**期間**: 約 15-20 日

**前提条件**: ✅ **Phase 8（完全リファクタリング）が完了していること**

**実装優先度**: **低**（技術検討後に実装）

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

- [ ] `src/kotonoha_bot/features/knowledge_base/` ディレクトリを拡張
  - [ ] `vector_store.py`: ベクトルストア機能（新規追加）
  - [ ] `embedding_generator.py`: 埋め込み生成機能（新規追加）
  - [ ] `semantic_search.py`: セマンティック検索機能（新規追加）
  - [ ] `context_retriever.py`: コンテキスト取得機能（新規追加）
- [ ] `src/kotonoha_bot/external/vector/` ディレクトリを新規作成
  - [ ] `sqlite_vector_provider.py`: SQLite ベクトル拡張プロバイダー（推奨）
- [ ] `src/kotonoha_bot/external/embedding/` ディレクトリを新規作成
  - [ ] `embedding_provider.py`: Embedding プロバイダーインターフェース
  - [ ] `openai_embedding.py`: OpenAI Embedding API プロバイダー

**完了基準**:

- [ ] コンテキスト理解の向上機能が実装されている
- [ ] セマンティック検索が動作する

---

## 実装の進め方

### 各フェーズの進め方

1. **実装**: フェーズの内容を実装
2. **テスト**: 動作確認とテスト
3. **コミット**: 動作する状態でコミット
4. **ドキュメント更新**: 必要に応じてドキュメントを更新
5. **次のフェーズへ**: 次のフェーズに進む

### コミット方針

- **フェーズごとのコミット**: 各フェーズが完了したらコミット
- **明確なコミットメッセージ**: 何を実装したか明確に
- **動作確認**: コミット前に必ず動作確認

### テスト方針

- **各フェーズでテスト**: 各フェーズで動作確認
- **手動テスト**: まずは手動で動作確認
- **自動テスト**: 可能な範囲で自動テストを追加

---

## 見積もり

| Phase        | 期間     | 主要機能                                             | 実装状況  |
| ------------ | -------- | ---------------------------------------------------- | --------- |
| **Phase 1**  | 実装済み | MVP（メンション応答型、セッション管理）              | ✅ 完了   |
| **Phase 2**  | 実装済み | NAS デプロイ、Docker 化、バックアップ                | ✅ 完了   |
| **Phase 3**  | 実装済み | CI/CD、テスト、コード品質                            | ✅ 完了   |
| **Phase 4**  | 実装済み | メッセージ長制限、バッチ同期                         | ✅ 完了   |
| **Phase 5**  | 実装済み | スレッド型、聞き耳型                                 | ✅ 完了   |
| **Phase 6**  | 実装済み | レート制限、コマンド、エラーハンドリング強化         | ✅ 完了   |
| **Phase 7**  | 実装済み | aiosqlite への移行（非同期化）                       | ✅ 完了   |
| **Phase 8**  | 10-15 日 | 完全リファクタリング（非同期コードの整理、重複コード削除、litellm.py 戻り値変更） | ⏳ 未実装 |
| **Phase 9**  | 3-6 日   | 高度なモニタリング機能（管理者用高機能ダッシュボード含む） | ⏳ 未実装 |
| **Phase 10** | 2-3 日   | コスト管理機能（Phase 8 完了後で実装） | ⏳ 未実装 |
| **Phase 11** | 3-4 日   | 監査ログ機能（Phase 8 完了後で実装） | ⏳ 未実装 |
| **Phase 12** | 2-3 日   | 設定管理機能 | ⏳ 未実装 |
| **Phase 13** | 2-3 日   | パフォーマンス分析 | ⏳ 未実装 |
| **Phase 14** | 1-2 日   | ログ出力の強化 | ⏳ 未実装 |
| **Phase 15** | 2-3 日   | モデル切り替えオプション | ⏳ 未実装 |
| **Phase 16** | 1-2 日   | バックアップの自動化強化 | ⏳ 未実装 |
| **Phase 17** | 2-3 日   | データベース最適化 | ⏳ 未実装 |
| **Phase 18** | 2-3 日   | コスト計算機能 | ⏳ 未実装 |
| **Phase 19** | 15-20 日 | 統合知識ベース機能（会話・添付ファイル・ウェブ） | ⏳ 未実装 |
| **Phase 20** | 10-15 日 | 会話の要約・ハイライト機能 | ⏳ 未実装 |
| **Phase 21** | 8-12 日  | 議題提案機能 | ⏳ 未実装 |
| **Phase 22** | 5-10 日  | 聞き耳モードでの自動リアクション機能 | ⏳ 未実装 |
| **Phase 23** | 5-8 日   | ポジティブフィードバック生成機能 | ⏳ 未実装 |
| **Phase 24** | 5-8 日   | 翻訳要約機能 | ⏳ 未実装 |
| **Phase 25** | 20-30 日 | 音声チャンネル機能（要約・議事録、合成音声発話） | ⏳ 未実装 |
| **Phase 26** | 15-20 日 | コンテキスト理解の向上機能 | ⏳ 未実装 |
| **合計**     | 実装済み | Phase 1-7 完了、Phase 8-26 は未実装                  |           |

**注意**: Phase 1-7 は既に完了しています。残りの実装順序は以下の通りです:

1. ✅ **Phase 7（aiosqlite への移行）**: 完了（2026 年 1 月 15 日）
2. **Phase 8（完全リファクタリング）**: 非同期コードを基にリファクタリングを実施
   - **重要**: `litellm.py` の戻り値を `tuple[str, dict]` に変更
     （Phase 10 と Phase 11 で必要）
3. **Phase 9-18**: Phase 8 完了後に実施
   - **Phase 9**: 高度なモニタリング機能（最優先）
   - **Phase 10**: コスト管理機能（Phase 8 でトークン情報が取得できる状態）
   - **Phase 11**: 監査ログ機能（Phase 8 でトークン情報が取得できる状態）
   - **Phase 12-14**: 設定管理、パフォーマンス分析、ログ強化
   - **Phase 15-17**: 自動化・最適化機能
   - **Phase 18**: コスト計算機能
4. **Phase 19-24**: ロードマップ外の高優先度機能
   - **Phase 19**: 統合知識ベース機能
   - **Phase 20**: 会話の要約・ハイライト機能
   - **Phase 21**: 議題提案機能
   - **Phase 22**: 聞き耳モードでの自動リアクション機能
   - **Phase 23**: ポジティブフィードバック生成機能
   - **Phase 24**: 翻訳要約機能
5. **Phase 25-26**: ロードマップ外の低優先度機能（技術検討後）
   - **Phase 25**: 音声チャンネル機能
   - **Phase 26**: コンテキスト理解の向上機能

---

## リスク管理

### 各フェーズでのリスク

**Phase 3**:

- ✅ 完了（CI/CD の設定、GitHub Actions、Watchtower の設定が完了）

**Phase 4**:

- ✅ 完了（メッセージ分割、バッチ同期の実装が完了）

**Phase 5**:

- ✅ 完了（スレッド型、聞き耳型の実装が完了）

**Phase 6**:

- ✅ 完了（レート制限、コマンド、エラーハンドリングの実装が完了）

**Phase 7**:

- ✅ 完了（aiosqlite への移行、非同期化、テスト更新が完了）

**Phase 8**:

- リファクタリングによる既存機能の破壊
- テストカバレッジの不足による回帰バグ
- パフォーマンス最適化による予期しない副作用

### 対策

- **早期の動作確認**: 各フェーズで動作確認
- **ドキュメント参照**: 実装前にドキュメントを確認
- **段階的な実装**: 小さな単位で実装
- **テストの実施**: 各フェーズでテストを実施

---

## 次のステップ

現在の実装状況:

- ✅ **Phase 1**: 完了（MVP、メンション応答型）
- ✅ **Phase 2**: 完了（NAS デプロイ、Docker 化）
- ✅ **Phase 3**: 完了（CI/CD と運用機能）
- ✅ **Phase 4**: 完了（機能改善）
- ✅ **Phase 5**: 完了（会話の契機拡張、スレッド型・聞き耳型）
- ✅ **Phase 6**: 完了（高度な機能、レート制限・コマンド・エラーハンドリング強化）
- ✅ **Phase 7**: 完了（aiosqlite への移行、非同期化）

次の実装ステップは **Phase 8（完全リファクタリング）** です。

**実装順序の推奨**:

1. ✅ **Phase 7（aiosqlite への移行）**: 完了（2026 年 1 月 15 日）

   - ✅ 技術的負債の早期解消（同期コードが非同期イベントハンドラーから呼ばれている問題）
   - ✅ Bot 全体のブロッキング問題を解決
   - ✅ Phase 11（監査ログ機能）の前提条件を満たした

2. **Phase 8（完全リファクタリング）**: Phase 7 完了後に実施

   - 非同期コードを基にリファクタリングする方が効率的
   - 非同期処理の最適化も含む
   - **重要**: `litellm.py` の戻り値を `tuple[str, dict]` に変更
     （Phase 10 と Phase 11 で必要）
   - 重複コードの削除（日付フォーマット、プロンプト読み込み、エラーメッセージ）

3. **Phase 9-18**: Phase 8 完了後に実施

   - **Phase 9**: 高度なモニタリング機能（運用の基盤、最優先）⭐⭐⭐⭐⭐
   - **Phase 10**: コスト管理機能（Phase 8 でトークン情報が取得できる状態）⭐⭐⭐⭐☆
   - **Phase 11**: 監査ログ機能（Phase 8 でトークン情報が取得できる状態）⭐⭐⭐⭐☆
   - **Phase 12-14**: 設定管理、パフォーマンス分析、ログ強化
   - **Phase 15-17**: 自動化・最適化機能
   - **Phase 18**: コスト計算機能

4. **Phase 19-24**: ロードマップ外の高優先度機能

   - **Phase 19**: 統合知識ベース機能（会話・添付ファイル・ウェブ）⭐⭐⭐⭐⭐
   - **Phase 20**: 会話の要約・ハイライト機能（知識ベース機能と同時に実装）⭐⭐⭐⭐⭐
   - **Phase 21**: 議題提案機能（知識ベース機能の後に実装）⭐⭐⭐⭐⭐
   - **Phase 22**: 聞き耳モードでの自動リアクション機能⭐⭐⭐⭐⭐
   - **Phase 23**: ポジティブフィードバック生成機能⭐⭐⭐⭐☆
   - **Phase 24**: 翻訳要約機能（多言語対応の強化）⭐⭐⭐⭐☆

5. **Phase 25-26**: ロードマップ外の低優先度機能（技術検討後）

   - **Phase 25**: 音声チャンネル機能（要約・議事録、合成音声発話）⭐⭐⭐☆☆
   - **Phase 26**: コンテキスト理解の向上機能⭐⭐⭐☆☆

各フェーズの詳細な実装手順については、各フェーズの実装計画書を参照してください。

**推奨実装順序**:

1. ✅ **Phase 7（aiosqlite への移行）**: 完了（2026 年 1 月 15 日）
2. **Phase 8（完全リファクタリング）**: Phase 7 完了後に実施
   - **重要**: `litellm.py` の戻り値を `tuple[str, dict]` に変更
   - 重複コードの削除（日付フォーマット、プロンプト読み込み、エラーメッセージ）
3. **Phase 9**: 高度なモニタリング機能（運用の基盤、最優先）⭐⭐⭐⭐⭐
   - 管理者用高機能ダッシュボード機能を含む
4. **Phase 10**: コスト管理機能（Phase 8 でトークン情報が取得できる状態）⭐⭐⭐⭐☆
5. **Phase 11**: 監査ログ機能（Phase 8 でトークン情報が取得できる状態）⭐⭐⭐⭐☆
6. **Phase 12-14**: 設定管理、パフォーマンス分析、ログ強化
7. **Phase 15-17**: 自動化・最適化機能
8. **Phase 18**: コスト計算機能
9. **Phase 19-24**: ロードマップ外の高優先度機能
   - **Phase 19**: 統合知識ベース機能
   - **Phase 20**: 会話の要約・ハイライト機能
   - **Phase 21**: 議題提案機能
   - **Phase 22**: 聞き耳モードでの自動リアクション機能
   - **Phase 23**: ポジティブフィードバック生成機能
   - **Phase 24**: 翻訳要約機能
10. **Phase 25-26**: ロードマップ外の低優先度機能（技術検討後）
    - **Phase 25**: 音声チャンネル機能
    - **Phase 26**: コンテキスト理解の向上機能

**詳細**: [Phase 8 実装計画](./phases/phase8.md)

---

**作成日**: 2026 年 1 月 14 日  
**最終更新日**: 2026 年 1 月 18 日（全機能を統合、実装順序と優先度を再整理）  
**バージョン**: 10.0  
**作成者**: kotonoha-bot 開発チーム

### 更新履歴

- **v10.0** (2026-01-18): 全機能を統合（統合知識ベース、翻訳要約、ポジティブフィードバック、議題提案、管理者用ダッシュボード）、実装順序と優先度を再整理
- **v9.0** (2026-01-17): Phase 8+ の内容を統合、Phase 9-11 をゼロベースで再構築、実装優先度を明確化
- **v8.0** (2026-01-15): Phase 7 の実装完了を反映、実装状況を更新
- **v7.0** (2026-01): Phase 6 の実装完了を反映、実装状況を更新
- **v6.0** (2026-01-15): Phase 7-11 の実装計画を追加、将来の機能拡張案を追加
- **v5.0** (2026-01-15): Phase 5 の実装完了を反映、実装状況を更新
- **v4.0** (2026-01-15): Phase 3 の実装完了を反映、実装状況を更新
- **v3.0** (2026-01-15): 実装状況に基づいてフェーズを再整理、各フェーズで実装すべき機能を明確化
- **v2.0** (2026-01-14): 実装状況の反映、チェックボックスの更新
- **v1.0** (2026-01-14): 初版リリース
