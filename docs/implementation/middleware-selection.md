# ミドルウェア選定書

## 1. 選定方針

- **無料で利用可能**: 無料枠または完全無料
- **安定性**: 実績のある技術
- **保守性**: 適切なドキュメントとコミュニティサポート
- **パフォーマンス**: 場面緘黙支援に適した応答速度

---

## 2. 選定結果一覧

| カテゴリ                   | 選定技術                  | 選定理由                                 | 代替候補               |
| -------------------------- | ------------------------- | ---------------------------------------- | ---------------------- |
| **言語**                   | Python 3.14               | 最新機能、discord.py との互換性          | Python 3.13            |
| **パッケージ管理**         | uv                        | 高速、モダンなパッケージ管理             | pip, poetry            |
| **Discord フレームワーク** | discord.py                | 最も一般的、豊富なドキュメント           | discord.js, disnake    |
| **AI 統合**                | LiteLLM                   | マルチプロバイダー統合、フェーズ別切替   | 各プロバイダー SDK     |
| **AI（開発）**             | Google Gemini API         | 無料枠が実用的、開発・テスト用           | -                      |
| **AI（本番）**             | Anthropic Claude API      | 最高品質、Claude Opus 4.5                | -                      |
| **データベース**           | SQLite                    | 軽量、ファイルベース、永続化に適している | PostgreSQL, MySQL      |
| **コンテナ**               | Docker                    | 標準的、Synology 対応                    | Podman                 |
| **CI/CD**                  | GitHub Actions            | GitHub と統合、無料                      | GitLab CI, Jenkins     |
| **コンテナレジストリ**     | GitHub Container Registry | GitHub と統合、無料                      | Docker Hub             |
| **自動更新**               | Watchtower                | シンプル、Docker 統合                    | Ouroboros              |

---

## 3. 詳細選定理由

### 3.1 Python 3.14

**選定理由**:

- 最新の Python 機能を利用できる
- discord.py との互換性が高い
- パフォーマンスの改善

**代替候補**: Python 3.13（互換性の観点から）

---

### 3.2 uv（パッケージ管理）

**選定理由**:

- 非常に高速なパッケージ管理
- Rust で実装されており、パフォーマンスが高い
- モダンな依存関係解決

**代替候補**:

- **pip**: 標準的だが、速度が遅い
- **poetry**: 機能が豊富だが、設定が複雑

---

### 3.3 discord.py

**選定理由**:

- Discord Bot 開発で最も一般的
- 豊富なドキュメントとコミュニティサポート
- 非同期処理に対応
- スレッド機能をサポート

**代替候補**:

- **discord.js**: Node.js ベース（Python プロジェクトには不適切）
- **disnake**: discord.py のフォーク（互換性の問題）

---

### 3.4 LiteLLM（AI 統合レイヤー）

**選定理由**:

- 複数の LLM プロバイダーを統一インターフェースで利用可能
- 環境変数の変更のみでプロバイダー切り替え
- フォールバック機能でプロバイダー障害時の自動切り替え
- コスト管理と使用量追跡が可能

**代替候補**:

- **各プロバイダー SDK の直接使用**: シンプルだが、切り替えにコード変更が必要

---

### 3.5 Google Gemini API（開発用）

**選定理由**:

- 無料枠が実用的（Flash: 15 回/分、1,500 回/日）
- 高速応答で開発・テストに最適
- 日本語対応が良好

**用途**: 開発・テストフェーズ

---

### 3.6 Anthropic Claude API（本番用）

**選定理由**:

- 最高品質の日本語応答
- 場面緘黙支援に必要な繊細で優しい表現が可能
- 長いコンテキストウィンドウ
- Claude Opus 4.5 は最高品質のモデル

**用途**:

- **Claude Sonnet 4.5**: 調整フェーズ（品質調整・プロンプト最適化）
- **Claude Opus 4.5**: 本番フェーズ（最高品質の運用）

---

### 3.7 SQLite

**選定理由**:

- 軽量でファイルベース
- セットアップが不要
- 単一サーバー運用に適している
- 永続化に十分

**代替候補**:

- **PostgreSQL**: 高機能だが、セットアップが複雑
- **MySQL**: 一般的だが、SQLite で十分

**将来の移行**: スケールが必要になった場合、PostgreSQL への移行を検討

---

### 3.8 Docker

**選定理由**:

- 標準的なコンテナ技術
- Synology Container Manager でサポート
- 豊富なドキュメント

**代替候補**:

- **Podman**: Docker 互換だが、Synology でサポートが限定的

---

### 3.9 GitHub Actions

**選定理由**:

- GitHub と統合
- 無料で利用可能
- 設定が簡単

**代替候補**:

- **GitLab CI**: 機能が豊富だが、GitHub を使用しているため不適切
- **Jenkins**: 高機能だが、セットアップが複雑

---

### 3.10 GitHub Container Registry (GHCR)

**選定理由**:

- GitHub と統合
- 無料で利用可能
- Watchtower と連携可能

**代替候補**:

- **Docker Hub**: 一般的だが、レート制限がある

---

### 3.11 Watchtower

**選定理由**:

- シンプルで使いやすい
- Docker コンテナの自動更新
- 設定が簡単

**代替候補**:

- **Ouroboros**: 機能が似ているが、Watchtower の方が一般的

---

## 4. 技術スタックの互換性

### 4.1 互換性マトリックス

| 技術            | Python 3.14 | discord.py | SQLite | Docker | 備考                  |
| --------------- | ----------- | ---------- | ------ | ------ | --------------------- |
| **Python 3.14** | 対応        | 対応       | 対応   | 対応   | 全てと互換            |
| **discord.py**  | 対応        | -          | 対応   | 対応   | SQLite は独立         |
| **SQLite**      | 対応        | 対応       | -      | 対応   | Python 標準ライブラリ |
| **Docker**      | 対応        | 対応       | 対応   | -      | 全てをコンテナ化      |

### 4.2 依存関係

```txt
Python 3.14
├── discord.py
│   └── aiohttp (非同期 HTTP)
├── litellm
│   ├── openai (内部依存)
│   └── httpx (HTTP クライアント)
├── aiosqlite
│   └── sqlite3 (標準ライブラリ)
└── python-dotenv
```

---

## 5. 選定プロセス

### 5.1 評価基準

| 基準               | 重み | 説明                       |
| ------------------ | ---- | -------------------------- |
| **コスト**         | 30%  | 無料で利用可能か           |
| **パフォーマンス** | 25%  | 応答速度、処理速度         |
| **安定性**         | 20%  | 実績、信頼性               |
| **保守性**         | 15%  | ドキュメント、コミュニティ |
| **拡張性**         | 10%  | 将来の拡張に対応できるか   |

### 5.2 評価結果

| 技術            | コスト | パフォーマンス | 安定性 | 保守性 | 拡張性 | 総合 |
| --------------- | ------ | -------------- | ------ | ------ | ------ | ---- |
| **Python 3.14** | 100    | 90             | 95     | 95     | 90     | 94   |
| **uv**          | 100    | 100            | 80     | 85     | 90     | 93   |
| **discord.py**  | 100    | 85             | 95     | 100    | 85     | 93   |
| **LiteLLM**     | 100    | 90             | 90     | 95     | 95     | 93   |
| **Claude API**  | 70     | 100            | 95     | 95     | 90     | 88   |
| **Gemini API**  | 100    | 90             | 95     | 90     | 85     | 93   |
| **SQLite**      | 100    | 85             | 95     | 90     | 70     | 90   |

---

## 6. リスクと対策

### 6.1 技術選定のリスク

| リスク                   | 影響度 | 対策                                                   |
| ------------------------ | ------ | ------------------------------------------------------ |
| **API の無料枠終了**     | 中     | LiteLLM で複数プロバイダー対応、フォールバック機能     |
| **本番コスト増加**       | 中     | 開発は無料枠、本番のみ有料モデルでコスト最適化         |
| **技術の非推奨化**       | 中     | 標準的な技術を選定、コミュニティの動向を監視           |
| **パフォーマンス問題**   | 中     | パフォーマンステスト、最適化                           |
| **プロバイダー障害**     | 低     | LiteLLM のフォールバック機能で自動切り替え             |

---

**作成日**: 2026年1月14日
**バージョン**: 1.0
**作成者**: kotonoha-bot 開発チーム
