# 機能一覧

初期からの機能を一覧化したものです。将来予定も含みます。

## 環境構築・インフラ

- Discord Bot の基本接続
- プロジェクト構造の作成
- pyproject.toml の設定
- Dockerfile の作成（マルチステージビルド）
- Docker Compose の作成
- NAS へのデプロイ（Synology Container Manager）
- 非 root ユーザーでの実行
- ヘルスチェック機能（HTTP エンドポイント）
- Watchtower による自動更新機能
- GitHub Actions CI ワークフロー（lint、format、type-check、test）
- GitHub Actions ビルドワークフロー（Docker イメージのビルド・プッシュ）
- GHCR への自動プッシュ（マルチプラットフォーム: amd64、arm64）

## AI 応答機能

- LiteLLM 統合
- システムプロンプトの実装
- 動的プロンプト生成（日付情報の注入）
- フォールバック機能（フォールバックモデルへの自動切り替え）
- メンション応答型（メンションされた時に応答）
- スレッド型（メンション検知時の自動スレッド作成）
- スレッド名の生成（メッセージの最初の 50 文字、文の区切りで切る）
- スレッド内での会話継続（メンション不要）
- スレッドアーカイブ検知とアーカイブ時のセッション保存
- 聞き耳型（LLM 判断機能による自動介入）
- 聞き耳型のチャンネルごとの有効/無効設定
- 聞き耳型のメインチャンネルへの直接投稿機能
- メッセージルーター（会話の契機判定ロジック）
- モデル切り替えオプション（メッセージからモデル選択指示を検出）（未実装）

## セッション管理

- aiosqlite データベースのセットアップ
- ChatSession クラスの実装
- セッション管理モジュール
- 会話履歴の保持と復元
- セッションキーの統一管理（メンション応答型、スレッド型、聞き耳型）
- バッチ同期の定期実行（5 分ごとにアイドル状態のセッションを自動保存）
- セッションクリーンアップの定期実行（1 時間ごと）
- セッション設定の環境変数対応（SESSION_TIMEOUT_HOURS、MAX_SESSIONS）
- aiosqlite への移行（非同期化）

## メッセージ処理

- メッセージ分割機能（2000 文字超の応答を検知して文の区切りで分割）
- 連番を付与して複数メッセージに分割
- Embed の活用（オプション、6000 文字制限あり）
- 応答メッセージにモデル情報フッターを追加（使用モデル名、レート制限使用率）

## レート制限対応

- レート制限モニタリング（API リクエスト数の追跡、レート制限の接近を検知、警告ログの出力）
- トークンバケットアルゴリズム（リクエストレートの制御、バースト対応、トークンの自動補充）
- リクエストキューイング（リクエストのキューイング、優先度管理（メンション > スレッド > 聞き耳型）、非同期処理）

## コマンド機能

- `/chat reset` コマンド（会話履歴リセット）
- `/chat status` コマンド（セッション状態表示）
- `/settings` コマンド（設定管理）（未実装）

## エラーハンドリング

- 基本的なエラーハンドリング
- API エラーの分類（RateLimitError、InternalServerError、AuthenticationError）
- リトライロジック（指数バックオフ、最大リトライ回数の設定、リトライ間隔の指数バックオフ）
- Discord API エラーの分類とユーザーフレンドリーなエラーメッセージの生成
- データベースエラーの分類とユーザーフレンドリーなエラーメッセージの生成
- 場面緘黙支援を考慮した表現

## ログ・監視

- ログ出力機能
- ログ管理（RotatingFileHandler）
- 通知機能（Discord Webhook、オプション）
- 基本的なメトリクス収集（API リクエスト数、レスポンス時間、エラー率など）（未実装）
- メトリクスエンドポイント（未実装）
- 管理者用高機能ダッシュボード機能（メトリクスの可視化、リアルタイム監視、履歴データの表示、エクスポート機能）（未実装）
- アラート機能（閾値超過時の通知）（未実装）
- ログ出力の強化（構造化ログ（JSON 形式）、ログ検索・フィルタリング機能、ログエクスポート機能）（未実装）

## バックアップ・データ管理

- バックアップ機能（SQLite オンラインバックアップ、gzip 圧縮）
- バックアップの自動化強化（スケジュールバックアップ、自動削除、検証、通知）（未実装）
- データベース最適化（自動最適化機能、クエリ最適化、データアーカイブ機能）（未実装）

## テスト・品質管理

- テストフレームワーク（pytest）の設定
- コード品質ツールの設定（Ruff、ty）
- テストディレクトリ構造
- 基本的なテストの実装

## コスト管理

- トークン使用量の詳細追跡（ユーザー・チャンネル・セッション・モデルごと）（未実装）
- コスト計算機能（トークン数からコストを計算、モデルごとのコスト単価管理）（未実装）
- コストレポート機能（日次・週次・月次のコスト集計、可視化、エクスポート）（未実装）
- 予算管理機能（予算の設定、予算超過時のアラート、コスト予測）（未実装）

## 監査・コンプライアンス

- 監査ログ機能（データベーススキーマの実装、AuditLogger クラスの実装、すべての応答生成箇所で監査ログを記録）（未実装）
- 月次集計機能（未実装）

## 設定管理

- グローバル設定（全サーバー共通、管理者のみ変更可能、デフォルト LLM モデル、システムプロンプトのカスタマイズ）（未実装）
- チャンネルごとの設定（聞き耳型の有効/無効、スレッド型の有効/無効、チャンネル固有の LLM モデル）（未実装）
- ユーザーごとの設定（ユーザー固有の LLM モデル）（未実装）
- ダッシュボードを用いた設定（Webアプリケーション + Discord OAuth2 による設定管理、Phase 9 のダッシュボードを拡張する形で実装可能）（未実装）

## パフォーマンス分析

- パフォーマンスメトリクスの収集（応答時間、スループット、リソース使用率）（未実装）
- 分析レポートの生成（日次・週次・月次）（未実装）
- ボトルネックの特定（遅延の原因分析、リソース制約の検出）（未実装）

## 知識ベース機能

- 会話からの知識抽出・要約（未実装）
- 添付ファイル（テキスト、PDF、画像など）からの知識抽出（未実装）
- ウェブコンテンツ（URL 指定）からの知識抽出（未実装）
- 統合検索機能（会話・ファイル・ウェブを横断検索）（未実装）
- 知識ベースの更新・管理機能（未実装）
- ダッシュボードによる管理・閲覧（未実装）

## 会話分析機能

- 会話の要約機能（未実装）
- 会話のハイライト抽出機能（未実装）
- 議題提案機能（未解決事項の抽出、継続課題の特定、議題の優先順位付け、議題の提案・管理）（未実装）
- 聞き耳モードでの自動リアクション機能（未実装）
- ポジティブフィードバック生成機能（会話の感情分析、ポジティブフィードバックの自動生成、週次サマリーの自動生成）（未実装）
- ダッシュボードによる管理・閲覧（未実装）

## 翻訳機能

- 会話の多言語翻訳機能（未実装）
- 要約の多言語翻訳機能（未実装）
- 自動言語検出（未実装）
- 翻訳品質の管理（未実装）
- ダッシュボードによる管理・閲覧（未実装）

## 音声チャンネル機能

- 音声録音機能（未実装）
- 文字起こし機能（未実装）
- 議事録生成機能（未実装）
- 合成音声生成機能（未実装）
- ダッシュボードによる管理・閲覧（未実装）

## コンテキスト理解機能

- ベクトルストア機能（未実装）
- 埋め込み生成機能（未実装）
- セマンティック検索機能（未実装）
- コンテキスト取得機能（未実装）
- ダッシュボードによる管理・閲覧（未実装）

## リファクタリング

- レイヤードアーキテクチャの明確化（未実装）
- 依存性注入の改善（未実装）
- 設定管理の階層化と分離（未実装）
- エラーハンドリングの統一（未実装）
- ログ設定の分離（未実装）
- 巨大ファイルの分割（handlers.py 833 行 → 複数モジュールに分割）（未実装）
- 型安全性の向上（未実装）
- テストの充実（未実装）
- フォルダ構造の最適化（未実装）
- 重複コードの削除（日付フォーマット、プロンプト読み込み、エラーメッセージ）（未実装）
- litellm.py の戻り値を tuple[str, dict] に変更（未実装）

## その他

- 聞き耳型のルールベース判断機能（キーワード検知、盛り上がり検知、ランダム判定）（未実装）
