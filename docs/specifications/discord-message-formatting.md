# Discord メッセージフォーマット仕様

Discord のメッセージで使用可能なリッチテキスト（Markdown）フォーマットについて説明します。

## 1. サポートされているフォーマット

Discord では Markdown ベースのテキスト装飾がサポートされています。

### 1.1 基本的な装飾

| 装飾           | 書き方                       | 表示例             |
| -------------- | ---------------------------- | ------------------ |
| **太字**       | `**太字**` または `__太字__` | **太字**           |
| _斜体_         | `*斜体*` または `_斜体_`     | _斜体_             |
| **_太字斜体_** | `***太字斜体***`             | **_太字斜体_**     |
| ~~打ち消し線~~ | `~~打ち消し線~~`             | ~~打ち消し線~~     |
| **下線**       | `__下線__`                   | **下線**           |
| スポイラー     | `\|\|ネタバレ\|\|`           | （クリックで表示） |

### 1.2 コード表示

| 装飾             | 書き方                     | 表示例               |
| ---------------- | -------------------------- | -------------------- |
| インラインコード | `` `コード` ``             | `コード`             |
| コードブロック   | ` ```言語名\nコード\n``` ` | 整形されたコード表示 |

**例**:

```text
`インラインコード`
```

```python
# コードブロック（言語指定あり）
def hello():
    print("Hello, World!")
```

### 1.3 引用

| 装飾       | 書き方                 | 表示例               |
| ---------- | ---------------------- | -------------------- |
| 1 行引用   | `> 引用文`             | > 引用文             |
| 複数行引用 | `>>> 複数行の\n引用文` | 複数行の引用ブロック |

### 1.4 見出し

| 装飾             | 書き方        | 表示例       |
| ---------------- | ------------- | ------------ |
| 見出し 1（最大） | `# 見出し1`   | # 見出し 1   |
| 見出し 2（中）   | `## 見出し2`  | ## 見出し 2  |
| 見出し 3（最小） | `### 見出し3` | ### 見出し 3 |

**注意**: 見出しは文字サイズを変更するものではなく、見出しスタイルとして表示されます。

### 1.5 サブテキスト（小さい文字）

| 装飾         | 書き方            | 表示例                     |
| ------------ | ----------------- | -------------------------- |
| サブテキスト | `-# サブテキスト` | 通常より小さく控えめな表示 |

**注意**: サブテキストは一部のクライアントで実験的な機能のため、全ユーザーで同じ見た目になるとは限りません。

---

## 2. サポートされていないフォーマット

### 2.1 水平線

**水平線はサポートされていません**。

- Markdown の `---` や `***` を書いても水平線にはなりません
- 代わりに、区切りが必要な場合は空行や装飾テキストを使用してください

**代替案**:

```text
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**

または

**────────────────────────────────────────**
```

### 2.2 自由なフォントサイズ指定

**CSS のような自由なフォントサイズ指定はできません**。

- 見出し（`#`, `##`, `###`）やサブテキスト（`-#`）でサイズを変えることはできますが、厳密にはフォントサイズの変更ではなく、見出しスタイルとして表示されます
- ピクセル単位やパーセントでのサイズ指定はできません

---

## 3. Embed メッセージ

Discord では Embed を使用することで、よりリッチなメッセージを送信できます。

### 3.1 Embed の特徴

- **最大文字数**: 6,000 文字（タイトル、説明、フィールドの合計）
- **通常メッセージとの比較**: 通常メッセージは 2,000 文字まで
- **カスタマイズ可能**: 色、フッター、画像、サムネイルなど

### 3.2 Embed の構造

```python
discord.Embed(
    title="タイトル",           # 最大 256 文字
    description="説明文",       # 最大 4,096 文字
    color=0x3498DB,            # 色（16進数）
    footer="フッター",          # 最大 2,048 文字
    fields=[                    # 最大 25 個
        {"name": "フィールド名", "value": "値", "inline": False}
    ]
)
```

### 3.3 本プロジェクトでの使用例

現在、本プロジェクトでは応答メッセージに Embed を使用しています：

**実装ファイル**: `src/kotonoha_bot/utils/message_formatter.py`

```python
def create_response_embed(
    content: str, model_name: str, rate_limit_usage: float | None = None
) -> discord.Embed:
    """応答メッセージ用のEmbedを作成

    Args:
        content: 応答テキスト
        model_name: 使用したモデル名（英語表記）
        rate_limit_usage: レート制限の使用率（0.0-1.0、Noneの場合は表示しない）

    Returns:
        Embedオブジェクト
    """
    embed = discord.Embed(
        description=content,        # 応答テキスト
        color=0x3498DB,             # 青色
    )
    # フッターにモデル名とレート制限使用率を表示（英語表記）
    footer_parts = [f"Model: {model_name}"]
    if rate_limit_usage is not None:
        usage_percent = rate_limit_usage * 100
        footer_parts.append(f"Rate limit: {usage_percent:.1f}%")
    embed.set_footer(text=" | ".join(footer_parts))
    return embed
```

**フッターの表示内容**:

- モデル名: `Model: {model_name}`（英語表記、例: `Model: anthropic/claude-sonnet-4-5`）
- レート制限使用率: `Rate limit: {usage_percent:.1f}%`（パーセンテージ形式、小数点以下 1 桁）
- 区切り文字: `|`（パイプ文字）

**実装状況**: ✅ Phase 6 で実装済み

---

## 4. メッセージ長制限

| 項目               | 制限                                                |
| ------------------ | --------------------------------------------------- |
| **通常メッセージ** | 最大 2,000 文字                                     |
| **Embed**          | 最大 6,000 文字（タイトル、説明、フィールドの合計） |
| **ファイル添付**   | 最大 25MB（Nitro ユーザーは 50MB）                  |

**実装上の考慮事項**:

- 本プロジェクトでは、2,000 文字を超える応答を自動的に分割しています
- 分割時は連番を付与（`**(1/3)**` など）して送信します
- Embed の最大長は 6,000 文字（`DISCORD_EMBED_MAX_LENGTH`）として定義されていますが、
  実際の分割は通常メッセージの 2,000 文字制限に基づいて行われます

**実装ファイル**: `src/kotonoha_bot/utils/message_splitter.py`

---

## 5. 本プロジェクトでの使用例

### 5.1 メッセージ分割時の連番表示

**実装ファイル**: `src/kotonoha_bot/utils/message_splitter.py`

```python
def format_split_messages(chunks: list[str], total: int) -> list[str]:
    """分割されたメッセージに連番を付与

    Args:
        chunks: 分割されたメッセージのリスト
        total: 総メッセージ数

    Returns:
        連番が付与されたメッセージのリスト
    """
    if len(chunks) == 1:
        return chunks

    formatted = []
    for i, chunk in enumerate(chunks, 1):
        header = f"**({i}/{total})**\n\n"  # 太字で連番を表示
        formatted.append(header + chunk)

    return formatted
```

**表示例**:

```txt
**(1/3)**

これは最初のメッセージです...

**(2/3)**

これは2番目のメッセージです...
```

**分割ロジック**:

メッセージは以下の優先順位で分割されます：

1. 句点 + 改行（`。\n`）
2. 句点（`。`）
3. 段落区切り（空行、`\n\n`）
4. 改行（`\n`）
5. 読点（`、`、`，`）
6. スペース（` `）

分割位置が見つからない場合は、最大長（2,000 文字）で強制的に分割されます。

**実装状況**: ✅ Phase 4 で実装済み

### 5.2 Embed での応答表示

**実装ファイル**: `src/kotonoha_bot/utils/message_formatter.py`

```python
embed = discord.Embed(
    description="応答テキスト",
    color=0x3498DB,  # 青色
)
embed.set_footer(text="Model: anthropic/claude-sonnet-4-5 | Rate limit: 45.2%")
```

**表示例**:

```txt
┌─────────────────────────────────────┐
│ 応答テキスト                         │
│                                     │
│                                     │
│ ─────────────────────────────────  │
│ Model: anthropic/claude-sonnet-4-5 │
│ Rate limit: 45.2%                   │
└─────────────────────────────────────┘
```

**メッセージ分割時の対応**:

- 最初のメッセージのみ Embed 形式で送信（フッターにモデル名とレート制限使用率を表示）
- 2 番目以降のメッセージは通常メッセージ形式で送信（連番のみ表示）

**実装状況**: ✅ Phase 6 で実装済み

### 5.3 使用されるモデル名

本プロジェクトで使用されるモデル名（フッターに表示される）:

- **デフォルト**: `anthropic/claude-sonnet-4-5`
- **判定用**: `anthropic/claude-haiku-4-5`
- **フォールバック**: `anthropic/claude-3-haiku-20240307`
- **本番用**: `anthropic/claude-opus-4-5`（環境変数で設定時）

**注意**: モデル名は英語表記で表示されます。

---

## 6. 制限事項と注意点

### 6.1 クライアントによる違い

- リッチテキスト表示は、Discord のクライアント（デスクトップ、モバイル、Web）によって挙動が異なることがあります
- 一部のフォーマット（サブテキストなど）は実験的な機能のため、全ユーザーで同じ見た目になるとは限りません

### 6.2 リッチテキストエディタとの互換性

- Discord のリッチテキストエディタと Markdown エディタの切り替えによって、表示が異なることがあります
- リッチテキストエディタで編集すると、一部の Markdown 記法が表示されなくなることがあります

### 6.3 推奨される使用方法

- **太字**: 重要な情報を強調する際に使用
- **コードブロック**: コードやコマンドを表示する際に使用
- **引用**: 他のメッセージを参照する際に使用
- **Embed**: 長文や構造化された情報を表示する際に使用

---

## 7. 参考資料

- [Discord 公式ブログ: リッチメッセージの表示方法](https://discord.com/blog/how-discord-renders-rich-messages-on-the-android-app)
- [Discord 公式ブログ: メッセージの装飾方法](https://discord.com/blog/make-your-discord-messages-bold-italic-underlined-and-more)
- [Discord サポート: Markdown フォーマット](https://support.discord.com/hc/en-us/articles/210298617-Markdown-Text-101-Chat-Formatting-Bold-Italic-Underline-)

---

**作成日**: 2026 年 1 月 15 日  
**最終更新日**: 2026 年 1 月（現在の実装に基づいて改訂）  
**バージョン**: 2.0  
**作成者**: kotonoha-bot 開発チーム

### 更新履歴

- **v2.0** (2026-01): 現在の実装に基づいて改訂
  - Embed のフッター表示内容を実装に合わせて更新（モデル名とレート制限使用率、英語表記）
  - メッセージ分割ロジックの詳細を追加（優先順位付き分割パターン）
  - メッセージ分割時の対応を追加（最初のメッセージのみ Embed、残りは通常メッセージ）
  - 使用されるモデル名の一覧を追加
  - 実装ファイルのパスを追加
  - 実装状況（Phase）を追加
- **v1.0** (2026-01-15): 初版リリース
