# コマンド・機能仕様書

## 1. スラッシュコマンド一覧

### 1.1 `/chat start`

**説明**: スレッド型の会話を開始します。Bot が自動でスレッドを作成し、その中で会話を続けます。

**構文**:

```text
/chat start [topic:文字列]
```

**パラメータ**:

- `topic` (オプション): 会話のトピック。スレッド名として使用されます。

**動作**:

1. メンションされたメッセージを起点としてスレッドを作成
2. スレッド名を設定（`topic` が指定されていない場合は、ユーザーの質問から端的で短い名前を自動生成）
   - メンション部分を除去したメッセージから生成
   - 最大 50 文字、文の区切り（。、！、？、.、!、?）で切る
   - メンションのみや空白のみの場合は「会話」をデフォルト名として使用
   - **固定スレッド名**: 一度設定したスレッド名は固定で、以降は更新しない
3. スレッド内で Bot が応答
4. 以降、スレッド内のメッセージには自動的に応答（メンション不要）

**応答例**:

```text
スレッドを作成しました。ここからお話ししましょう。何かお手伝いできることはありますか？
```

**エラー**:

- スレッド作成権限がない場合: "スレッドを作成する権限がありません。"
- スレッド作成に失敗した場合: "スレッドの作成に失敗しました。しばらく待ってから再度お試しください。"

---

### 1.2 `/chat reset`

**説明**: 現在の会話履歴をリセットします。新しい会話として開始できます。

**構文**:

```text
/chat reset
```

**パラメータ**: なし

**動作**:

1. 現在のセッションの会話履歴をクリア
2. メモリ内のセッションをリセット
3. SQLite の履歴は保持（アーカイブとして）

**応答例**:

```text
会話履歴をリセットしました。新しい会話として始めましょう。
```

**エラー**:

- セッションが見つからない場合: "会話履歴が見つかりませんでした。"

---

### 1.3 `/chat status`

**説明**: 現在のセッション状態を表示します。

**構文**:

```text
/chat status
```

**パラメータ**: なし

**動作**:

1. セッションタイプ（メンション/スレッド/DM/聞き耳型）を表示
2. 会話履歴の件数を表示
3. セッションの開始時刻を表示

**応答例**:

```text
現在のセッション情報:
- タイプ: スレッド型
- 会話履歴: 15件
- 開始時刻: 2024-01-15 10:30:00
```

---

### 1.4 `/settings`

**説明**: Bot の設定を表示・変更します（将来の拡張）。

**構文**:

```text
/settings [key:文字列] [value:文字列]
```

**パラメータ**:

- `key` (オプション): 設定キー
- `value` (オプション): 設定値

**動作**:

- パラメータなし: 現在の設定を表示
- `key` のみ: 指定された設定値を表示
- `key` と `value`: 設定値を変更

**応答例**:

```text
現在の設定:
- 応答温度: 0.7
- 最大トークン数: 2048
```

---

## 2. メンションコマンド

### 2.1 `@Kotonoha [メッセージ]`

**説明**: Bot にメンションして会話を開始します。

**動作**:

- **メンション応答型**: メンションされたメッセージに応答
- **スレッド型**: メンションされたメッセージを起点にスレッドを作成して応答

**応答**: AI が生成した自然な応答

---

## 3. 機能一覧

### 3.1 会話機能

| 機能名               | 説明                           | 実装状況 |
| -------------------- | ------------------------------ | -------- |
| **メンション応答**   | Bot がメンションされた時に応答 | Phase 1  |
| **スレッド型会話**   | スレッド内で会話を継続         | Phase 5  |
| **DM 会話**          | ダイレクトメッセージで会話     | Phase 5  |
| **聞き耳型会話**     | 自然に会話に参加               | Phase 5  |
| **会話履歴保持**     | 会話の文脈を保持               | Phase 1  |
| **会話履歴リセット** | 会話履歴をクリア               | Phase 5  |

### 3.2 セッション管理機能

| 機能名             | 説明                         | 実装状況 |
| ------------------ | ---------------------------- | -------- |
| **セッション作成** | 新しいセッションを作成       | Phase 1  |
| **セッション取得** | 既存セッションを取得         | Phase 1  |
| **セッション更新** | 会話履歴を更新               | Phase 1  |
| **セッション保存** | SQLite に永続化              | Phase 1  |
| **セッション復元** | ボット再起動時に復元         | Phase 1  |
| **セッション削除** | 非アクティブセッションを削除 | Phase 4  |

### 3.3 AI 機能

| 機能名               | 説明                       | 実装状況 |
| -------------------- | -------------------------- | -------- |
| **基本応答生成**     | Claude API で応答を生成    | Phase 1  |
| **モデル使い分け**   | タスクに応じてモデルを選択 | Phase 1  |
| **プロンプト最適化** | 場面緘黙支援向けプロンプト | Phase 1  |
| **判定機能**         | 聞き耳型の判定（Yes/No）   | Phase 5  |
| **フォールバック**   | API エラー時の代替処理     | Phase 1  |

### 3.4 エラーハンドリング機能

| 機能名               | 説明                                     | 実装状況    |
| -------------------- | ---------------------------------------- | ----------- |
| **API エラー処理**   | Claude/Discord API エラー処理            | Phase 1     |
| **レート制限対応**   | レート制限の監視と対応                   | Phase 6     |
| **リトライロジック** | エラー時の自動リトライ（指数バックオフ） | ✅ 実装済み |
| **エラーメッセージ** | ユーザーフレンドリーなエラー表示         | Phase 1     |

**リトライロジックの実装詳細**:

- 一時的なエラー（`InternalServerError`, `RateLimitError`）に対して自動リトライ
- 指数バックオフ（1 秒 → 2 秒 → 4 秒）
- 最大リトライ回数: 3 回（`LLM_MAX_RETRIES`で設定可能）
- HTTP 529（Overloaded）エラーに対応

### 3.5 運用機能

| 機能名             | 説明                           | 実装状況 |
| ------------------ | ------------------------------ | -------- |
| **ログ出力**       | 動作ログの記録                 | Phase 7  |
| **モニタリング**   | パフォーマンス監視             | Phase 7  |
| **バックアップ**   | データベースの自動バックアップ | Phase 7  |
| **ヘルスチェック** | システム状態の確認             | Phase 7  |

---

## 4. 機能詳細仕様

### 4.1 会話履歴保持機能

**仕様**:

- **保持期間**: セッションがアクティブな間
- **保持件数**: メモリ内 50 件、SQLite 全件
- **保存タイミング**:
  - リアルタイム: 重要な会話
  - バッチ: 5 分ごと
  - セッション終了時: 必ず保存

**データ構造**:

```python
{
    "role": "user" | "assistant" | "system",
    "content": str,
    "timestamp": datetime,
    "message_id": int
}
```

### 4.2 セッション管理機能

**セッションキー形式**:

- メンション応答型: `channel_id` または `channel_id:user_id`
- スレッド型: `thread_id`
- 聞き耳型: `eavesdrop:channel_id`

**ライフサイクル**:

1. 新規作成: セッション開始
2. アクティブ: 最後のメッセージから 5 分以内
3. アイドル: 5 分〜30 分経過
4. 非アクティブ: 30 分以上経過
5. SQLite 保存: アイドル/非アクティブ時に保存
6. 削除: 24 時間経過でメモリから削除

### 4.3 AI 応答生成機能

**プロンプト構造**:

```text
システムプロンプト
+ 会話履歴（直近N件）
+ ユーザーメッセージ
```

**モデル選択ロジック**:

- **Flash を使用**: 通常の会話、判定処理
- **Pro を使用**: 複雑な質問、高度な推論が必要な場合

**応答処理**:

1. プロンプト生成
2. API 呼び出し
3. レスポンス処理
4. メッセージ長チェック（2000 文字超の場合は分割）
5. Discord に送信

---

**作成日**: 2026 年 1 月 14 日
**バージョン**: 1.0
**作成者**: kotonoha-bot 開発チーム
