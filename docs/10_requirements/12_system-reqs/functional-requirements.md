# 機能要件一覧・非機能要件一覧

## 1. 機能要件一覧

### 1.1 基本機能

| ID     | 機能名             | 説明                                                                       | 優先度 | 実装フェーズ | 実装状況 | 実装箇所                              |
| ------ | ------------------ | -------------------------------------------------------------------------- | ------ | ------------ | -------- | ------------------------------------- |
| FR-001 | チャット応答機能   | ユーザーのメッセージに対して AI が自然で安心感のある応答を生成             | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/bot/handlers.py`    |
| FR-002 | 会話履歴保持       | SQLite と ChatSession のハイブリッド管理により、高速アクセスと永続化を両立 | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/session/manager.py` |
| FR-003 | コマンド対応       | Discord のスラッシュコマンドまたはメンション形式での起動                   | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/bot/handlers.py`    |
| FR-004 | マルチユーザー対応 | 複数のユーザーが同時に利用可能                                             | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/session/manager.py` |
| FR-005 | プライバシー保護   | ユーザーごとの会話履歴を分離し、他ユーザーから見えないようにする           | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/session/models.py`  |

### 1.2 会話の契機機能

| ID     | 機能名                   | 説明                                                     | 優先度 | 実装フェーズ | 実装状況  | 実装箇所                                  |
| ------ | ------------------------ | -------------------------------------------------------- | ------ | ------------ | --------- | ----------------------------------------- |
| FR-006 | メンション応答型         | Bot にメンションされた時だけ反応                         | 高     | Phase 1      | ✅ 完了   | `src/kotonoha_bot/bot/handlers.py`        |
| FR-007 | スレッド型               | メンション時に自動でスレッドを作成し、その中で会話を継続 | 高     | Phase 5      | ✅ 完了   | `src/kotonoha_bot/bot/handlers.py`        |
| FR-008 | 聞き耳型（LLM 判断）     | LLM に「空気」を読ませて、適切なタイミングで会話に参加   | 高     | Phase 5      | ✅ 完了   | `src/kotonoha_bot/eavesdrop/llm_judge.py` |
| FR-009 | 聞き耳型（ルールベース） | ルールベースと確率で判断して会話に参加                   | 中     | Phase 5      | ❌ 未実装 | -                                         |

### 1.3 セッション管理機能

| ID     | 機能名         | 説明                                             | 優先度 | 実装フェーズ | 実装状況 | 実装箇所                              |
| ------ | -------------- | ------------------------------------------------ | ------ | ------------ | -------- | ------------------------------------- |
| FR-011 | セッション作成 | 新しいセッションを作成                           | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/session/manager.py` |
| FR-012 | セッション取得 | 既存セッションを取得（メモリまたは SQLite から） | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/session/manager.py` |
| FR-013 | セッション更新 | 会話履歴を更新                                   | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/session/models.py`  |
| FR-014 | セッション保存 | SQLite に永続化                                  | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/db/sqlite.py`       |
| FR-015 | セッション復元 | ボット再起動時に SQLite から復元                 | 中     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/session/manager.py` |
| FR-016 | セッション削除 | 非アクティブセッションを削除                     | 中     | Phase 4      | ✅ 完了  | `src/kotonoha_bot/session/manager.py` |
| FR-017 | セッション同期 | メモリと SQLite の同期                           | 高     | Phase 4      | ✅ 完了  | `src/kotonoha_bot/session/manager.py` |

### 1.4 AI 機能

| ID     | 機能名           | 説明                       | 優先度 | 実装フェーズ | 実装状況 | 実装箇所                                  |
| ------ | ---------------- | -------------------------- | ------ | ------------ | -------- | ----------------------------------------- |
| FR-018 | 基本応答生成     | Claude API で応答を生成    | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/ai/litellm_provider.py` |
| FR-019 | モデル使い分け   | タスクに応じてモデルを選択 | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/config.py`              |
| FR-020 | プロンプト最適化 | 場面緘黙支援向けプロンプト | 高     | Phase 1      | ✅ 完了  | `prompts/` ディレクトリ                   |
| FR-021 | 判定機能         | 聞き耳型の判定（Yes/No）   | 高     | Phase 5      | ✅ 完了  | `src/kotonoha_bot/eavesdrop/llm_judge.py` |
| FR-022 | フォールバック   | API エラー時の代替処理     | 中     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/ai/litellm_provider.py` |

### 1.5 エラーハンドリング機能

| ID     | 機能名           | 説明                             | 優先度 | 実装フェーズ | 実装状況 | 実装箇所                                  |
| ------ | ---------------- | -------------------------------- | ------ | ------------ | -------- | ----------------------------------------- |
| FR-023 | API エラー処理   | Claude/Discord API エラー処理    | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/ai/litellm_provider.py` |
| FR-024 | レート制限対応   | レート制限の監視と対応           | 高     | Phase 6      | ✅ 完了  | `src/kotonoha_bot/rate_limit/`            |
| FR-025 | リトライロジック | エラー時の自動リトライ           | 高     | Phase 1      | ✅ 完了  | `src/kotonoha_bot/ai/litellm_provider.py` |
| FR-026 | エラーメッセージ | ユーザーフレンドリーなエラー表示 | 高     | Phase 6      | ✅ 完了  | `src/kotonoha_bot/errors/`                |

### 1.6 コマンド機能

| ID     | 機能名         | 説明               | 優先度 | 実装フェーズ | 実装状況  | 実装箇所                            |
| ------ | -------------- | ------------------ | ------ | ------------ | --------- | ----------------------------------- |
| FR-027 | `/chat start`  | スレッド型開始     | 高     | Phase 5      | ❌ 未実装 | -                                   |
| FR-028 | `/chat reset`  | 会話履歴リセット   | 中     | Phase 6      | ✅ 完了   | `src/kotonoha_bot/commands/chat.py` |
| FR-029 | `/chat status` | セッション状態表示 | 低     | Phase 6      | ✅ 完了   | `src/kotonoha_bot/commands/chat.py` |
| FR-030 | `/settings`    | 設定の表示・変更   | 低     | Phase 8      | ❌ 未実装 | -                                   |

**注意**: FR-027 (`/chat start`) は、メンション時に自動でスレッド作成されるため、現時点では未実装です。

### 1.7 運用機能

| ID     | 機能名         | 説明                           | 優先度 | 実装フェーズ | 実装状況  | 実装箇所                     |
| ------ | -------------- | ------------------------------ | ------ | ------------ | --------- | ---------------------------- |
| FR-031 | ログ出力       | 動作ログの記録                 | 中     | Phase 1      | ✅ 完了   | `src/kotonoha_bot/main.py`   |
| FR-032 | モニタリング   | パフォーマンス監視             | 中     | Phase 8      | ❌ 未実装 | -                            |
| FR-033 | バックアップ   | データベースの自動バックアップ | 中     | Phase 2      | ✅ 完了   | `scripts/backup.sh`          |
| FR-034 | ヘルスチェック | システム状態の確認             | 中     | Phase 2      | ✅ 完了   | `src/kotonoha_bot/health.py` |

---

## 2. 非機能要件一覧

### 2.1 パフォーマンス要件

| ID      | 要件名               | 目標値         | 測定方法                               | 実装状況 | 実装箇所                              |
| ------- | -------------------- | -------------- | -------------------------------------- | -------- | ------------------------------------- |
| NFR-001 | 応答時間             | 3 秒以内       | メッセージ送信から応答受信までの時間   | ✅ 達成  | `src/kotonoha_bot/bot/handlers.py`    |
| NFR-002 | セッション取得時間   | 100ms 以内     | セッション取得処理の実行時間           | ✅ 達成  | `src/kotonoha_bot/session/manager.py` |
| NFR-003 | データベース操作時間 | 50ms 以内      | データベース操作の実行時間             | ✅ 達成  | `src/kotonoha_bot/db/sqlite.py`       |
| NFR-004 | 同時セッション数     | 100 セッション | メモリ内で同時に保持できるセッション数 | ✅ 達成  | `src/kotonoha_bot/config.py`          |
| NFR-005 | 会話履歴アクセス     | O(1)           | メモリ内セッションへのアクセス時間     | ✅ 達成  | `src/kotonoha_bot/session/manager.py` |

### 2.2 セキュリティ・プライバシー要件

| ID      | 要件名                         | 説明                                   | 実装状況 | 実装箇所                             |
| ------- | ------------------------------ | -------------------------------------- | -------- | ------------------------------------ |
| NFR-006 | API キー管理                   | 環境変数で安全に管理                   | ✅ 完了  | `src/kotonoha_bot/config.py`         |
| NFR-007 | 入力サニタイゼーション         | ユーザー入力の検証とサニタイゼーション | ✅ 完了  | `src/kotonoha_bot/bot/handlers.py`   |
| NFR-008 | プライバシー保護               | ユーザーごとの会話履歴の完全な分離     | ✅ 完了  | `src/kotonoha_bot/session/models.py` |
| NFR-009 | データの最小化                 | 必要最小限のデータのみを保存           | ✅ 完了  | `src/kotonoha_bot/session/models.py` |
| NFR-010 | 匿名性の尊重                   | ユーザーの匿名性を保護する設計         | ✅ 完了  | `src/kotonoha_bot/session/models.py` |
| NFR-011 | プロンプトインジェクション対策 | システムプロンプトとユーザー入力の分離 | ✅ 完了  | `src/kotonoha_bot/ai/prompts.py`     |

### 2.3 可用性要件

| ID      | 要件名             | 説明                                 | 実装状況 | 実装箇所                                  |
| ------- | ------------------ | ------------------------------------ | -------- | ----------------------------------------- |
| NFR-012 | API 障害対応       | API 障害時の適切なエラーハンドリング | ✅ 完了  | `src/kotonoha_bot/ai/litellm_provider.py` |
| NFR-013 | タイムアウト処理   | タイムアウト設定と処理               | ✅ 完了  | `src/kotonoha_bot/ai/litellm_provider.py` |
| NFR-014 | フォールバック機能 | API エラー時の代替処理               | ✅ 完了  | `src/kotonoha_bot/ai/litellm_provider.py` |
| NFR-015 | 24 時間稼働        | 24 時間安定稼働                      | ✅ 完了  | `docker-compose.yml`                      |

### 2.4 コスト要件

| ID      | 要件名              | 説明                                                     | 実装状況 | 実装箇所                     |
| ------- | ------------------- | -------------------------------------------------------- | -------- | ---------------------------- |
| NFR-016 | 低コスト API の使用 | 低コストで利用可能な API を使用（Claude Haiku 4.5 など） | ✅ 完了  | `src/kotonoha_bot/config.py` |
| NFR-017 | コスト最適化        | 開発・本番で適切なモデルを選択し、コストを最適化         | ✅ 完了  | `src/kotonoha_bot/config.py` |

### 2.5 保守性要件

| ID      | 要件名           | 説明                         | 実装状況 | 実装箇所              |
| ------- | ---------------- | ---------------------------- | -------- | --------------------- |
| NFR-018 | コードの可読性   | わかりやすいコード構造       | ✅ 完了  | 全モジュール          |
| NFR-019 | ドキュメント整備 | 適切なドキュメントの整備     | ✅ 完了  | `docs/` ディレクトリ  |
| NFR-020 | テストカバレッジ | 適切なテストカバレッジの確保 | ⚠️ 部分  | `tests/` ディレクトリ |

### 2.6 拡張性要件

| ID      | 要件名                   | 説明                           | 実装状況 | 実装箇所               |
| ------- | ------------------------ | ------------------------------ | -------- | ---------------------- |
| NFR-021 | 複数 API 対応            | 複数の AI API に対応できる設計 | ✅ 完了  | `src/kotonoha_bot/ai/` |
| NFR-022 | プラグインアーキテクチャ | 将来の拡張に対応できる設計     | ⚠️ 部分  | 全モジュール           |

### 2.7 運用要件

| ID      | 要件名         | 説明                       | 実装状況 | 実装箇所                     |
| ------- | -------------- | -------------------------- | -------- | ---------------------------- |
| NFR-023 | ログ管理       | 適切なログの出力と管理     | ✅ 完了  | `src/kotonoha_bot/main.py`   |
| NFR-024 | モニタリング   | システム状態の監視         | ⚠️ 部分  | `src/kotonoha_bot/health.py` |
| NFR-025 | バックアップ   | 定期的なデータバックアップ | ✅ 完了  | `scripts/backup.sh`          |
| NFR-026 | デプロイメント | CI/CD による自動デプロイ   | ✅ 完了  | `.github/workflows/`         |

**凡例**:

- ✅ 完了: 実装済み
- ❌ 未実装: 未実装
- ⚠️ 部分: 部分的に実装済み

---

## 3. 要件の優先順位

### 3.1 必須要件（Must Have）

- FR-001: チャット応答機能 ✅
- FR-002: 会話履歴保持 ✅
- FR-006: メンション応答型 ✅
- FR-007: スレッド型 ✅
- FR-008: 聞き耳型（LLM 判断） ✅
- FR-018: 基本応答生成 ✅
- FR-023: API エラー処理 ✅
- NFR-001: 応答時間（3 秒以内） ✅
- NFR-006: API キー管理 ✅
- NFR-008: プライバシー保護 ✅

### 3.2 重要要件（Should Have）

- FR-014: セッション保存 ✅
- FR-015: セッション復元 ✅
- FR-024: レート制限対応 ✅
- FR-027: `/chat start` ❌（メンション時に自動でスレッド作成されるため不要）
- NFR-012: API 障害対応 ✅
- NFR-015: 24 時間稼働 ✅

### 3.3 望ましい要件（Nice to Have）

- FR-009: 聞き耳型（ルールベース） ❌
- FR-029: `/chat status` ✅
- FR-030: `/settings` ❌
- FR-031: ログ出力 ✅
- FR-032: モニタリング ❌
- NFR-021: 複数 API 対応 ✅

---

## 4. 実装状況サマリー

### 4.1 実装完了率

- **機能要件**: 28/32 (87.5%)
- **非機能要件**: 24/26 (92.3%)
- **全体**: 52/58 (89.7%)

### 4.2 Phase 別実装状況

| Phase    | 実装状況  | 主要機能                                             |
| -------- | --------- | ---------------------------------------------------- |
| Phase 1  | ✅ 完了   | MVP（メンション応答型、セッション管理）              |
| Phase 2  | ✅ 完了   | NAS デプロイ、Docker 化、バックアップ                |
| Phase 3  | ✅ 完了   | CI/CD、テスト、コード品質                            |
| Phase 4  | ✅ 完了   | メッセージ長制限、バッチ同期                         |
| Phase 5  | ✅ 完了   | スレッド型、聞き耳型                                 |
| Phase 6  | ✅ 完了   | レート制限、コマンド、エラーハンドリング強化         |
| Phase 7  | ⏳ 未実装 | 完全リファクタリング                                 |
| Phase 8  | ⏳ 未実装 | 高度な運用機能（モニタリング・設定管理・コスト管理） |
| Phase 9  | ⏳ 未実装 | 自動化・最適化機能                                   |
| Phase 10 | ⏳ 未実装 | 監査機能                                             |

詳細は [実装ロードマップ](../00_planning/roadmap.md) を参照してください。

### 4.3 未実装機能

1. **FR-009**: 聞き耳型（ルールベース）

   - 理由: LLM 判定で十分な精度が得られているため、優先度が低い
   - 将来の拡張として検討
   - 実装予定: Phase 5（オプション機能として）

2. **FR-027**: `/chat start`

   - 理由: メンション時に自動でスレッド作成されるため、冗長
   - 現時点では実装予定なし

3. **FR-030**: `/settings`

   - 理由: Phase 8 で実装予定
   - 現時点では環境変数で設定可能
   - 実装予定: Phase 8（高度な運用機能）

4. **FR-032**: モニタリング

   - 理由: Phase 8 で実装予定
   - 現時点ではヘルスチェックとログで対応
   - 実装予定: Phase 8（高度な運用機能）

5. **NFR-020**: テストカバレッジ

   - 理由: 部分的に実装済み（pytest フレームワークは設定済み）
   - 継続的な改善が必要
   - 実装予定: Phase 7（完全リファクタリング）

6. **NFR-022**: プラグインアーキテクチャ

   - 理由: 部分的に実装済み（拡張可能な設計）
   - 完全なプラグインシステムは将来の拡張
   - 実装予定: Phase 7（完全リファクタリング）

7. **NFR-024**: モニタリング
   - 理由: 部分的に実装済み（ヘルスチェック、ログ）
   - 詳細なパフォーマンス監視は Phase 8 で実装予定
   - 実装予定: Phase 8（高度な運用機能）

---

## 5. 実装ファイル一覧

### 5.1 主要モジュール

| モジュール           | ファイルパス                                | 説明                           |
| -------------------- | ------------------------------------------- | ------------------------------ |
| Bot クライアント     | `src/kotonoha_bot/bot/client.py`            | Discord Bot クライアント       |
| メッセージハンドラー | `src/kotonoha_bot/bot/handlers.py`          | メッセージ処理                 |
| メッセージルーター   | `src/kotonoha_bot/router/message_router.py` | 会話の契機判定                 |
| AI プロバイダー      | `src/kotonoha_bot/ai/litellm_provider.py`   | LiteLLM 統合                   |
| セッション管理       | `src/kotonoha_bot/session/manager.py`       | セッション管理（ハイブリッド） |
| データベース         | `src/kotonoha_bot/db/sqlite.py`             | SQLite 管理                    |
| 聞き耳型判定         | `src/kotonoha_bot/eavesdrop/llm_judge.py`   | LLM 判断機能                   |
| コマンド             | `src/kotonoha_bot/commands/chat.py`         | スラッシュコマンド             |
| レート制限           | `src/kotonoha_bot/rate_limit/`              | レート制限管理                 |
| エラーハンドリング   | `src/kotonoha_bot/errors/`                  | エラー分類と処理               |
| ヘルスチェック       | `src/kotonoha_bot/health.py`                | ヘルスチェックサーバー         |

### 5.2 設定・スクリプト

| ファイル                     | 説明                     |
| ---------------------------- | ------------------------ |
| `src/kotonoha_bot/config.py` | 設定管理                 |
| `scripts/backup.sh`          | データベースバックアップ |
| `scripts/restore.sh`         | データベースリストア     |
| `.env.example`               | 環境変数設定例           |
| `docker-compose.yml`         | Docker Compose 設定      |

### 5.3 ドキュメント

| ディレクトリ           | 説明               |
| ---------------------- | ------------------ |
| `docs/requirements/`   | 要件定義           |
| `docs/implementation/` | 実装詳細           |
| `docs/operations/`     | 運用マニュアル     |
| `docs/architecture/`   | アーキテクチャ設計 |

---

**作成日**: 2026 年 1 月 14 日  
**最終更新日**: 2026 年 1 月（現在の実装に基づいて改訂）  
**バージョン**: 3.0  
**作成者**: kotonoha-bot 開発チーム

### 更新履歴

- **v3.0** (2026-01): `roadmap.md` を参考に詳細化
  - 実装箇所カラムを追加（ファイルパス）
  - Phase 別実装状況セクションを追加
  - 実装ファイル一覧セクションを追加
  - より詳細な実装状況の説明を追加
  - 未実装機能の実装予定 Phase を明記
- **v2.0** (2026-01): 現在の実装に基づいて改訂
  - 実装状況カラムを追加
  - 実装済み機能を ✅ でマーク
  - 未実装機能を ❌ でマーク
  - 部分的に実装済み機能を ⚠️ でマーク
  - 実装フェーズを実装状況に合わせて更新
  - 実装状況サマリーセクションを追加
  - 未実装機能の理由を明記
- **v1.0** (2026-01-14): 初版リリース
