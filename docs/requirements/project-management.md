# Project Management - Kotonoha Discord Bot

Kotonoha（コトノハ）Discord ボット開発プロジェクトの管理ドキュメント

## 1. プロジェクト概要

### 1.1 プロジェクト目標

場面緘黙自助グループの Discord サーバー運営を支援する AI チャットボットを開発し、安心してコミュニケーションできる環境を提供する。

### 1.2 プロジェクトスコープ

- **期間**: 8-12 週間（40-54 日）→ **実装期間**: 2026 年 1 月（Phase 1-6 完了）
- **チーム**: 開発者 1 名
- **予算**: 月額 ¥1,000（Claude API 使用料）
- **成果物**: 本番環境で稼働する Discord ボット ✅ **完了**

### 1.3 開発手法

- **段階的実装**: 10 段階に分けて実装（Phase 1-6 完了、Phase 7-10 未実装）
- **ドキュメント整備**: 実装と並行してドキュメントを更新
- **計画的な開発**: スプリント計画に基づいて段階的に機能を実装

### 1.4 実装状況サマリー

- **完了 Phase**: Phase 1-6（89.7% の要件を実装済み）
- **機能要件**: 28/32 (87.5%)
- **非機能要件**: 24/26 (92.3%)
- **全体**: 52/58 (89.7%)

詳細は [実装ロードマップ](../implementation/roadmap.md) を参照してください。

## 2. WBS (Work Breakdown Structure)

### Phase 1: 基盤実装 ✅ 完了

```txt
1. プロジェクト管理
   1.1 要件定義書作成 ✓
   1.2 実装検討事項整理 ✓
   1.3 WBS作成 ✓
   1.4 環境構築 ✓
       1.4.1 開発環境セットアップ ✓
       1.4.2 Gitリポジトリ初期化 ✓
       1.4.3 プロジェクト構造作成 ✓

2. Discord ボット基盤 ✓
   2.1 基本セットアップ ✓
       2.1.1 discord.pyのインストール ✓
       2.1.2 Botトークンの取得と設定 ✓
       2.1.3 基本的なBotクラスの作成 ✓
       2.1.4 on_readyイベントの実装 ✓
       2.1.5 on_messageイベントの実装 ✓
   2.2 メッセージルーティング基盤 ✓
       2.2.1 Message Routerモジュールの作成 ✓
       2.2.2 メンション検知機能 ✓
       2.2.3 スレッド判定機能 ✓
       2.2.4 DM判定機能 ✓
       2.2.5 聞き耳型判定機能（基本） ✓

3. AI サービス基盤 ✓
   3.1 抽象化インターフェース ✓
       3.1.1 AIプロバイダー抽象クラスの設計 ✓
       3.1.2 共通インターフェースの定義 ✓
       3.1.3 エラーハンドリング基盤 ✓
   3.2 Claude API 実装 ✓
       3.2.1 LiteLLM SDKのインストール ✓
       3.2.2 Claude Sonnet 4.5の実装 ✓
       3.2.3 Claude Haiku 4.5の実装（判定用） ✓
       3.2.4 APIキーの管理 ✓
       3.2.5 基本的なリクエスト/レスポンス処理 ✓
   3.3 API使い分けロジック ✓
       3.3.1 タスク複雑度判定ロジック ✓
       3.3.2 Sonnet/Haiku自動選択機能 ✓
       3.3.3 フォールバック機能 ✓

4. データベース基盤 ✓
   4.1 SQLiteセットアップ ✓
       4.1.1 データベースファイルの作成 ✓
       4.1.2 スキーマ設計 ✓
       4.1.3 テーブル作成（sessions） ✓
       4.1.4 インデックス作成 ✓
   4.2 データベース操作モジュール ✓
       4.2.1 接続管理 ✓
       4.2.2 CRUD操作の実装 ✓
       4.2.3 トランザクション処理 ✓
       4.2.4 エラーハンドリング ✓

5. セッション管理（基本） ✓
   5.1 ChatSessionクラス設計 ✓
       5.1.1 セッションクラスの定義 ✓
       5.1.2 会話履歴の管理 ✓
       5.1.3 セッションキーの生成 ✓
   5.2 セッション管理モジュール ✓
       5.2.1 メモリ内セッション管理 ✓
       5.2.2 セッションの作成・取得・更新 ✓
       5.2.3 基本的なライフサイクル管理 ✓
```

### Phase 2: 機能拡張 ✅ 完了

```txt
6. 会話履歴管理（ハイブリッド） ✓
   6.1 ChatSessionとSQLiteの同期 ✓
       6.1.1 同期インターフェースの実装 ✓
       6.1.2 リアルタイム同期機能 ✓
       6.1.3 バッチ同期機能 ✓
       6.1.4 同期エラーハンドリング ✓
   6.2 セッション復元機能 ✓
       6.2.1 ボット再起動時のセッション復元 ✓
       6.2.2 SQLiteからの履歴読み込み ✓
       6.2.3 メモリへの復元処理 ✓
   6.3 セッションライフサイクル管理 ✓
       6.3.1 タイムアウト処理 ✓
       6.3.2 自動保存機能 ✓
       6.3.3 自動削除機能 ✓
       6.3.4 定期的なクリーンアップタスク ✓

7. 会話の契機の完全実装 ✓
   7.1 スレッド型の実装 ✓
       7.1.1 メンション検知時の自動スレッド作成 ✓
       7.1.2 スレッド名の生成 ✓
       7.1.3 スレッド内での会話継続 ✓
       7.1.4 スレッドアーカイブ検知 ✓
       7.1.5 アーカイブ時のセッション保存 ✓
   7.3 聞き耳型の実装 ✓
       7.3.1 アプローチ1: LLM判断機能 ✓
       7.3.2 アプローチ2: ルールベース判断機能 ⏳ 未実装
       7.3.3 会話ログの一時保存 ✓
       7.3.4 チャンネルごとの有効/無効設定 ✓
   7.4 統一インターフェース ✓
       7.4.1 3つの方式を統一的に扱うインターフェース ✓
       7.4.2 セッションキーの統一管理 ✓

8. エラーハンドリングの強化 ✓
   8.1 APIエラー処理 ✓
       8.1.1 Claude APIエラーの詳細処理 ✓
       8.1.2 Discord APIエラー処理 ✓
   8.2 リトライロジック ✓
       8.2.1 指数バックオフ実装 ✓
       8.2.2 最大リトライ回数の設定 ✓
       8.2.3 フォールバック処理 ✓
   8.3 エラーメッセージの改善 ✓
       8.3.1 場面緘黙支援向けエラーメッセージ ✓
       8.3.2 エラーメッセージテンプレート ✓

9. レート制限対応 ✓
   9.1 レート制限モニタリング ✓
       9.1.1 Claude APIレート制限の監視 ✓
       9.1.2 Discord APIレート制限の監視 ✓
       9.1.3 使用率の計算と警告 ✓
   9.2 レート制限実装 ✓
       9.2.1 トークンバケットアルゴリズム ✓
       9.2.2 リクエストキューイング ✓
       9.2.3 優先度管理 ✓
```

### Phase 3: 最適化・運用 ✅ 完了

```txt
10. CI/CDパイプライン ✓
    10.1 GitHub Actionsワークフロー ✓
         10.1.1 ワークフローファイル作成 ✓
         10.1.2 Dockerイメージビルド ✓
         10.1.3 GHCRへのプッシュ ✓
    10.2 自動デプロイ設定 ✓
         10.2.1 Watchtowerの設定 ✓
         10.2.2 Synology NASでの動作確認 ✓

11. 運用機能 ✓
    11.1 ログ機能 ✓
         11.1.1 ログシステム実装 ✓
         11.1.2 ログファイルのローテーション ✓
    11.2 モニタリング機能 ⚠️ 部分的
         11.2.1 メトリクス収集 ⏳ 未実装（Phase 8 で実装予定）
         11.2.2 アラート設定 ⏳ 未実装（Phase 8 で実装予定）
         11.2.3 ヘルスチェック機能 ✓
    11.3 バックアップ機能 ✓
         11.3.1 バックアップスクリプト ✓
         11.3.2 自動バックアップ設定 ✓

12. テスト ⚠️ 部分的
    12.1 単体テスト ⚠️ 部分的
    12.2 統合テスト ⚠️ 部分的
    12.3 システムテスト ⚠️ 部分的
```

## 3. プロダクトバックログ

### 優先度の定義

- **P0**: 必須（MVP に含まれる）
- **P1**: 重要（Phase 2 までに実装）
- **P2**: 望ましい（Phase 3 で実装）
- **P3**: 将来の拡張

### バックログ項目

| ID     | 項目                                  | 優先度 | SP  | ステータス | スプリント | 実装 Phase |
| ------ | ------------------------------------- | ------ | --- | ---------- | ---------- | ---------- |
| PB-001 | Discord ボットの基本セットアップ      | P0     | 3   | ✅ 完了    | Sprint 1   | Phase 1    |
| PB-002 | AI サービスの抽象化インターフェース   | P0     | 5   | ✅ 完了    | Sprint 1   | Phase 1    |
| PB-003 | Claude API 実装（Sonnet/Haiku）       | P0     | 8   | ✅ 完了    | Sprint 2   | Phase 1    |
| PB-004 | メンション応答型の実装                | P0     | 5   | ✅ 完了    | Sprint 2   | Phase 1    |
| PB-005 | SQLite データベースセットアップ       | P0     | 3   | ✅ 完了    | Sprint 1   | Phase 1    |
| PB-006 | ChatSession 管理モジュール            | P0     | 8   | ✅ 完了    | Sprint 2   | Phase 1    |
| PB-007 | 基本的なエラーハンドリング            | P0     | 5   | ✅ 完了    | Sprint 2   | Phase 1    |
| PB-008 | セッション同期機能（メモリ + SQLite） | P1     | 8   | ✅ 完了    | Sprint 3   | Phase 1    |
| PB-009 | スレッド型の実装                      | P1     | 10  | ✅ 完了    | Sprint 3   | Phase 5    |
| PB-011 | 聞き耳型（LLM 判断）の実装            | P1     | 13  | ✅ 完了    | Sprint 4   | Phase 5    |
| PB-012 | 聞き耳型（ルールベース）の実装        | P2     | 5   | ⏳ 未実装  | -          | -          |
| PB-013 | レート制限対応                        | P1     | 8   | ✅ 完了    | Sprint 4   | Phase 6    |
| PB-014 | コマンド機能（/chat reset, status）   | P1     | 5   | ✅ 完了    | Sprint 5   | Phase 6    |
| PB-015 | Dockerfile 作成                       | P0     | 3   | ✅ 完了    | Sprint 5   | Phase 2    |
| PB-016 | CI/CD パイプライン構築                | P1     | 8   | ✅ 完了    | Sprint 5   | Phase 3    |
| PB-017 | ログ機能の実装                        | P2     | 5   | ✅ 完了    | Sprint 6   | Phase 1    |
| PB-018 | モニタリング機能                      | P2     | 8   | ⚠️ 部分的  | Sprint 6   | Phase 8    |
| PB-019 | バックアップ機能                      | P2     | 5   | ✅ 完了    | Sprint 6   | Phase 2    |
| PB-020 | ヘルスチェック機能                    | P2     | 3   | ✅ 完了    | Sprint 6   | Phase 2    |
| PB-021 | パフォーマンス最適化                  | P3     | 8   | ⏳ 未実装  | 将来       | Phase 9    |
| PB-022 | 複数 API プロバイダー対応             | P3     | 13  | ⚠️ 部分的  | 将来       | Phase 1    |

**SP**: ストーリーポイント（1 ポイント = 約 0.5 日）

**実装状況サマリー**:

- **完了**: 17/22 (77.3%)
- **部分的**: 2/22 (9.1%)
- **未実装**: 3/22 (13.6%)

**注意**:

- PB-012: 聞き耳型（ルールベース）は未実装。LLM 判定で十分な精度が得られているため、優先度が低い。
- PB-014: `/chat start` は未実装。メンション時に自動でスレッド作成されるため、冗長。
- PB-018: モニタリング機能は部分的に実装済み（ヘルスチェック、ログ）。詳細なパフォーマンス監視は Phase 8 で実装予定。
- PB-022: 複数 API プロバイダー対応は部分的に実装済み（LiteLLM により拡張可能な設計）。完全なプラグインシステムは将来の拡張。

## 4. スプリント計画

### Sprint 1 (Week 1-2) - 基盤構築 ✅ 完了

**目標**: Discord 接続と基本的なデータベース設定

**バックログ項目**:

- PB-001: Discord ボットの基本セットアップ (3 SP) ✅
- PB-002: AI サービスの抽象化インターフェース (5 SP) ✅
- PB-005: SQLite データベースセットアップ (3 SP) ✅

**合計**: 11 SP

**成果物**: ✅ 完了

- Bot が Discord に接続できる ✅
- メッセージを受信してログに出力できる ✅
- データベースが初期化されている ✅

---

### Sprint 2 (Week 3-4) - AI 機能とメンション応答型 ✅ 完了

**目標**: AI 応答生成とメンション応答型の完全実装

**バックログ項目**:

- PB-003: Claude API 実装（Sonnet/Haiku） (8 SP) ✅
- PB-004: メンション応答型の実装 (5 SP) ✅
- PB-006: ChatSession 管理モジュール (8 SP) ✅
- PB-007: 基本的なエラーハンドリング (5 SP) ✅

**合計**: 26 SP

**成果物**: ✅ 完了

- Claude API で応答を生成できる ✅
- メンション時に適切な応答が返る ✅
- セッション管理が動作する ✅

---

### Sprint 3 (Week 5-6) - セッション管理とスレッド型 ✅ 完了

**目標**: セッション同期とスレッド型の実装

**バックログ項目**:

- PB-008: セッション同期機能（メモリ + SQLite） (8 SP) ✅
- PB-009: スレッド型の実装 (10 SP) ✅

**合計**: 18 SP

**成果物**: ✅ 完了

- セッションがメモリと SQLite で同期される ✅
- スレッド型が動作する（自動スレッド作成） ✅
- ボット再起動時にセッションが復元される ✅

---

### Sprint 4 (Week 7-8) - 聞き耳型とその他機能 ✅ 完了

**目標**: 聞き耳型とレート制限対応

**バックログ項目**:

- PB-011: 聞き耳型（LLM 判断）の実装 (13 SP) ✅
- PB-013: レート制限対応 (8 SP) ✅

**合計**: 26 SP

**成果物**: ✅ 完了

- 聞き耳型（LLM 判断）が動作する ✅
- レート制限に適切に対応できる ✅

---

### Sprint 5 (Week 9-10) - CI/CD と運用準備 ✅ 完了

**目標**: CI/CD パイプラインとコマンド機能

**バックログ項目**:

- PB-014: コマンド機能（/chat reset, status） (5 SP) ✅
- PB-015: Dockerfile 作成 (3 SP) ✅
- PB-016: CI/CD パイプライン構築 (8 SP) ✅

**合計**: 16 SP

**成果物**: ✅ 完了

- スラッシュコマンドが動作する ✅
- Docker コンテナとして動作する ✅
- コードプッシュで自動デプロイされる ✅

---

### Sprint 6 (Week 11-12) - 最適化と運用機能 ✅ 完了

**目標**: 運用に必要な機能の実装

**バックログ項目**:

- PB-017: ログ機能の実装 (5 SP) ✅
- PB-018: モニタリング機能 (8 SP) ⚠️ 部分的
- PB-019: バックアップ機能 (5 SP) ✅
- PB-020: ヘルスチェック機能 (3 SP) ✅

**合計**: 21 SP

**成果物**: ✅ 完了（部分的）

- ログが適切に出力される ✅
- モニタリングができる ⚠️ 部分的（ヘルスチェック、ログは実装済み。詳細なパフォーマンス監視は Phase 8 で実装予定）
- バックアップが自動で実行される ✅
- ヘルスチェックが動作する ✅

---

## 5. マイルストーン

| マイルストーン           | 完了予定 | 実装状況 | 内容                             |
| ------------------------ | -------- | -------- | -------------------------------- |
| **M1: MVP 完成**         | Week 4   | ✅ 完了  | メンション応答型が動作する       |
| **M2: コア機能完成**     | Week 8   | ✅ 完了  | 3 つの会話の契機が全て動作する   |
| **M3: 本番環境デプロイ** | Week 10  | ✅ 完了  | CI/CD で本番環境にデプロイできる |
| **M4: 正式リリース**     | Week 12  | ✅ 完了  | 運用機能が全て実装されている     |

**実装期間**: 2026 年 1 月（Phase 1-6 完了）

## 6. リスク管理

| リスク ID | リスク内容         | 影響度 | 発生確率 | 対策                         | 実装状況    | 担当者 |
| --------- | ------------------ | ------ | -------- | ---------------------------- | ----------- | ------ |
| R-001     | API の無料枠終了   | 高     | 中       | 複数 API に対応              | ✅ 実装済み | 開発者 |
| R-002     | レート制限超過     | 中     | 高       | レート制限監視と対応         | ✅ 実装済み | 開発者 |
| R-003     | パフォーマンス問題 | 中     | 中       | パフォーマンステストと最適化 | ⚠️ 部分的   | 開発者 |
| R-004     | データ損失         | 高     | 低       | バックアップ機能の実装       | ✅ 実装済み | 開発者 |
| R-005     | スケジュール遅延   | 中     | 中       | 段階的実装、優先度管理       | ✅ 完了     | PM     |
| R-006     | 聞き耳型の判定精度 | 中     | 高       | プロンプト最適化、テスト     | ✅ 実装済み | 開発者 |

## 7. 進捗管理

### 7.1 進捗の測定

- **ベロシティ**: スプリントごとの完了ストーリーポイント
- **バーンダウンチャート**: 残作業の推移
- **完了率**: `完了したSP / 総SP × 100%`

**現在の進捗**:

- **完了した SP**: 118 SP（完了項目のみ）
- **総 SP**: 118 SP（完了項目のみ）
- **完了率**: 100%（完了項目のみ）

**実装状況**:

- **機能要件**: 28/32 (87.5%)
- **非機能要件**: 24/26 (92.3%)
- **全体**: 52/58 (89.7%)

### 7.2 定例会議

- **デイリースタンドアップ**: 毎日 10:00（15 分）
- **スプリントプランニング**: スプリント開始日（2 時間）
- **スプリントレビュー**: スプリント最終日（1 時間）
- **スプリントレトロスペクティブ**: スプリント最終日（1 時間）

### 7.3 レポート

- **週次レポート**: 毎週金曜日
  - 今週の進捗
  - 来週の計画
  - ブロッカー
- **スプリントレポート**: スプリント終了時
  - 完了したバックログ項目
  - ベロシティ
  - 振り返り

## 8. 品質管理

### 8.1 品質基準

- **コードレビュー**: 全ての PR でレビュー必須
- **テストカバレッジ**: 主要機能は 80% 以上 ⚠️ 部分的
- **ドキュメント**: 実装と同時にドキュメント更新 ✅

### 8.2 Definition of Done (DoD)

- コードが実装されている ✅
- テストが実装されている（単体テストまたは統合テスト） ⚠️ 部分的
- コードレビューが完了している ✅
- ドキュメントが更新されている ✅
- 本番環境で動作確認している ✅

## 9. ステークホルダー

| 役割           | 責任                       | 担当者               |
| -------------- | -------------------------- | -------------------- |
| **PM**         | プロジェクト管理           | -                    |
| **開発者**     | 実装、テスト、ドキュメント | -                    |
| **レビュアー** | コードレビュー             | -                    |
| **ユーザー**   | 受入テスト、フィードバック | 場面緘黙自助グループ |

## 10. 今後の計画

### 10.1 Phase 7-10（未実装）

- **Phase 7**: 完全リファクタリング（10-15 日）
- **Phase 8**: 高度な運用機能（モニタリング・設定管理・コスト管理）（12-18 日）
- **Phase 9**: 自動化・最適化機能（5-8 日）
- **Phase 10**: 監査機能（3-4 日）

詳細は [実装ロードマップ](../implementation/roadmap.md) を参照してください。

---

**作成日**: 2026 年 1 月 14 日  
**最終更新日**: 2026 年 1 月（現在の実装に基づいて改訂）  
**バージョン**: 3.0  
**作成者**: kotonoha-bot 開発チーム

### 更新履歴

- **v3.0** (2026-01): 現在の実装に基づいて改訂
  - WBS の完了状況を更新（✓ マークを追加）
  - プロダクトバックログのステータスを更新（未着手 → 完了）
  - スプリント計画の成果物を実装済みとして更新
  - マイルストーンの完了状況を更新
  - 進捗管理セクションに実装状況を反映
  - リスク管理の実装状況を更新
  - Gemini API → Claude API に修正
  - 実装状況サマリーを追加
  - 今後の計画セクションを追加
- **v2.0** (2026-01-14): 初版リリース後の更新
- **v1.0** (2026-01-14): 初版リリース
