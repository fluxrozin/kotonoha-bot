# 会話の契機の詳細説明

Kotonoha は、ユーザーの使い方に応じて 3 つの会話方式をサポートします。

## 1. メンション応答型（基本）

**挙動:**

- ユーザーが Bot にメンション（@BotName）を送った時だけ反応
- 例: ユーザー「@Kotonoha こんにちは」→ Bot「こんにちは！」

**メリット:**

- 必要な時だけ呼び出せるので、他の会話の邪魔にならない
- 実装がシンプル（`on_message` イベントでメンション判定するだけ）

**デメリット:**

- 毎回 @ を打つのが面倒
- 会話が長引くとタイムラインが Bot の返信で埋め尽くされる

**履歴管理:**

- `message.reference` を辿るか、チャンネル ID で管理
- セッションキー: `channel_id` または `channel_id:user_id`

---

## 2. スレッド型（AI チャットに最適）⭐ **推奨**

**挙動:**

- **ユーザーはメンションするだけ**: メインチャンネルで「@Kotonoha 今日は何月？」とメンション
- **Bot が自動でスレッドを作成**: Bot がその発言を起点として、自動的にスレッドを作成
- **Bot がスレッド内で応答**: 「現在は 1 月です（ここからはスレッドで話しましょう）」と返事
- **継続**: ユーザーはスレッド内で会話を続ける（もうメンションは不要）
- **ユーザー体験**: 「メンションしたら勝手に個室（スレッド）が用意された」という感覚

**技術的な理由（なぜスレッドが必須か）:**

- **会話履歴の取得が簡単**: スレッド内のメッセージを取得するだけで、その話題に関係する発言だけが純粋に取れる
- **コンテキストの分離**: 他の人の雑談が混ざらないため、Bot が混乱しない
- **スレッドがない場合の問題**: メインチャンネルで混ざって会話すると、Bot は「どれが自分宛てで、どれが関係ない雑談か」を判断できず、トンチンカンな発言をするリスクがある

**メリット:**

- メインのチャンネルを汚さない
- 「会話の区切り」が明確（スレッド ID = 1 つの会話セッションとして履歴管理しやすい）
- スレッドをアーカイブ（閉じる）すれば、会話終了も明確
- 場面緘黙支援に最適（プライベートな会話空間を提供）
- **ユーザーは手動でスレッドを作る必要がない**（Bot が自動化）

**デメリット:**

- Bot 側のスレッド作成処理が必要（ただし、ユーザーには見えない）

**履歴管理:**

- スレッド ID をセッションキーとして使用
- セッションキー: `thread_id`
- スレッドアーカイブ時にセッションを SQLite に保存

---

## 3. 聞き耳型（自然な会話参加）⭐ **場面緘黙支援に最適**

**挙動:**

- **「聞き耳を立てていて、話に入りたくなったら入ってくる」**という、人間と同じような挙動
- 技術的には**「常駐型（全てのメッセージを読み取る）」**だが、全てのメッセージに返信するのではなく、**「今、自分が発言すべきか？」という判断ロジック**を挟む
- 会話の流れを理解し、適切なタイミングで自然に会話に参加

**メリット:**

- 人間らしい自然な会話参加が可能
- 場面緘黙支援に最適（プレッシャーを感じさせず、自然な会話の流れを作る）
- ユーザーが積極的に話しかけなくても、会話に参加できる
- コミュニティの雰囲気を和らげる効果

**デメリット:**

- 全ての発言に対して判断処理が必要（API リクエストが増える）
- 実装がやや複雑
- 空気を読めないタイミングで発言するリスク

**実装アプローチ:**

Kotonoha は 2 つのアプローチをサポートします。

### 4.1 アプローチ 1: LLM に「空気」を読ませる（推奨・高精度）⭐

**重要な前提:**

- **スレッドを作らない**: メインチャンネルに直接書き込む
- **目的**: 「みんなの雑談に混ざること」が目的のため、スレッドを作ると会話の流れを切ってしまう
- **イメージ**: 「クラスの賑やかし役」として自然に会話に参加

**2 段階処理フロー:**

ユーザーが発言するたびに、Bot は以下のフローを実行します。

1. **受信**: ユーザーのメッセージを受け取る
2. **バッファ**: 直近の会話ログ（10〜20 件程度）に追加する
3. **判定フェーズ（裁判官）**:
   - 軽量な AI（Gemini 1.5 Flash）にログを渡す
   - **「今、君が割り込むべき？ YES か NO で答えて」**と聞く
   - AI が「NO」と言った ➡ 何もしない（無視）
   - AI が「YES」と言った ➡ 発言生成フェーズへ
4. **発言生成フェーズ（演者）**:
   - 再度 AI にログを渡し、「返信文を作って」と依頼する
   - Discord のメインチャンネルに直接書き込む

**判定用プロンプトの重要性:**

判定用 AI への指示（プロンプト）が最も重要です。以下のような指示を毎回送ります。

```txt
あなたはDiscordのチャットボットです。
キャラクター設定: [場面緘黙支援に優しい、安心感のある応答]

以下の会話履歴を見て、あなたが「今すぐに発言して会話に割って入るべき状況」かどうかを判定してください。

判断基準:
- ユーザーが困っていて助けが必要そうな時: YES
- 誰かがあなたの名前を呼んだ時: YES
- 場を和らげる発言が適切な時: YES
- シリアスな話、プライベートな話、関係ない話題: NO

回答は "YES" または "NO" の単語のみで答えてください。余計な説明は不要です。
```

**メリット:**

- かなり人間らしく、文脈に沿った「良いタイミング」で入ってこれる
- 場面緘黙支援に最適（自然な会話の流れを提供）
- **誤爆が少ない**: 単純なキーワード反応だと誤反応するが、LLM なら文脈で判断できる
- **圧倒的に「賢く」見える**: 文脈を理解して入ってくるので、ユーザーは「Bot に見守られている」感覚になる

**デメリット:**

- **レスポンスが少し遅れる**: 「判定」→「生成」と 2 回 AI を叩くため、返答までに 2〜4 秒程度かかる
- **API リクエスト数が増える**: 全てのメッセージに対して「判定」のリクエストを送るため、活発なサーバーだと無料枠の上限（2026 年 1 月現在: Gemini Flash なら 1 分間 5 回、1 日 20 回）に引っかかりやすい
- **記憶の混濁（コンテキストのノイズ）**: メインチャンネルで複数の話題が混ざると、Bot が混乱しやすく、トンチンカンな発言をするリスクが少し高まる（スレッド型なら話題ごとに部屋が分かれるのでこの問題は起きない）

**技術仕様:**

- 判断用 AI: Gemini 2.5 Flash または Gemini 2.5 Flash Lite（高速・無料枠、ただし制限あり）
- 会話ログ保持: 直近 10〜20 件のメッセージ
- 判断プロンプト: Yes/No のみの簡潔な応答を要求（判定用プロンプトの最適化が重要）
- 応答生成: 判断が「YES」の場合のみ、通常の AI 応答を生成
- **発言場所**: メインチャンネルに直接書き込む（スレッドは作成しない）

### 4.2 アプローチ 2: ルールベースと確率（省エネ・高速）

**重要な前提:**

- **スレッドを作らない**: アプローチ 1 と同様に、メインチャンネルに直接書き込む
- **目的**: 省エネ・高速な判断が必要な場合に使用

**仕組み:**

- **キーワード検知**: 「Bot」「誰か」「教えて」「助けて」などの単語が含まれていたら 50%の確率で反応する
- **盛り上がり検知**: 「1 分間に 5 件以上の投稿があったら（盛り上がっていると判断して）、挨拶する」
- **ランダム**: 全てのメッセージに対して、3%～ 5%の確率で勝手にリプライする

**メリット:**

- API を無駄遣いしない（判定用の API リクエストが不要）
- 実装が簡単
- 高速な判断が可能（プログラム側で即座に判定）

**デメリット:**

- 文脈を無視して入ってくるので、シリアスな話をしている時に「ウケるｗ」とか言ってしまい、空気が読めない（KY な）Bot になるリスクがある
- 場面緘黙支援には不向き（不適切なタイミングで発言する可能性）
- **記憶の混濁**: アプローチ 1 と同様に、メインチャンネルで複数の話題が混ざると混乱しやすい

**技術仕様:**

- キーワードリスト: 設定ファイルで管理
- 確率設定: 設定可能（デフォルト: キーワード検知 50%、ランダム 3%）
- 盛り上がり検知: 時間窓とメッセージ数の閾値を設定可能

**履歴管理:**

- チャンネルごとの会話ログを一時保存（直近 10〜20 件）
- セッションキー: `eavesdrop:channel_id`
- 判断ログは保存しない（判断のみで、会話履歴には含めない）
- **発言場所**: メインチャンネルに直接書き込む（スレッドは作成しない）

**設定:**

- チャンネルごとに有効/無効を設定可能
- アプローチ 1 と 2 の選択が可能
- 判断の感度調整（より積極的/控えめ）が可能

---

## 4. スレッド型と聞き耳型の比較

| 特徴                   | スレッド型（AI チャット）                        | 聞き耳型（空気を読む）                               |
| ---------------------- | ------------------------------------------------ | ---------------------------------------------------- |
| **イメージ**           | 「相談窓口 / カウンター」                        | 「クラスの賑やかし役」                               |
| **Bot の発言場所**     | 作成されたスレッドの中だけ                       | メインのタイムラインに直接                           |
| **スレッド作成**       | Bot が自動で作成（ユーザーはメンションするだけ） | スレッドを作らない                                   |
| **会話の続き方**       | スレッド内の発言なら、Bot は無条件で返信する     | Bot は毎回「また自分が答えるべきか？」を再度判定する |
| **記憶(コンテキスト)** | そのスレッド内の会話ログだけを読み込む           | チャンネルの「直近 ○ 件」を常に読み込む              |
| **主な用途**           | Q&A、相談、ロールプレイ、作業支援                | 雑談、ツッコミ、盛り上げ役                           |
| **場面緘黙支援**       | プライベートな会話空間を提供                     | 自然な会話の流れを作る                               |
| **コンテキストの分離** | 話題ごとに部屋が分かれるので混濁しない           | 複数の話題が混ざると混乱しやすい                     |

---

**作成日**: 2026 年 1 月 14 日
**バージョン**: 1.0
**作成者**: kotonoha-bot 開発チーム
