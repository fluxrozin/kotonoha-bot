# 機能要件一覧・非機能要件一覧

## 1. 機能要件一覧

### 1.1 基本機能

| ID     | 機能名             | 説明                                                                    | 優先度 | 実装フェーズ |
| ------ | ------------------ | ----------------------------------------------------------------------- | ------ | ------------ |
| FR-001 | チャット応答機能   | ユーザーのメッセージに対して AI が自然で安心感のある応答を生成          | 高     | Phase 1      |
| FR-002 | 会話履歴保持       | SQL と ChatSession のハイブリッド管理により、高速アクセスと永続化を両立 | 高     | Phase 1      |
| FR-003 | コマンド対応       | Discord のスラッシュコマンドまたはメンション形式での起動                | 高     | Phase 1      |
| FR-004 | マルチユーザー対応 | 複数のユーザーが同時に利用可能                                          | 高     | Phase 1      |
| FR-005 | プライバシー保護   | ユーザーごとの会話履歴を分離し、他ユーザーから見えないようにする        | 高     | Phase 1      |

### 1.2 会話の契機機能

| ID     | 機能名                   | 説明                                                     | 優先度 | 実装フェーズ |
| ------ | ------------------------ | -------------------------------------------------------- | ------ | ------------ |
| FR-006 | メンション応答型         | Bot にメンションされた時だけ反応                         | 高     | Phase 1      |
| FR-007 | スレッド型               | メンション時に自動でスレッドを作成し、その中で会話を継続 | 高     | Phase 2      |
| FR-008 | DM 型                    | Bot と 1 対 1 で DM で会話                               | 中     | Phase 2      |
| FR-009 | 聞き耳型（LLM 判断）     | LLM に「空気」を読ませて、適切なタイミングで会話に参加   | 高     | Phase 2      |
| FR-010 | 聞き耳型（ルールベース） | ルールベースと確率で判断して会話に参加                   | 中     | Phase 2      |

### 1.3 セッション管理機能

| ID     | 機能名         | 説明                                             | 優先度 | 実装フェーズ |
| ------ | -------------- | ------------------------------------------------ | ------ | ------------ |
| FR-011 | セッション作成 | 新しいセッションを作成                           | 高     | Phase 1      |
| FR-012 | セッション取得 | 既存セッションを取得（メモリまたは SQLite から） | 高     | Phase 1      |
| FR-013 | セッション更新 | 会話履歴を更新                                   | 高     | Phase 1      |
| FR-014 | セッション保存 | SQLite に永続化                                  | 高     | Phase 2      |
| FR-015 | セッション復元 | ボット再起動時に SQLite から復元                 | 中     | Phase 2      |
| FR-016 | セッション削除 | 非アクティブセッションを削除                     | 中     | Phase 2      |
| FR-017 | セッション同期 | メモリと SQLite の同期                           | 高     | Phase 2      |

### 1.4 AI 機能

| ID     | 機能名             | 説明                       | 優先度 | 実装フェーズ |
| ------ | ------------------ | -------------------------- | ------ | ------------ |
| FR-018 | 基本応答生成       | Gemini API で応答を生成    | 高     | Phase 1      |
| FR-019 | Flash/Pro 使い分け | タスクに応じてモデルを選択 | 高     | Phase 1      |
| FR-020 | プロンプト最適化   | 場面緘黙支援向けプロンプト | 高     | Phase 1      |
| FR-021 | 判定機能           | 聞き耳型の判定（Yes/No）   | 高     | Phase 2      |
| FR-022 | フォールバック     | API エラー時の代替処理     | 中     | Phase 3      |

### 1.5 エラーハンドリング機能

| ID     | 機能名           | 説明                             | 優先度 | 実装フェーズ |
| ------ | ---------------- | -------------------------------- | ------ | ------------ |
| FR-023 | API エラー処理   | Gemini/Discord API エラー処理    | 高     | Phase 1      |
| FR-024 | レート制限対応   | レート制限の監視と対応           | 高     | Phase 2      |
| FR-025 | リトライロジック | エラー時の自動リトライ           | 高     | Phase 2      |
| FR-026 | エラーメッセージ | ユーザーフレンドリーなエラー表示 | 高     | Phase 1      |

### 1.6 コマンド機能

| ID     | 機能名         | 説明               | 優先度 | 実装フェーズ |
| ------ | -------------- | ------------------ | ------ | ------------ |
| FR-027 | `/chat start`  | スレッド型開始     | 高     | Phase 2      |
| FR-028 | `/chat reset`  | 会話履歴リセット   | 中     | Phase 2      |
| FR-029 | `/chat status` | セッション状態表示 | 低     | Phase 2      |
| FR-030 | `/settings`    | 設定の表示・変更   | 低     | Phase 3      |

### 1.7 運用機能

| ID     | 機能名         | 説明                           | 優先度 | 実装フェーズ |
| ------ | -------------- | ------------------------------ | ------ | ------------ |
| FR-031 | ログ出力       | 動作ログの記録                 | 中     | Phase 3      |
| FR-032 | モニタリング   | パフォーマンス監視             | 中     | Phase 3      |
| FR-033 | バックアップ   | データベースの自動バックアップ | 中     | Phase 3      |
| FR-034 | ヘルスチェック | システム状態の確認             | 中     | Phase 3      |

---

## 2. 非機能要件一覧

### 2.1 パフォーマンス要件

| ID      | 要件名               | 目標値         | 測定方法                               |
| ------- | -------------------- | -------------- | -------------------------------------- |
| NFR-001 | 応答時間             | 3 秒以内       | メッセージ送信から応答受信までの時間   |
| NFR-002 | セッション取得時間   | 100ms 以内     | セッション取得処理の実行時間           |
| NFR-003 | データベース操作時間 | 50ms 以内      | データベース操作の実行時間             |
| NFR-004 | 同時セッション数     | 100 セッション | メモリ内で同時に保持できるセッション数 |
| NFR-005 | 会話履歴アクセス     | O(1)           | メモリ内セッションへのアクセス時間     |

### 2.2 セキュリティ・プライバシー要件

| ID      | 要件名                         | 説明                                   |
| ------- | ------------------------------ | -------------------------------------- |
| NFR-006 | API キー管理                   | 環境変数で安全に管理                   |
| NFR-007 | 入力サニタイゼーション         | ユーザー入力の検証とサニタイゼーション |
| NFR-008 | プライバシー保護               | ユーザーごとの会話履歴の完全な分離     |
| NFR-009 | データの最小化                 | 必要最小限のデータのみを保存           |
| NFR-010 | 匿名性の尊重                   | ユーザーの匿名性を保護する設計         |
| NFR-011 | プロンプトインジェクション対策 | システムプロンプトとユーザー入力の分離 |

### 2.3 可用性要件

| ID      | 要件名             | 説明                                 |
| ------- | ------------------ | ------------------------------------ |
| NFR-012 | API 障害対応       | API 障害時の適切なエラーハンドリング |
| NFR-013 | タイムアウト処理   | タイムアウト設定と処理               |
| NFR-014 | フォールバック機能 | API エラー時の代替処理               |
| NFR-015 | 24 時間稼働        | 24 時間安定稼働                      |

### 2.4 コスト要件

| ID      | 要件名            | 説明                            |
| ------- | ----------------- | ------------------------------- |
| NFR-016 | 無料 API のみ使用 | 無料で利用可能な API のみを使用 |
| NFR-017 | 無料枠内での運用  | 無料枠の範囲内での運用          |

### 2.5 保守性要件

| ID      | 要件名           | 説明                         |
| ------- | ---------------- | ---------------------------- |
| NFR-018 | コードの可読性   | わかりやすいコード構造       |
| NFR-019 | ドキュメント整備 | 適切なドキュメントの整備     |
| NFR-020 | テストカバレッジ | 適切なテストカバレッジの確保 |

### 2.6 拡張性要件

| ID      | 要件名                   | 説明                           |
| ------- | ------------------------ | ------------------------------ |
| NFR-021 | 複数 API 対応            | 複数の AI API に対応できる設計 |
| NFR-022 | プラグインアーキテクチャ | 将来の拡張に対応できる設計     |

### 2.7 運用要件

| ID      | 要件名         | 説明                       |
| ------- | -------------- | -------------------------- |
| NFR-023 | ログ管理       | 適切なログの出力と管理     |
| NFR-024 | モニタリング   | システム状態の監視         |
| NFR-025 | バックアップ   | 定期的なデータバックアップ |
| NFR-026 | デプロイメント | CI/CD による自動デプロイ   |

---

## 3. 要件の優先順位

### 3.1 必須要件（Must Have）

- FR-001: チャット応答機能
- FR-002: 会話履歴保持
- FR-006: メンション応答型
- FR-007: スレッド型
- FR-009: 聞き耳型（LLM 判断）
- FR-018: 基本応答生成
- FR-023: API エラー処理
- NFR-001: 応答時間（3 秒以内）
- NFR-006: API キー管理
- NFR-008: プライバシー保護

### 3.2 重要要件（Should Have）

- FR-008: DM 型
- FR-014: セッション保存
- FR-015: セッション復元
- FR-024: レート制限対応
- FR-027: `/chat start`
- NFR-012: API 障害対応
- NFR-015: 24 時間稼働

### 3.3 望ましい要件（Nice to Have）

- FR-010: 聞き耳型（ルールベース）
- FR-029: `/chat status`
- FR-030: `/settings`
- FR-031: ログ出力
- FR-032: モニタリング
- NFR-021: 複数 API 対応

---

**作成日**: 2026年1月14日
**バージョン**: 1.0
**作成者**: kotonoha-bot 開発チーム
