# テスト仕様書

## 1. 単体テスト仕様

### 1.1 セッション管理テスト

#### TEST-001: セッションの作成

**テスト項目**: 新しいセッションを作成できること

**前提条件**: セッション管理モジュールが初期化されている

**テスト手順**:

1. `create_session("test:123", "mention", user_id=123)` を実行
2. セッションが正しく作成されていることを確認
3. `session_key`, `session_type`, `user_id` が正しく設定されていることを確認

**期待結果**: セッションが作成され、正しい情報が設定されている

**実装状況**: ✅ 実装済み（`tests/unit/test_session.py::test_create_session`）

**テストデータ**:

```python
session_key = "test:123"
session_type = "mention"
user_id = 123
```

---

#### TEST-002: セッションの取得（メモリから）

**テスト項目**: メモリ内のセッションを取得できること

**前提条件**: セッションがメモリに存在する

**テスト手順**:

1. `create_session("test:123", "mention")` でセッションを作成
2. `get_session("test:123")` を実行
3. セッションが取得できることを確認

**期待結果**: セッションが正しく取得できる

**実装状況**: ✅ 実装済み（`tests/unit/test_session.py::test_get_session`）

---

#### TEST-003: メッセージの追加

**テスト項目**: セッションにメッセージを追加できること

**前提条件**: セッションが存在する

**テスト手順**:

1. セッションを作成
2. `add_message("test:123", MessageRole.USER, "こんにちは")` を実行
3. メッセージが追加されていることを確認

**期待結果**: メッセージが正しく追加される

**実装状況**: ✅ 実装済み（`tests/unit/test_session.py::test_add_message`）

---

#### TEST-004: セッションの保存

**テスト項目**: セッションを SQLite に保存できること

**前提条件**: セッションが存在し、データベースが初期化されている

**テスト手順**:

1. セッションを作成してメッセージを追加
2. `save_session("test:123")` を実行
3. データベースから直接読み込んで保存されていることを確認

**期待結果**: セッションがデータベースに保存される

**実装状況**: ✅ 実装済み（`tests/unit/test_session.py::test_save_session`）

---

### 1.2 データベーステスト

#### TEST-005: セッションの保存と読み込み

**テスト項目**: セッションを SQLite に保存し、読み込めること

**前提条件**: データベースが初期化されている

**テスト手順**:

1. `ChatSession` を作成してメッセージを追加
2. `save_session(session)` を実行
3. `load_session("test:123")` で読み込み
4. セッションとメッセージが正しく復元されることを確認

**期待結果**: セッションが正しく保存・読み込まれる

**実装状況**: ✅ 実装済み（`tests/unit/test_db.py::test_save_and_load_session`）

---

#### TEST-006: 存在しないセッションの読み込み

**テスト項目**: 存在しないセッションの読み込みが `None` を返すこと

**前提条件**: データベースが初期化されている

**テスト手順**:

1. `load_session("nonexistent:123")` を実行
2. `None` が返されることを確認

**期待結果**: `None` が返される

**実装状況**: ✅ 実装済み（`tests/unit/test_db.py::test_load_nonexistent_session`）

---

#### TEST-007: セッションの削除

**テスト項目**: セッションを削除できること

**前提条件**: セッションがデータベースに保存されている

**テスト手順**:

1. セッションを作成して保存
2. 削除前に存在することを確認
3. `delete_session("test:delete")` を実行
4. 削除後に存在しないことを確認

**期待結果**: セッションが削除される

**実装状況**: ✅ 実装済み（`tests/unit/test_db.py::test_delete_session`）

---

### 1.3 メッセージルーティングテスト

#### TEST-008: Bot 自身のメッセージの無視

**テスト項目**: Bot 自身のメッセージは無視されること

**前提条件**: メッセージルーターが初期化されている

**テスト手順**:

1. Bot 自身のメッセージを作成（`author.bot = True`）
2. `route(message)` を実行
3. `"none"` が返されることを確認

**期待結果**: Bot 自身のメッセージは無視される

**実装状況**: ✅ 実装済み（`tests/unit/test_message_router.py::test_route_bot_message_ignored`）

---

#### TEST-009: メンション時のルーティング

**テスト項目**: メンション時に適切なルーティング結果が返されること

**前提条件**: メッセージルーターが初期化されている

**テスト手順**:

1. Bot にメンションされたメッセージを作成
2. `route(message)` を実行
3. 適切なルーティング結果が返されることを確認

**期待結果**: メンション時に適切なルーティング結果が返される

**実装状況**: ✅ 実装済み（`tests/unit/test_message_router.py::test_route_mention_default_thread`）

---

#### TEST-010: スレッド内メッセージのルーティング

**テスト項目**: スレッド内のメッセージは適切にルーティングされること

**前提条件**: メッセージルーターが初期化されている

**テスト手順**:

1. スレッド内のメッセージを作成
2. `route(message)` を実行
3. スレッド型のルーティング結果が返されることを確認

**期待結果**: スレッド内メッセージは適切にルーティングされる

**実装状況**: ✅ 実装済み（`tests/unit/test_message_router.py` に複数のテストケース）

---

### 1.4 エラーハンドリングテスト

#### TEST-011: Discord API エラーの分類

**テスト項目**: Discord API エラーが適切に分類されること

**前提条件**: エラーハンドリングモジュールが初期化されている

**テスト手順**:

1. 各種 Discord API エラー（`Forbidden`, `HTTPException` など）を発生
2. エラーが適切に分類されることを確認
3. 適切なエラーメッセージが生成されることを確認

**期待結果**: Discord API エラーが適切に分類され、エラーメッセージが生成される

**実装状況**: ✅ 実装済み（`tests/unit/test_errors.py` に複数のテストケース）

---

#### TEST-012: データベースエラーの分類

**テスト項目**: データベースエラーが適切に分類されること

**前提条件**: エラーハンドリングモジュールが初期化されている

**テスト手順**:

1. 各種データベースエラー（`OperationalError`, `IntegrityError` など）を発生
2. エラーが適切に分類されることを確認
3. 適切なエラーメッセージが生成されることを確認

**期待結果**: データベースエラーが適切に分類され、エラーメッセージが生成される

**実装状況**: ✅ 実装済み（`tests/unit/test_errors.py` に複数のテストケース）

---

### 1.5 レート制限テスト

#### TEST-013: レート制限モニター

**テスト項目**: レート制限モニターが正常に動作すること

**前提条件**: レート制限モニターが初期化されている

**テスト手順**:

1. リクエストを記録
2. 使用率を計算
3. 警告閾値を超えた場合に警告が発行されることを確認

**期待結果**: レート制限モニターが正常に動作する

**実装状況**: ✅ 実装済み（`tests/unit/test_rate_limit.py` に複数のテストケース）

---

#### TEST-014: リクエストキュー

**テスト項目**: リクエストキューが優先度順に処理すること

**前提条件**: リクエストキューが初期化されている

**テスト手順**:

1. 異なる優先度のリクエストをキューに追加
2. 優先度の高い順に処理されることを確認

**期待結果**: リクエストキューが優先度順に処理される

**実装状況**: ✅ 実装済み（`tests/unit/test_rate_limit.py` に複数のテストケース）

---

### 1.6 スラッシュコマンドテスト

#### TEST-015: `/chat reset` コマンド

**テスト項目**: `/chat reset` コマンドが正常に動作すること

**前提条件**: Bot が初期化されている

**テスト手順**:

1. セッションを作成
2. `/chat reset` コマンドを実行
3. セッションがリセットされることを確認

**期待結果**: セッションがリセットされる

**実装状況**: ✅ 実装済み（`tests/unit/test_commands.py` に複数のテストケース）

---

#### TEST-016: `/chat status` コマンド

**テスト項目**: `/chat status` コマンドが正常に動作すること

**前提条件**: Bot が初期化されている

**テスト手順**:

1. セッションを作成
2. `/chat status` コマンドを実行
3. セッションの状態が表示されることを確認

**期待結果**: セッションの状態が表示される

**実装状況**: ✅ 実装済み（`tests/unit/test_commands.py` に複数のテストケース）

---

## 2. 統合テスト仕様

### 2.1 ハンドラーとリクエストキューの統合テスト

#### TEST-017: メンション応答でリクエストキューが使用される

**テスト項目**: メンション応答でリクエストキューが使用されること

**前提条件**: MessageHandler と RequestQueue が初期化されている

**テスト手順**:

1. リクエストキューを開始
2. メンションされたメッセージを処理
3. リクエストキューが使用されたことを確認

**期待結果**: メンション応答でリクエストキューが使用される

**実装状況**: ✅ 実装済み（`tests/unit/test_handlers_queue_integration.py::test_mention_uses_request_queue`）

---

#### TEST-018: スレッド応答でリクエストキューが正しい優先度で使用される

**テスト項目**: スレッド応答でリクエストキューが正しい優先度で使用されること

**前提条件**: MessageHandler と RequestQueue が初期化されている

**テスト手順**:

1. リクエストキューを開始
2. スレッド内のメッセージを処理
3. リクエストキューが正しい優先度で使用されたことを確認

**期待結果**: スレッド応答でリクエストキューが正しい優先度で使用される

**実装状況**: ✅ 実装済み（`tests/unit/test_handlers_queue_integration.py::test_thread_uses_request_queue_with_correct_priority`）

---

#### TEST-019: 聞き耳型応答でリクエストキューが最高優先度で使用される

**テスト項目**: 聞き耳型応答でリクエストキューが最高優先度で使用されること

**前提条件**: MessageHandler と RequestQueue が初期化されている

**テスト手順**:

1. リクエストキューを開始
2. 聞き耳型が有効なチャンネルでメッセージを処理
3. リクエストキューが最高優先度で使用されたことを確認

**期待結果**: 聞き耳型応答でリクエストキューが最高優先度で使用される

**実装状況**: ✅ 実装済み（`tests/unit/test_handlers_queue_integration.py::test_eavesdrop_uses_request_queue_with_highest_priority`）

---

#### TEST-020: リクエストキューが優先度順に処理される

**テスト項目**: リクエストキューが優先度順に処理されること

**前提条件**: MessageHandler と RequestQueue が初期化されている

**テスト手順**:

1. 異なる優先度のリクエストをキューに追加
2. 優先度の高い順に処理されることを確認

**期待結果**: リクエストキューが優先度順に処理される（EAVESDROP > MENTION > THREAD）

**実装状況**: ✅ 実装済み（`tests/unit/test_handlers_queue_integration.py::test_request_queue_priority_order_in_handlers`）

---

### 2.2 エラーハンドリング統合テスト

#### TEST-021: メンション応答で Discord 権限エラーが適切に処理される

**テスト項目**: メンション応答で Discord 権限エラーが適切に処理されること

**前提条件**: MessageHandler が初期化されている

**テスト手順**:

1. Discord 権限エラー（`Forbidden`）を発生させる
2. エラーメッセージが送信されることを確認
3. エラーメッセージに「権限」または「サーバー管理者」が含まれることを確認

**期待結果**: Discord 権限エラーが適切に処理され、エラーメッセージが送信される

**実装状況**: ✅ 実装済み（`tests/unit/test_handlers_error_integration.py::test_mention_handles_discord_permission_error`）

---

#### TEST-022: メンション応答でデータベースエラーが適切に処理される

**テスト項目**: メンション応答でデータベースエラーが適切に処理されること

**前提条件**: MessageHandler が初期化されている

**テスト手順**:

1. データベースエラー（`OperationalError`）を発生させる
2. エラーメッセージが送信されることを確認
3. エラーメッセージに「データベース」が含まれることを確認

**期待結果**: データベースエラーが適切に処理され、エラーメッセージが送信される

**実装状況**: ✅ 実装済み（`tests/unit/test_handlers_error_integration.py::test_mention_handles_database_error`）

---

#### TEST-023: スレッド応答で Discord エラーが適切に処理される

**テスト項目**: スレッド応答で Discord エラーが適切に処理されること

**前提条件**: MessageHandler が初期化されている

**テスト手順**:

1. Discord エラー（`HTTPException`、ステータス 429）を発生させる
2. エラーメッセージが送信されることを確認
3. エラーメッセージに「リクエストが多すぎる」または「すみません」が含まれることを確認

**期待結果**: Discord エラーが適切に処理され、エラーメッセージが送信される

**実装状況**: ✅ 実装済み（`tests/unit/test_handlers_error_integration.py::test_thread_handles_discord_error`）

---

#### TEST-024: 聞き耳型応答でエラーが発生してもエラーメッセージを送信しない

**テスト項目**: 聞き耳型応答でエラーが発生してもエラーメッセージを送信しないこと

**前提条件**: MessageHandler が初期化されている

**テスト手順**:

1. 聞き耳型処理中にエラーを発生させる
2. エラーメッセージが送信されていないことを確認

**期待結果**: 聞き耳型応答でエラーが発生してもエラーメッセージを送信しない

**実装状況**: ✅ 実装済み（`tests/unit/test_handlers_error_integration.py::test_eavesdrop_does_not_send_error_message`）

---

#### TEST-025: メンション応答で一般的なエラーが適切に処理される

**テスト項目**: メンション応答で一般的なエラーが適切に処理されること

**前提条件**: MessageHandler が初期化されている

**テスト手順**:

1. 一般的なエラー（`ValueError` など）を発生させる
2. エラーメッセージが送信されることを確認
3. エラーメッセージに「すみません」または「一時的に反応できませんでした」が含まれることを確認

**期待結果**: 一般的なエラーが適切に処理され、エラーメッセージが送信される

**実装状況**: ✅ 実装済み（`tests/unit/test_handlers_error_integration.py::test_mention_handles_generic_error`）

---

## 3. システムテスト仕様

**注意**: システムテストは現在未実装です。Phase 8 で実装予定です。

### 3.1 パフォーマンステスト（未実装）

#### TEST-026: 応答時間テスト

**テスト項目**: 応答時間が 3 秒以内であること

**前提条件**: システムが正常に動作している

**テスト手順**:

1. メッセージを送信
2. 応答が返るまでの時間を測定
3. 3 秒以内であることを確認

**期待結果**: 応答時間が 3 秒以内

**実装状況**: ⏳ 未実装（Phase 8 で実装予定）

---

#### TEST-027: 同時セッションテスト

**テスト項目**: 100 セッションを同時に処理できること

**前提条件**: システムが正常に動作している

**テスト手順**:

1. 100 個のセッションを作成
2. 各セッションにメッセージを送信
3. 全てのセッションが正常に処理されることを確認

**期待結果**: 100 セッションを同時に処理できる

**実装状況**: ⏳ 未実装（Phase 8 で実装予定）

---

### 3.2 エンドツーエンドテスト（未実装）

#### TEST-028: メンション応答型の完全フロー

**テスト項目**: メンションから応答までの完全なフローが動作すること

**前提条件**: Bot が Discord に接続されている

**テスト手順**:

1. テストサーバーで Bot にメンション
2. Bot が応答することを確認
3. セッションが作成されることを確認
4. 会話履歴が保存されることを確認

**期待結果**: メンションから応答まで正常に動作する

**実装状況**: ⏳ 未実装（Phase 8 で実装予定）

---

#### TEST-029: スレッド型の完全フロー

**テスト項目**: スレッド作成から会話継続までの完全なフローが動作すること

**前提条件**: Bot が Discord に接続されている

**テスト手順**:

1. テストサーバーで Bot にメンション
2. Bot がスレッドを作成することを確認
3. スレッド内で会話を継続
4. メンションなしで応答することを確認

**期待結果**: スレッド型の完全なフローが動作する

**実装状況**: ⏳ 未実装（Phase 8 で実装予定）

---

#### TEST-030: セッションの同期

**テスト項目**: メモリと SQLite の同期が正常に動作すること

**前提条件**: セッションがメモリに存在する

**テスト手順**:

1. メモリ内のセッションにメッセージを追加
2. バッチ同期を実行
3. SQLite に保存されていることを確認

**期待結果**: メモリと SQLite が正常に同期される

**実装状況**: ⏳ 未実装（Phase 8 で実装予定）

---

## 4. テストデータ

### 4.1 テスト用セッションデータ

```python
test_session_data = {
    "session_key": "test:123",
    "session_type": "mention",
    "channel_id": 123,
    "user_id": 456,
    "created_at": datetime(2024, 1, 15, 10, 0, 0),
    "last_activity": datetime(2024, 1, 15, 10, 30, 0)
}
```

### 4.2 テスト用メッセージデータ

```python
test_messages = [
    Message(role="user", content="こんにちは", timestamp=datetime.now()),
    Message(role="assistant", content="こんにちは！", timestamp=datetime.now())
]
```

---

## 4. テスト実行手順

### 4.1 単体テストの実行

```bash
# すべての単体テストを実行
pytest tests/unit/ -v

# カバレッジ付きで実行
pytest tests/unit/ --cov=src/kotonoha_bot --cov-report=html

# 特定のテストファイルを実行
pytest tests/unit/test_session.py -v

# 特定のテスト関数を実行
pytest tests/unit/test_session.py::test_create_session -v
```

### 4.2 統合テストの実行

```bash
# 統合テストを実行（現在は unit ディレクトリ内）
pytest tests/unit/test_handlers_queue_integration.py -v
pytest tests/unit/test_handlers_error_integration.py -v
```

### 4.3 すべてのテストの実行

```bash
# すべてのテストを実行
pytest tests/ -v

# カバレッジ付きで実行
pytest tests/ --cov=src/kotonoha_bot --cov-report=html --cov-report=xml
```

### 4.4 CI/CD でのテスト実行

**GitHub Actions**: プッシュまたはプルリクエスト時に自動実行

- テスト実行（pytest）
- カバレッジレポートのアップロード（Codecov）

**実装場所**: `.github/workflows/ci.yml`

---

**作成日**: 2026 年 1 月 14 日  
**最終更新日**: 2026 年 1 月 15 日  
**バージョン**: 2.0  
**作成者**: kotonoha-bot 開発チーム

## 更新履歴

- **v2.0** (2026-01-15): 実際の実装に基づいて改訂
  - 実装済みテスト項目を実際のテストコードに基づいて更新
  - 各テスト項目に実装状況を追加
  - 統合テストの内容を実際の実装に合わせて更新
  - システムテストを未実装として明記
  - テスト実行手順を更新
  - テスト項目の番号を再整理（TEST-001 から TEST-030）
- **v1.0** (2026-01-14): 初版リリース
