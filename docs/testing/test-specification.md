# テスト仕様書

## 1. 単体テスト仕様

### 1.1 セッション管理テスト

#### TEST-001: セッションの作成

**テスト項目**: 新しいセッションを作成できること

**前提条件**: セッション管理モジュールが初期化されている

**テスト手順**:

1. `create_session("test:123", "mention", channel_id=123)` を実行
2. `get_session("test:123")` でセッションを取得
3. セッションが正しく作成されていることを確認

**期待結果**: セッションが作成され、正しい情報が設定されている

**テストデータ**:

```python
session_key = "test:123"
session_type = "mention"
channel_id = 123
```

---

#### TEST-002: セッションの取得（メモリから）

**テスト項目**: メモリ内のセッションを取得できること

**前提条件**: セッションがメモリに存在する

**テスト手順**:

1. セッションを作成
2. `get_session(session_key)` を実行
3. セッションが取得できることを確認

**期待結果**: セッションが正しく取得できる

---

#### TEST-003: セッションの取得（SQLite から復元）

**テスト項目**: SQLite からセッションを復元できること

**前提条件**: セッションが SQLite に保存されている

**テスト手順**:

1. セッションを作成して SQLite に保存
2. メモリからセッションを削除
3. `get_session(session_key)` を実行
4. セッションが SQLite から復元されることを確認

**期待結果**: セッションが SQLite から復元され、メモリに読み込まれる

---

### 1.2 AI サービステスト

#### TEST-004: 応答生成（正常系）

**テスト項目**: AI で応答を生成できること

**前提条件**: Gemini API が利用可能

**テスト手順**:

1. 会話履歴を準備
2. `generate_response(messages, system_prompt)` を実行
3. 応答が生成されることを確認

**期待結果**: 適切な応答が生成される

**テストデータ**:

```python
messages = [
    Message(role="user", content="こんにちは", timestamp=datetime.now())
]
system_prompt = "あなたはKotonohaです。"
```

---

#### TEST-005: 応答生成（エラー系）

**テスト項目**: API エラー時に適切に処理できること

**前提条件**: API がエラーを返す

**テスト手順**:

1. モック API でエラーを返すように設定
2. `generate_response()` を実行
3. 適切な例外が発生することを確認

**期待結果**: `APIError` が発生する

---

### 1.3 データベーステスト

#### TEST-006: セッションの保存

**テスト項目**: セッションを SQLite に保存できること

**前提条件**: データベースが初期化されている

**テスト手順**:

1. セッションデータを準備
2. `save_session(session_data)` を実行
3. データベースに保存されていることを確認

**期待結果**: セッションがデータベースに保存される

---

#### TEST-007: メッセージの取得

**テスト項目**: メッセージ履歴を取得できること

**前提条件**: メッセージがデータベースに保存されている

**テスト手順**:

1. メッセージを追加
2. `get_messages(session_key, limit=10)` を実行
3. メッセージが取得できることを確認

**期待結果**: 指定された件数のメッセージが取得できる

---

## 2. 統合テスト仕様

### 2.1 メッセージ処理フローテスト

#### TEST-008: メンション応答型の完全フロー

**テスト項目**: メンションから応答までの完全なフローが動作すること

**前提条件**: Bot が Discord に接続されている

**テスト手順**:

1. テストサーバーで Bot にメンション
2. Bot が応答することを確認
3. セッションが作成されることを確認
4. 会話履歴が保存されることを確認

**期待結果**: メンションから応答まで正常に動作する

---

#### TEST-009: スレッド型の完全フロー

**テスト項目**: スレッド作成から会話継続までの完全なフローが動作すること

**前提条件**: Bot が Discord に接続されている

**テスト手順**:

1. テストサーバーで Bot にメンション
2. Bot がスレッドを作成することを確認
3. スレッド内で会話を継続
4. メンションなしで応答することを確認

**期待結果**: スレッド型の完全なフローが動作する

---

### 2.2 セッション管理統合テスト

#### TEST-010: セッションの同期

**テスト項目**: メモリと SQLite の同期が正常に動作すること

**前提条件**: セッションがメモリに存在する

**テスト手順**:

1. メモリ内のセッションにメッセージを追加
2. バッチ同期を実行
3. SQLite に保存されていることを確認

**期待結果**: メモリと SQLite が正常に同期される

---

## 3. システムテスト仕様

### 3.1 パフォーマンステスト

#### TEST-011: 応答時間テスト

**テスト項目**: 応答時間が 3 秒以内であること

**前提条件**: システムが正常に動作している

**テスト手順**:

1. メッセージを送信
2. 応答が返るまでの時間を測定
3. 3 秒以内であることを確認

**期待結果**: 応答時間が 3 秒以内

---

#### TEST-012: 同時セッションテスト

**テスト項目**: 100 セッションを同時に処理できること

**前提条件**: システムが正常に動作している

**テスト手順**:

1. 100 個のセッションを作成
2. 各セッションにメッセージを送信
3. 全てのセッションが正常に処理されることを確認

**期待結果**: 100 セッションを同時に処理できる

---

### 3.2 エラーハンドリングテスト

#### TEST-013: API エラー時の動作

**テスト項目**: API エラー時に適切に処理できること

**前提条件**: API がエラーを返す

**テスト手順**:

1. API をモックしてエラーを返すように設定
2. メッセージを送信
3. エラーメッセージが送信されることを確認
4. システムが停止しないことを確認

**期待結果**: エラーが適切に処理され、ユーザーに通知される

---

#### TEST-014: レート制限テスト

**テスト項目**: レート制限時に適切に処理できること

**前提条件**: レート制限に達している

**テスト手順**:

1. レート制限に達するまでリクエストを送信
2. 追加のリクエストを送信
3. 待機してリトライすることを確認

**期待結果**: レート制限時に適切に待機してリトライする

---

## 4. テストデータ

### 4.1 テスト用セッションデータ

```python
test_session_data = {
    "session_key": "test:123",
    "session_type": "mention",
    "channel_id": 123,
    "user_id": 456,
    "created_at": datetime(2024, 1, 15, 10, 0, 0),
    "last_activity": datetime(2024, 1, 15, 10, 30, 0)
}
```

### 4.2 テスト用メッセージデータ

```python
test_messages = [
    Message(role="user", content="こんにちは", timestamp=datetime.now()),
    Message(role="assistant", content="こんにちは！", timestamp=datetime.now())
]
```

---

## 5. テスト実行手順

### 5.1 単体テストの実行

```bash
# pytest で単体テストを実行
pytest tests/unit/ -v

# カバレッジ付きで実行
pytest tests/unit/ --cov=kotonoha_bot --cov-report=html
```

### 5.2 統合テストの実行

```bash
# 統合テストを実行
pytest tests/integration/ -v
```

### 5.3 システムテストの実行

```bash
# システムテストを実行
pytest tests/system/ -v
```

---

**作成日**: 2026 年 1 月 14 日
**バージョン**: 1.0
**作成者**: kotonoha-bot 開発チーム
