# テスト計画書

## 1. テスト概要

### 1.1 テストの目的

Kotonoha（コトノハ）Discord ボットの品質を保証し、場面緘黙支援に適した動作を確認する。

### 1.2 テスト範囲

- 機能テスト（3 つの会話の契機：メンション、スレッド、聞き耳型）
- セッション管理テスト
- メッセージルーティングテスト
- スラッシュコマンドテスト
- エラーハンドリングテスト
- レート制限テスト
- メッセージ分割テスト
- データベース操作テスト
- 統合テスト（ハンドラーとキューの統合、エラーハンドリング統合）

### 1.3 テスト環境

| 環境           | 説明                               |
| -------------- | ---------------------------------- |
| **開発環境**   | WSL2 Ubuntu、ローカルテスト        |
| **テスト環境** | Discord テストサーバー、モック API |
| **本番環境**   | Synology NAS、実際の API           |

---

## 2. テスト戦略

### 2.1 テストレベル

| レベル             | 説明                     | 実施時期       | 実装状況    |
| ------------------ | ------------------------ | -------------- | ----------- |
| **単体テスト**     | 各モジュールのテスト     | 開発中         | ✅ 実装済み |
| **統合テスト**     | モジュール間の連携テスト | Phase 6 完了後 | ⚠️ 部分的   |
| **システムテスト** | システム全体のテスト     | Phase 7 完了後 | ⏳ 未実装   |
| **受入テスト**     | ユーザーによるテスト     | リリース前     | ⏳ 未実装   |

**実装状況の詳細**:

- **単体テスト**: 17 ファイル、146 テストケース（実装済み）
- **統合テスト**: 2 ファイル（ハンドラーとキューの統合、エラーハンドリング統合）
- **システムテスト**: 未実装
- **受入テスト**: 未実装

### 2.2 テスト手法

- **ホワイトボックステスト**: コードの内部構造を理解した上でのテスト
- **ブラックボックステスト**: 機能仕様に基づいたテスト
- **回帰テスト**: 既存機能への影響を確認

---

## 3. テスト項目

### 3.1 機能テスト

| ID     | テスト項目             | 優先度 | 実装フェーズ | 実装状況    |
| ------ | ---------------------- | ------ | ------------ | ----------- |
| FT-001 | メッセージルーティング | 高     | Phase 5      | ✅ 実装済み |
| FT-002 | スレッド型の動作       | 高     | Phase 5      | ✅ 実装済み |
| FT-003 | 聞き耳型の動作         | 高     | Phase 5      | ✅ 実装済み |
| FT-004 | 会話履歴の保持         | 高     | Phase 1      | ✅ 実装済み |
| FT-005 | 会話履歴のリセット     | 中     | Phase 6      | ✅ 実装済み |
| FT-006 | セッションの復元       | 中     | Phase 1      | ✅ 実装済み |
| FT-007 | スラッシュコマンド     | 高     | Phase 6      | ✅ 実装済み |
| FT-008 | メッセージ分割         | 中     | Phase 4      | ✅ 実装済み |
| FT-009 | メッセージフォーマット | 中     | Phase 6      | ✅ 実装済み |
| FT-010 | 会話バッファ           | 中     | Phase 5      | ✅ 実装済み |

### 3.2 エラーハンドリングテスト

| ID     | テスト項目               | 優先度 | 実装状況    |
| ------ | ------------------------ | ------ | ----------- |
| ET-001 | Discord API エラーの分類 | 高     | ✅ 実装済み |
| ET-002 | データベースエラーの分類 | 高     | ✅ 実装済み |
| ET-003 | エラーメッセージの生成   | 高     | ✅ 実装済み |
| ET-004 | ハンドラーエラー統合     | 中     | ✅ 実装済み |
| ET-005 | API エラー時の処理       | 高     | ⏳ 未実装   |
| ET-006 | レート制限時の処理       | 高     | ⏳ 未実装   |
| ET-007 | タイムアウト時の処理     | 中     | ⏳ 未実装   |

### 3.3 レート制限テスト

| ID     | テスト項目           | 優先度 | 実装状況    |
| ------ | -------------------- | ------ | ----------- |
| RT-001 | レート制限モニター   | 高     | ✅ 実装済み |
| RT-002 | トークンバケット     | 高     | ✅ 実装済み |
| RT-003 | リクエストキュー     | 高     | ✅ 実装済み |
| RT-004 | レート制限警告       | 中     | ✅ 実装済み |
| RT-005 | ハンドラーキュー統合 | 中     | ✅ 実装済み |

### 3.4 データベーステスト

| ID     | テスト項目           | 優先度 | 実装状況    |
| ------ | -------------------- | ------ | ----------- |
| DT-001 | セッション保存       | 高     | ✅ 実装済み |
| DT-002 | セッション読み込み   | 高     | ✅ 実装済み |
| DT-003 | セッション削除       | 中     | ✅ 実装済み |
| DT-004 | 全セッション読み込み | 中     | ✅ 実装済み |

### 3.5 パフォーマンステスト

| ID     | テスト項目           | 目標値         | 実装状況  |
| ------ | -------------------- | -------------- | --------- |
| PT-001 | 応答時間             | 3 秒以内       | ⏳ 未実装 |
| PT-002 | セッション取得時間   | 100ms 以内     | ⏳ 未実装 |
| PT-003 | データベース操作時間 | 50ms 以内      | ⏳ 未実装 |
| PT-004 | 同時セッション数     | 100 セッション | ⏳ 未実装 |

---

## 4. テスト環境構築

### 4.1 テスト用 Discord サーバー

- 専用のテストサーバーを作成
- テスト用 Bot を追加
- テスト用チャンネルを作成

### 4.2 テストツール

- **pytest**: テストフレームワーク
- **pytest-asyncio**: 非同期テスト対応
- **pytest-cov**: カバレッジ測定
- **unittest.mock**: モック機能
- **discord.py のモック**: Discord API のモック化

**実装状況**: ✅ 実装済み（`pyproject.toml` で設定）

### 4.3 テストデータ

- **一時データベース**: `conftest.py` で自動生成・削除
- **モック Bot**: `unittest.mock` を使用
- **モック MessageHandler**: テスト用にモック化
- **テスト用セッションデータ**: `conftest.py` のフィクスチャで提供

**実装場所**: `tests/conftest.py`

---

## 5. テストスケジュール

| フェーズ           | 期間           | テスト内容           | 実装状況    |
| ------------------ | -------------- | -------------------- | ----------- |
| **Phase 1 テスト** | Phase 1 完了後 | 基本機能のテスト     | ✅ 実装済み |
| **Phase 4 テスト** | Phase 4 完了後 | メッセージ分割テスト | ✅ 実装済み |
| **Phase 5 テスト** | Phase 5 完了後 | 全機能のテスト       | ✅ 実装済み |
| **Phase 6 テスト** | Phase 6 完了後 | レート制限・コマンド | ✅ 実装済み |
| **Phase 7 テスト** | Phase 7 完了後 | aiosqlite 移行テスト | ⏳ 未実装   |
| **Phase 8 テスト** | Phase 8 完了後 | システム全体のテスト | ⏳ 未実装   |
| **受入テスト**     | リリース前     | ユーザーによるテスト | ⏳ 未実装   |

**CI/CD での自動実行**: ✅ 実装済み（GitHub Actions）

---

## 6. テスト実行方法

### 6.1 ローカルでのテスト実行

```bash
# すべてのテストを実行
pytest tests/ -v

# 単体テストのみ実行
pytest tests/unit/ -v

# カバレッジ付きで実行
pytest tests/ --cov=src/kotonoha_bot --cov-report=html

# 特定のテストファイルを実行
pytest tests/unit/test_session.py -v

# 特定のテスト関数を実行
pytest tests/unit/test_session.py::test_create_session -v
```

### 6.2 CI/CD でのテスト実行

**GitHub Actions**: プッシュまたはプルリクエスト時に自動実行

- Lint チェック（Ruff）
- フォーマットチェック（Ruff）
- 型チェック（ty）
- テスト実行（pytest）
- カバレッジレポートのアップロード（Codecov）

**実装場所**: `.github/workflows/ci.yml`

### 6.3 テストカバレッジ

**目標**: 80% 以上（Phase 8 で実装予定）

**現在のカバレッジ**: Codecov で追跡中

**カバレッジレポートの確認**:

```bash
# HTML レポートを生成
pytest tests/ --cov=src/kotonoha_bot --cov-report=html

# ブラウザで開く
open htmlcov/index.html
```

## 7. テスト結果管理

### 7.1 テスト結果の記録

- **CI/CD**: GitHub Actions で自動記録
- **カバレッジ**: Codecov で自動追跡
- **テストレポート**: pytest の出力を確認

### 7.2 バグ管理

- **Issue 管理**: GitHub Issues で管理
- **優先度設定**: P0（緊急）、P1（高）、P2（中）、P3（低）
- **修正状況の追跡**: Issue のステータスで管理
- **再テスト**: 修正後に CI/CD で自動再テスト

## 8. 実装済みテストファイル一覧

### 8.1 単体テスト

| ファイル名                                | テスト内容                 | テスト数 |
| ----------------------------------------- | -------------------------- | -------- |
| `test_basic.py`                           | 基本動作テスト             | 4        |
| `unit/test_session.py`                    | セッション管理             | 4        |
| `unit/test_db.py`                         | データベース操作           | 3        |
| `unit/test_message_router.py`             | メッセージルーティング     | 9        |
| `unit/test_thread_handler.py`             | スレッド型ハンドラー       | 10       |
| `unit/test_llm_judge.py`                  | 聞き耳型判定               | 24       |
| `unit/test_conversation_buffer.py`        | 会話バッファ               | 6        |
| `unit/test_message_splitter.py`           | メッセージ分割             | 8        |
| `unit/test_message_formatter.py`          | メッセージフォーマット     | 5        |
| `unit/test_commands.py`                   | スラッシュコマンド         | 4        |
| `unit/test_errors.py`                     | エラーハンドリング         | 22       |
| `unit/test_rate_limit.py`                 | レート制限                 | 21       |
| `unit/test_rate_limit_monitor_warning.py` | レート制限警告             | 5        |
| `unit/test_handlers_embed.py`             | ハンドラー Embed           | 6        |
| `unit/test_main_shutdown.py`              | メイン関数のシャットダウン | 6        |

### 8.2 統合テスト

| ファイル名                                | テスト内容               | テスト数 |
| ----------------------------------------- | ------------------------ | -------- |
| `unit/test_handlers_queue_integration.py` | ハンドラーとキューの統合 | 4        |
| `unit/test_handlers_error_integration.py` | ハンドラーエラー統合     | 5        |

**合計**: 17 ファイル、146 テストケース

---

**作成日**: 2026 年 1 月 14 日  
**最終更新日**: 2026 年 1 月 15 日  
**バージョン**: 2.0  
**作成者**: kotonoha-bot 開発チーム

## 更新履歴

- **v2.0** (2026-01-15): 実際の実装に基づいて改訂
  - 実装済みテストファイル一覧を追加
  - テスト実行方法を追加
  - CI/CD での自動実行を記載
  - テストカバレッジの目標と現状を記載
  - 実装状況を各テスト項目に追加
- **v1.0** (2026-01-14): 初版リリース
