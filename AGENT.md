# AGENT ルール

このドキュメントは、AI エージェントがこのプロジェクトで作業する際に従うべき大前提のルールを定義します。

## コード品質ルール

### ruff と ty への準拠

**すべてのコードは、ruff と ty のルールに準拠すること。**

1. **ruff（リンター・フォーマッター）**

   - コードフォーマット: `uv run ruff format .`
   - リンター: `uv run ruff check .`
   - すべてのコードは、ruff の設定（`pyproject.toml` の `[tool.ruff]` セクション）に準拠すること
   - フォーマットとリンターエラーがない状態でコミットすること

2. **ty（型チェッカー）**

   - 型チェック: `uv run ty src/`
   - すべてのコードは、ty による型チェックをパスすること
   - 型アノテーションを適切に記述し、型エラーがない状態でコミットすること

3. **実装前の確認**

   - コードを変更した後は、必ず以下を実行して確認すること：

     ```bash
     uv run ruff format .
     uv run ruff check .
     uv run ty src/
     ```

   - すべてのチェックが成功してからコミットすること

4. **エラー対応時の注意**

   - ruff や ty のエラーが発生した場合も、対症療法ではなく根本的な解決を目指すこと
   - エラーを無視する設定を追加するのではなく、コードを修正してルールに準拠させること

5. **警告やノートの抑制の禁止**
   - **警告（Warning）やノート（Note）を抑制する設定を追加することは絶対に禁止**
   - pytest の `filterwarnings` や `-W ignore` オプションで警告を抑制しないこと
   - リンターや型チェッカーの警告を無視する設定を追加しないこと
   - 警告は問題の兆候であり、抑制するのではなく根本的な解決を目指すこと
   - 外部ライブラリからの警告であっても、抑制するのではなく、ライブラリの更新や代替手段を検討すること

### コメントの記述ルール

**すべてのコメントは日本語で記述すること。**

1. **コメントの言語**

   - コード内のコメント（`#` で始まる行コメント、`"""` で囲む docstring など）はすべて日本語で記述すること
   - 英語のコメントは使用しないこと

2. **コメントの目的**

   - コードの意図や理由を明確に説明するためにコメントを記述すること
   - 自明なコードには不要なコメントを書かないこと
   - 複雑なロジックや、なぜその実装を選んだかの理由を説明すること

3. **docstring の記述**

   - 関数やクラスの docstring は日本語で記述すること
   - 引数、戻り値、例外などの説明も日本語で記述すること

4. **実践例**

   ```python
   # ❌ 悪い例（英語のコメント）
   # Process user input and validate
   def process_input(data: str) -> bool:
       """Validate user input."""
       return len(data) > 0

   # ✅ 良い例（日本語のコメント）
   # ユーザー入力を処理して検証する
   def process_input(data: str) -> bool:
       """ユーザー入力を検証する。

       Args:
           data: 検証する文字列

       Returns:
           入力が有効な場合 True、無効な場合 False
       """
       return len(data) > 0
   ```

### ドキュメントの相互リンク管理

**すべてのドキュメントファイルは、更新のたびに互いの相互リンクが正確に保たれているか確認すること。**

1. **リンクの整合性確認**

   - ドキュメントを更新・追加・削除した際は、必ず関連するすべてのドキュメントのリンクを確認すること
   - リンク切れや、存在しないファイルへのリンクがないか確認すること
   - ファイル名やパスが変更された場合は、すべての参照箇所を更新すること

2. **確認すべき項目**

   - Markdown ファイル内の相対パスリンク（`[テキスト](./path/to/file.md)`）
   - README.md や目次ファイルからのリンク
   - ドキュメント間の相互参照
   - セクションへのアンカーリンク（`#section-name`）

3. **更新時の確認手順**

   - ドキュメントを変更した後、以下を確認すること：
     - 変更したファイルから参照している他のドキュメントのリンクが有効か
     - 他のドキュメントから変更したファイルへのリンクが有効か
     - ファイル名やディレクトリ構造を変更した場合、すべての参照を更新したか
   - リンク切れを発見した場合は、即座に修正すること

4. **実践例**

   ```markdown
   # ❌ 悪い例（リンク切れ）

   [実装ロードマップ](./docs/implementation/roadmap.md) # ファイルが移動されたがリンクが更新されていない

   # ✅ 良い例（正確なリンク）

   [実装ロードマップ](./docs/implementation/roadmap.md) # ファイルの実際のパスと一致
   ```

5. **確認方法**
   - 手動でリンクをクリックして確認する
   - 必要に応じて、リンク検証ツールやスクリプトを使用する
   - ドキュメントの構造変更時は、特に注意深く確認する

### ドキュメントの記述スタイル

**ドキュメントは、AI っぽさのある表現を避け、自然で簡潔な表現を使用すること。**

#### 料金表記のドル記号エスケープ

**Markdown ドキュメント内で料金を表記する際は、ドル記号（`$`）を必ずエスケープ（`\$`）すること。**

1. **エスケープの理由**

   - Markdown では `$` は数式記号として解釈される可能性がある
   - エスケープすることで、通常の文字として確実に表示される

2. **適用範囲**

   - 料金表記（例: `\$3/input MTok`）
   - コスト例（例: `\$0.25/input MTok`）
   - その他、ドル記号を含む表記

3. **実践例**

   ```markdown
   # ❌ 悪い例（エスケープなし）

   | モデル | 料金                           |
   | ------ | ------------------------------ |
   | Sonnet | $3/input MTok, $15/output MTok |

   # ✅ 良い例（エスケープあり）

   | モデル | 料金                             |
   | ------ | -------------------------------- |
   | Sonnet | \$3/input MTok, \$15/output MTok |
   ```

4. **確認方法**

   - ドキュメント内で `$` を検索し、料金表記の場合はすべて `\$` にエスケープされているか確認する
   - レンダリング時に正しく表示されるか確認する

5. **避けるべき表現**

   - 過度に丁寧な表現（「〜させていただきます」「〜いたします」など）
   - 不自然な敬語の多用
   - 回りくどい表現（「〜することができます」「〜することが可能です」など）
   - 過度に説明が長い表現
   - 機械的で不自然な言い回し
   - 「〜ですので」「〜となります」などの不自然な接続表現

6. **推奨する表現**

   - 簡潔で直接的な表現
   - 自然な日本語の文体
   - 必要最小限の説明
   - 人間が書いたような自然な文章

7. **実践例**

   ```markdown
   # ❌ 悪い例（AI っぽい表現）

   この機能を使用することで、ユーザーは効率的にデータを処理することが可能となります。
   また、この機能は非常に便利な機能となっており、多くの場面で活用していただくことができます。

   # ✅ 良い例（自然な表現）

   この機能でデータを効率的に処理できる。
   多くの場面で活用できる。
   ```

   ```markdown
   # ❌ 悪い例（過度に丁寧）

   ご利用いただく際は、以下の手順に従っていただく必要がございます。
   まず、設定ファイルを編集させていただきます。

   # ✅ 良い例（自然な表現）

   利用時は以下の手順に従う。
   まず、設定ファイルを編集する。
   ```

8. **確認方法**
   - ドキュメントを書いた後、声に出して読んでみて自然か確認する
   - 不自然な表現や回りくどい表現がないか確認する
   - 必要以上に丁寧すぎる表現がないか確認する

## エラー対応の基本方針

### 大前提

**エラーが発生した際は、手当たり次第に部分最適化して対症療法的に解決するのではなく、根本的な解決を目指し、全体最適化を行うこと。**

### 原則

1. **根本原因の分析を優先**

   - エラーの表面的な症状に飛びつかず、まず根本原因を特定する
   - エラーが発生している箇所だけでなく、関連する全体の設計やアーキテクチャを考慮する
   - なぜそのエラーが発生するのか、システム全体の文脈で理解する

2. **全体最適化の視点**

   - 部分的な修正で一時的に問題を隠すのではなく、システム全体の整合性を保つ解決策を選択する
   - 修正が他の部分に与える影響を考慮し、副作用を最小限に抑える
   - 長期的な保守性と拡張性を重視する

3. **既存ロジックの保護**

   - **既存のロジックは全く変えずに**、根本的な解決を目指すこと
   - 既存の動作を壊さない範囲で、新しいアプローチや設計を導入する
   - 後方互換性を維持しながら、より良い設計へと進化させる

4. **対症療法の回避**
   - エラーメッセージを無理やり回避するような修正は行わない
   - エラーを握りつぶしたり、例外を広くキャッチして無視するような実装は避ける
   - 一時的な回避策ではなく、根本的な解決策を実装する
   - **警告やノートを抑制する設定を追加することは絶対に禁止**

### 実践例

#### ❌ 悪い例（対症療法）

```python
# エラーが起きたら無視する
try:
    result = some_function()
except Exception:
    result = None  # エラーを無視して続行
```

```toml
# ❌ 悪い例（警告を抑制する設定）
[tool.pytest.ini_options]
filterwarnings = [
    "ignore::DeprecationWarning",  # 警告を抑制して問題を隠す
]
addopts = "-W ignore::DeprecationWarning"  # 警告を無視する
```

#### ✅ 良い例（根本的解決）

```python
# エラーの根本原因を理解し、適切な処理を実装
# 既存のロジックは変更せず、新しい設計を導入
if not is_valid_input(data):
    raise ValueError("Invalid input: expected format X, got Y")
result = some_function(data)
```

### チェックリスト

エラー対応時に以下を確認すること：

- [ ] エラーの根本原因を特定したか？
- [ ] システム全体の文脈で問題を理解したか？
- [ ] 既存のロジックを変更せずに解決できるか？
- [ ] 対症療法ではなく、根本的な解決策を実装しているか？
- [ ] 他の部分への副作用を考慮したか？
- [ ] 長期的な保守性を考慮したか？
- [ ] ruff のフォーマットとリンターが通るか？（`uv run ruff format .` と `uv run ruff check .`）
- [ ] ty の型チェックが通るか？（`uv run ty src/`）
- [ ] すべてのコメントが日本語で記述されているか？
- [ ] ドキュメントを更新した場合、すべての相互リンクが正確に保たれているか？
- [ ] ドキュメントに AI っぽさのある表現がないか？（過度に丁寧、回りくどい表現など）
- [ ] 警告やノートを抑制する設定を追加していないか？（絶対に禁止）

---

**重要**: このルールは、コードの品質とシステムの健全性を維持するための大前提です。すべての作業において、この原則に従ってください。
